<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SUIVI PERFORMANCE</title>

<!-- Bulma -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">

<style>
:root{
  --bg: #f6f7fb;
  --card: #ffffff;
  --text: #111827;
  --muted: #6b7280;
  --shadow: 0 10px 28px rgba(0,0,0,.08);
  --shadow2: 0 6px 18px rgba(0,0,0,.10);
  --radius: 14px;

  --field-bg: #ffffff;
  --field-text: #111827;
  --field-border: rgba(17,24,39,.18);
  --field-placeholder: rgba(107,114,128,.95);

  --fixed-header-h: 140px;
}

body{ background: var(--bg); color: var(--text); margin: 0; }
html.dark, body.dark{
  --bg: #0f1115;
  --card: #151922;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --shadow: 0 10px 28px rgba(0,0,0,.45);
  --shadow2: 0 6px 18px rgba(0,0,0,.50);

  --field-bg: #0f172a;
  --field-text: #e5e7eb;
  --field-border: rgba(229,231,235,.16);
  --field-placeholder: rgba(156,163,175,.95);
}

/* ===== FIXED HEADER ===== */
.fixed-header{
  position: fixed;
  inset: 0 0 auto 0;
  z-index: 3000;
  background: var(--bg);
  backdrop-filter: none;
  border-bottom: 1px solid rgba(0,0,0,.08);
}

/* sombre */
html.dark .fixed-header{
  border-bottom-color: rgba(255,255,255,.08);
}
.fixed-header-inner{
  max-width: 1120px;
  margin: 0 auto;
  padding: 10px 14px 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.app-wrap{
  max-width: 1120px;
  margin: 0 auto;
  padding: calc(var(--fixed-header-h) + 14px) 14px 14px;
}

/* Topbar */
.topbar-inner{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content: space-between;
  flex-wrap: wrap;
}

/* Titre centré */
.brandline{
  flex: 1 1 100%;
  display:flex;
  align-items:center;
  justify-content: center;
}
.brand-title{ text-align:center; line-height: 1.05; }
.brand-title strong{ display:block; font-size: 1.2rem; color: var(--text); }

/* Tabs row */
.tabs-row{ display:flex; justify-content:center; }
.tabs-chip{
  width: 100%;
  max-width: 1120px;
  border-radius: 999px;
  padding: 10px 14px;
  background: var(--card);
  box-shadow: var(--shadow2);
  display:flex;
  align-items:center;
  gap:8px;

  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  white-space: nowrap;
  scrollbar-width: thin;
}
.tabs-chip .button{
  border-radius: 999px;
  flex: 0 0 auto;
  font-weight: 900;
}

/* Timers chips */
.timer-row{
  display:flex;
  gap:10px;
  flex-wrap: wrap;
  justify-content: center;
}
.timer-chip{
  min-width: 140px;
  border-radius: 999px;
  padding: 10px 14px;
  background: var(--card);
  box-shadow: var(--shadow2);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap:10px;
  color: var(--text);
}
.timer-chip .k{ font-weight: 900; color: var(--text); }
.timer-chip .v{
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background:#ef4444;
  color:#fff;
  min-width: 70px;
  text-align:center;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

/* CTOT éditable */
.ctot-pill{
  width: auto;
  min-width: 70px;
  border: 0 !important;
  outline: 0 !important;
  box-shadow: none !important;
  background:#334155 !important;
  color:#fff !important;
  font-weight: 900 !important;
  border-radius: 999px !important;
  padding: 6px 10px !important;
  text-align:center;
  height: auto;
  line-height: 1.2;
  font-size: 1rem;
  appearance: none;
  -webkit-appearance: none;
}
.ctot-pill::-webkit-datetime-edit{ color:#fff; }
.ctot-pill::-webkit-calendar-picker-indicator{ display:none; -webkit-appearance:none; }

#timer-tobt{ background:#16a34a !important; }
#timer-h8{ background:#facc15 !important; color:#fff !important; } /* LID blanc */
#timer-cd{ background:#93c5fd !important; color:#111 !important; }

/* CD en dépassement (après 0) */
#timer-cd.cd-over{
  background: #fee2e2 !important;
  color: #ef4444 !important;
}

/* Bulma tweaks */
.card{
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  background: var(--card);
  color: var(--text);
}
.card-header{
  border-top-left-radius: var(--radius);
  border-top-right-radius: var(--radius);
  background: color-mix(in srgb, var(--card) 85%, #3b82f6 15%);
}
body.dark .card-header{
  background: color-mix(in srgb, var(--card) 80%, #60a5fa 20%);
}
.card-header-title{ font-weight: 900; color: var(--text) !important; }
.section-collapse{ cursor: pointer; user-select: none; }
.collapsed-body{ display: none; }

/* Inputs */
.input, .select select, .textarea{
  border-radius: 12px;
  background: var(--field-bg) !important;
  color: var(--field-text) !important;
  border-color: var(--field-border) !important;
}
.input.uppercase{ text-transform: uppercase; }

textarea.si-uppercase{
  text-transform: uppercase;
}

.input::placeholder, .textarea::placeholder{ color: var(--field-placeholder) !important; }
.field .label{ font-weight: 900; color: var(--text) !important; }

/* FORCE couleur TOB (sinon Bulma + !important bloque) */
#FinalTOB.is-invalid{ color:#ef4444 !important; }
#FinalTOB.is-valid{ color: var(--field-text) !important; }

/* Buttons */
.btn-actions{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-top: 8px;
}
.btn-actions .button{ border-radius: 12px; font-weight: 900; }

/* Popup toast */
#popup{
  position: fixed;
  top: calc(var(--fixed-header-h) + 12px);
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 16px;
  border-radius: 12px;
  color:#fff;
  z-index: 4000;
  box-shadow: var(--shadow);
}

/* ===== Toggle switch ===== */
.toggle{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding: 8px 12px;
  border-radius: 999px;
  background: var(--card);
  box-shadow: var(--shadow2);
  cursor:pointer;
  user-select:none;
  font-weight: 900;
  color: var(--text);
}
.toggle input{ position:absolute; opacity:0; pointer-events:none; }
.toggle .track{
  width: 44px; height: 26px; border-radius: 999px;
  background: rgba(148,163,184,.55);
  position: relative; flex: 0 0 auto;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
.toggle .thumb{
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position:absolute; top: 2px; left: 2px;
  transition: transform .18s ease, background .18s ease;
  box-shadow: 0 6px 16px rgba(0,0,0,.18);
}
.toggle input:checked + .track{
  background: color-mix(in srgb, #3b82f6 70%, #22c55e 30%);
}
.toggle input:checked + .track .thumb{ transform: translateX(18px); }

/* ===== LOAD popovers ===== */
.chip-btn{ border: none; cursor: pointer; }
.chip-btn:active{ transform: translateY(1px); }

/* ===== AK picker (FULLSCREEN POPUP) ===== */
#akPopover{
  position: fixed;
  inset: calc(var(--fixed-header-h) + 12px) 12px 12px 12px;
  width: auto;
  transform: none;

  background: var(--card);
  box-shadow: var(--shadow);
  border-radius: 16px;

  z-index: 4700;
  padding: 12px;
  border: 1px solid rgba(0,0,0,.08);

  display: none;
  overflow: auto;
}

body.dark #akPopover{
  border-color: rgba(255,255,255,.10);
}

#akBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 4600;
  display: none;
}

/* ===== AK picker : header figé ===== */
#akPopover{
  display: none;
  flex-direction: column;
}

#akPopover .ak-header{
  position: sticky;
  top: 0;
  z-index: 2;

  background: var(--card);
  padding: 10px 0;
  border-bottom: 1px solid rgba(0,0,0,.08);
}

body.dark #akPopover .ak-header{
  border-bottom-color: rgba(255,255,255,.10);
}

#akList{
  flex: 1 1 auto;
  overflow-y: auto;
}

/* ===== LOAD popovers (FULLSCREEN POPUP) ===== */
#loadArrPopover,
#loadExpPopover,
#loadFinalPopover{
  position: fixed;
  inset: calc(var(--fixed-header-h) + 12px) 12px 12px 12px;
  width: auto;
  transform: none;

  background: var(--card);
  box-shadow: var(--shadow);
  border-radius: 16px;

  z-index: 4500;
  display: none;

  padding: 12px;
  border: 1px solid rgba(0,0,0,.08);

  overflow-y: auto;
}

body.dark #loadArrPopover,
body.dark #loadExpPopover,
body.dark #loadFinalPopover{
  border-color: rgba(255,255,255,.10);
}

/* header inchangé, juste collant */
#loadArrPopover .hdr,
#loadExpPopover .hdr,
#loadFinalPopover .hdr{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 10px;

  position: sticky;
  top: 0;
  background: var(--card);
  z-index: 1;
}

#loadArrPopover .hdr strong,
#loadExpPopover .hdr strong,
#loadFinalPopover .hdr strong{
  font-weight: 900;
}

/* grilles inchangées */
#loadArrPopover .grid,
#loadExpPopover .grid,
#loadFinalPopover .grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
}

#loadArrPopover .field .label,
#loadExpPopover .field .label,
#loadFinalPopover .field .label{
  font-size: .9rem;
}

/* backdrop */
#loadArrBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 4400;
  display:none;
}

/* LOAD buttons row */
.load-row-below{
  display:flex;
  gap:10px;
  flex-wrap: wrap;
  justify-content: flex-start;
  margin-top: 12px;
}
.load-row-below .timer-chip{ min-width: 170px; }

/* === TIMELINE === */
.timeline-track {
  position: absolute; left:6%; right:6%;
  height: 4px; background:#cfd4da; transform:translateY(-50%); border-radius:4px;
}
body.dark .timeline-track{ background:#2e2e2e; }

.timeline-tick { position: absolute; width: 1px; background:rgba(0,0,0,0.08); }
body.dark .timeline-tick { background:#3e444b; }

.timeline-tick-label {
  position: absolute; transform: translateX(-50%);
  font-size: 14px; font-weight: 800; color:#111827;
}
body.dark .timeline-tick-label { color:#cfd4da; }

.tl-event, .tl-range { position: absolute; transform: translate(-50%, -50%); white-space: nowrap; line-height:1; z-index: 1; }
.tl-dot {
  width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,.15);
  margin: 0 auto 4px;
}
.tl-label {
  padding: 4px 10px; border-radius: 999px; background: #f1f3f5; color:#111; font-size: 14px; box-shadow: 0 0 0 1px rgba(0,0,0,.07);
  font-weight: 900;
}
body.dark .tl-label { background:#232733; color:#f5f5f5; box-shadow: 0 0 0 1px rgba(255,255,255,.08); }

.tl--std  { --c:#64748b; }
.tl--tobt { --c:#16a34a; }
.tl--ctot { --c:#334155; }
.tl--ops  { --c:#2563eb; }
.tl--turn { --c:#ef4444; }
.tl-event .tl-dot { background: var(--c); }

.tl-range {
  height: 16px; background: color-mix(in srgb, var(--c) 42%, transparent);
  border: 2px solid var(--c); border-radius: 999px; z-index: 2;
}
.tl-range-label {
  position:absolute; top: -22px; left:50%; transform: translateX(-50%);
  font-size: 13px; background: rgba(255,255,255,.92);
  padding: 2px 8px; border-radius: 10px; font-weight: 900;
  color: #111;
}
body.dark .tl-range-label { background: rgba(0,0,0,.45); color:#fff; }

.timeline-toolbar{
  display:flex; align-items:center; gap:8px; margin: 4px 0 10px;
  flex-wrap: wrap;
}
.timeline-scroll{
  overflow-x:auto; overflow-y:hidden;
  border-radius: 16px;
  background: var(--card);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
body.dark .timeline-scroll{
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
}
.timeline-canvas{ position:relative; min-width:600px; width:100%; }

/* DL error */
.dl-error { border: 2px solid #ef4444 !important; border-radius: 12px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px){
  .timer-chip{ min-width: 128px; }
  .timeline-canvas{ min-width: 720px; }
}
@media (max-width: 420px){
  .timer-chip{ min-width: 120px; padding: 9px 12px; }
  .timer-chip .v{ min-width: 64px; }
  .ctot-pill{ min-width: 64px; }
}

/* rien afficher tant qu'il n'y a pas d'onglet */
.app-wrap{ display:none; }
body.has-tab .app-wrap{ display:block; }

/* ===== NO TAB ===== */
body.no-tab .timer-row{
  display: none !important;
}

/* Header aligné sur le thème (clair / sombre) */
.fixed-header{
  background: var(--bg) !important;
  backdrop-filter: none !important;
}
  
/* Forcer le fond plein écran même sans contenu */
html, body{
  background: var(--bg) !important;
  min-height: 100%;
}

/* bouton refresh collé à chaque onglet */
.tab-wrap{
  display:inline-flex;
  align-items:center;
  gap:6px;
  flex: 0 0 auto;
}

.tab-refresh{
  border-radius: 999px !important;
  padding: 0 10px !important;
  height: 36px;
  min-width: 36px;
  font-weight: 900;
}
.tab-refresh.is-loading{
  pointer-events:none;
  opacity:.7;
}

  /* ===== PRO RESPONSIVE LAYOUT (PHONE / TABLET) ===== */

:root{
  --gap: 10px;
  --padCard: 12px;
  --labelSize: .78rem;
  --inputH: 42px;
}

@media (min-width: 769px){
  :root{ --gap: 12px; --padCard: 14px; --inputH: 44px; }
}

.card-content{ padding: var(--padCard) !important; }

.field .label{
  font-size: var(--labelSize) !important;
  letter-spacing: .02em;
  text-transform: uppercase;
  opacity: .9;
}

/* Inputs un peu plus "app" */
.input, .select select, .textarea{
  height: var(--inputH);
  font-weight: 800;
}
.textarea{ min-height: 110px; height: auto; }

/* Grilles responsive simples */
.grid-auto{
  display:grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: var(--gap);
}

.span-12{ grid-column: span 12; }
.span-6{  grid-column: span 12; }
.span-4{  grid-column: span 6; }
.span-3{  grid-column: span 6; }

@media (min-width: 769px){
  .span-6{ grid-column: span 6; }
  .span-4{ grid-column: span 4; }
  .span-3{ grid-column: span 3; }
}

/* "Rows" ultra compactes pour infos clés */
.kv-strip{
  display:grid;
  grid-template-columns: 1fr;
  gap: var(--gap);
}

@media (min-width: 769px){
  .kv-strip{ grid-template-columns: 1fr 1fr; }
}

.kv-card{
  border-radius: 14px;
  background: color-mix(in srgb, var(--card) 90%, #3b82f6 10%);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
  padding: 10px 12px;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}

body.dark .kv-card{
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
}

.kv-left{ display:flex; flex-direction:column; gap:2px; }
.kv-title{ font-size:.78rem; font-weight:900; color: var(--muted); text-transform:uppercase; }
.kv-value{ font-size:1.1rem; font-weight:900; color: var(--text); }

/* Boutons -1 Now +1 mieux rangés */
.btn-actions{
  grid-template-columns: repeat(3, 1fr);
}
.btn-actions .button{
  height: 40px;
}

/* Segments (Arr/Dep) plus compacts */
.tabs.is-toggle.is-toggle-rounded ul li a{
  font-weight: 900;
}

/* ===== SETTINGS (gear) bottom menu ===== */
#settingsBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 4800;
  display: none;
}

#settingsFab{
  position: fixed;
  right: 14px;
  bottom: 14px;
  z-index: 4900;
  width: 52px;
  height: 52px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  box-shadow: var(--shadow2);
}

#settingsMenu{
  position: fixed;
  right: 14px;
  bottom: 74px;
  z-index: 4901;
  width: min(320px, calc(100vw - 28px));
  border-radius: 16px;
  background: var(--card);
  box-shadow: var(--shadow);
  border: 1px solid rgba(0,0,0,.08);
  padding: 12px;
  display: none;
}

body.dark #settingsMenu{
  border-color: rgba(255,255,255,.10);
}

#settingsMenu .settings-title{
  font-weight: 900;
  margin-bottom: 10px;
}

#settingsMenu .settings-row{
  display:flex;
  flex-direction: column;
  gap: 10px;
}

.infovol-toggle{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap:10px;
  margin: 6px 0 12px;
  cursor:pointer;
  user-select:none;
  padding: 8px 10px;
  border-radius: 12px;
  background: color-mix(in srgb, var(--card) 92%, #000 8%);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
}
body.dark .infovol-toggle{
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
}

/* ===== TIMER CHIPS COMPACT (MOBILE) ===== */
@media (max-width: 480px){

  .timer-row{
    gap: 6px;
  }

  .timer-chip{
    min-width: 96px;
    padding: 6px 8px;
    gap: 6px;
  }

  .timer-chip .k{
    font-size: .7rem;
    font-weight: 800;
  }

  .timer-chip .v{
    min-width: 54px;
    padding: 4px 6px;
    font-size: .8rem;
  }

  /* CTOT input */
  .ctot-pill{
    min-width: 54px;
    padding: 4px 6px !important;
    font-size: .8rem;
  }
}

/* ===== LOAD MODAL (pro fullscreen) ===== */
#loadBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.40);
  z-index: 4400;
}

#loadModal{
  position: fixed;
  inset: calc(var(--fixed-header-h) + 10px) 10px 10px 10px;
  z-index: 4500;
  background: var(--card);
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(0,0,0,.10);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
body.dark #loadModal{ border-color: rgba(255,255,255,.10); }

.lm-header{
  position: sticky;
  top: 0;
  z-index: 3;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--card);
  border-bottom: 1px solid rgba(0,0,0,.08);
}
body.dark .lm-header{ border-bottom-color: rgba(255,255,255,.10); }

.lm-title{
  display:flex;
  align-items:center;
  gap:10px;
  flex: 1 1 auto;
}
.lm-title strong{ font-weight: 900; font-size: 1.05rem; }
#lmHint{ font-weight: 900; }

.lm-seg{
  display:inline-flex;
  gap:6px;
  background: color-mix(in srgb, var(--card) 86%, #000 14%);
  padding: 6px;
  border-radius: 999px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
}
body.dark .lm-seg{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
.lm-seg .button{
  border-radius: 999px !important;
  font-weight: 900;
  height: 34px;
}

.lm-seg .button.is-active{
  background: #2563eb !important;
  color: #fff !important;
  border-color: transparent !important;
}

.lm-body{
  padding: 12px;
  overflow: auto;
}

.lm-panel{ width: 100%; }

.lm-grid{
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 10px;
}

.lm-grid .field{ margin-bottom: 0 !important; }

.lm-grid .field:nth-child(-n+3){ grid-column: span 4; }
.lm-grid .field{ grid-column: span 3; }

.lm-span-12{ grid-column: span 12 !important; }

.lm-subtitle{
  margin: 8px 0 8px;
  font-weight: 900;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .04em;
  font-size: .78rem;
}

.lm-grid-compact .field{ grid-column: span 4; }

@media (max-width: 900px){
  #loadModal{ inset: calc(var(--fixed-header-h) + 10px) 8px 8px 8px; }
  .lm-grid .field:nth-child(-n+3){ grid-column: span 6; }
  .lm-grid .field{ grid-column: span 6; }
  .lm-grid-compact .field{ grid-column: span 6; }
}
@media (max-width: 520px){
  .lm-grid .field:nth-child(-n+3){ grid-column: span 12; }
  .lm-grid .field{ grid-column: span 6; }
  .lm-grid-compact .field{ grid-column: span 6; }
  .lm-header{ gap:8px; }
  .lm-title strong{ font-size: 1rem; }
}

/* ===== LDM modal (single view, 2 columns, compact) ===== */
#ldmBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.42);
  z-index: 4400;
}

#ldmModal{
  position: fixed;
  inset: calc(var(--fixed-header-h) + 10px) 10px 10px 10px;
  z-index: 4500;
  background: var(--card);
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(0,0,0,.10);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
body.dark #ldmModal{ border-color: rgba(255,255,255,.10); }

.ldm-header{
  position: sticky;
  top: 0;
  z-index: 3;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  background: var(--card);
  border-bottom: 1px solid rgba(0,0,0,.08);
}
body.dark .ldm-header{ border-bottom-color: rgba(255,255,255,.10); }

.ldm-title{ display:flex; align-items:center; gap:10px; }
.ldm-title strong{ font-weight:900; font-size:1.05rem; letter-spacing:.02em; }

.ldm-body{
  padding: 10px;
  overflow: auto;
  display: grid;
  gap: 10px;
}

.ldm-card{
  border-radius: 16px;
  background: color-mix(in srgb, var(--card) 92%, #000 8%);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
  overflow: hidden;
}
body.dark .ldm-card{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }

.ldm-card-hdr{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px;
  background: color-mix(in srgb, var(--card) 88%, #000 12%);
  border-bottom: 1px solid rgba(0,0,0,.06);
}
body.dark .ldm-card-hdr{ border-bottom-color: rgba(255,255,255,.08); }

.ldm-dot{
  width: 10px; height: 10px; border-radius: 999px;
  background: var(--ldmAccent, #2563eb);
  box-shadow: 0 0 0 4px color-mix(in srgb, var(--ldmAccent, #2563eb) 22%, transparent);
}

.ldm-card-title{ font-weight: 900; letter-spacing:.08em; }
.ldm-card-sub{ color: var(--muted); font-weight: 800; font-size: .85rem; margin-left:auto; }

.ldm-arr  { --ldmAccent:#2563eb; }
.ldm-exp  { --ldmAccent:#0ea5e9; }
.ldm-final{ --ldmAccent:#7c3aed; }

.ldm-grid{
  padding: 10px 12px 12px;
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px 10px;
}

.ldm-f{ margin-bottom: 0 !important; }
.ldm-span-2{ grid-column: span 2; }

.ldm-in{
  height: 38px !important;
  padding: 6px 10px !important;
  font-weight: 900 !important;
  text-align: center;
  letter-spacing: .02em;
}

.ldm-ta{
  min-height: 90px !important;
  height: auto !important;
  font-weight: 800;
}

@media (max-width: 520px){
  #ldmModal{ inset: calc(var(--fixed-header-h) + 10px) 8px 8px 8px; }
  .ldm-grid{ gap: 7px 8px; }
  .ldm-in{ height: 36px !important; padding: 6px 8px !important; }
  .ldm-ta{ min-height: 86px !important; }
}
 
</style>
</head>

<body onload="initForm()">

<!-- ===== LDM (FULLSCREEN) ===== -->
<div id="ldmBackdrop" onclick="closeLDM()" style="display:none;"></div>

<div id="ldmModal" role="dialog" aria-modal="true" style="display:none;">
  <div class="ldm-header">
    <div class="ldm-title">
      <strong>LDM</strong>
      <span class="tag is-light" id="ldmHint">LOAD DATA MANIFEST</span>
    </div>
    <button class="button is-small is-light" type="button" onclick="closeLDM()">Fermer</button>
  </div>

  <div class="ldm-body">

    <!-- ===== ARR ===== -->
    <section class="ldm-card ldm-arr">
      <div class="ldm-card-hdr">
        <div class="ldm-dot"></div>
        <div class="ldm-card-title">ARR</div>
        <div class="ldm-card-sub">Arrivée</div>
      </div>

      <div class="ldm-grid">
        <div class="field ldm-f">
          <label class="label">PAX</label>
          <input class="input ldm-in" id="LoadPAX" inputmode="numeric" maxlength="4" oninput="digitsOnly(this)">
        </div>
        <div class="field ldm-f">
          <label class="label">BAGS</label>
          <input class="input ldm-in" id="LoadBAGS" inputmode="numeric" maxlength="4"
                 oninput="digitsOnly(this); updateHBagsValidity('arr')">
        </div>

        <div class="field ldm-f">
          <label class="label">POIDS</label>
          <input class="input ldm-in" id="LoadPOIDS" inputmode="numeric" maxlength="4" oninput="digitsOnly(this)">
        </div>
        <div class="field ldm-f">
          <label class="label">H1</label>
          <input class="input ldm-in" id="LoadH1" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('arr')">
        </div>
        <div class="field ldm-f">
          <label class="label">H2</label>
          <input class="input ldm-in" id="LoadH2" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('arr')">
        </div>
        <div class="field ldm-f">
          <label class="label">H3</label>
          <input class="input ldm-in" id="LoadH3" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('arr')">
        </div>
        <div class="field ldm-f">
          <label class="label">H4</label>
          <input class="input ldm-in" id="LoadH4" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('arr')">
        </div>

        <div class="field ldm-span-2">
          <label class="label">SI</label>
          <textarea class="textarea si-uppercase ldm-ta" id="LoadSI"
            autocorrect="off" spellcheck="false" autocapitalize="characters" inputmode="text"></textarea>
        </div>
      </div>
    </section>

    <!-- ===== EXP ===== -->
    <section class="ldm-card ldm-exp">
      <div class="ldm-card-hdr">
        <div class="ldm-dot"></div>
        <div class="ldm-card-title">EXP</div>
        <div class="ldm-card-sub">Exploitation</div>
      </div>

      <div class="ldm-grid">
        <div class="field ldm-f">
          <label class="label">PAX</label>
          <input class="input ldm-in" id="ExpPAX" inputmode="numeric" maxlength="4" oninput="digitsOnly(this)">
        </div>
        <div class="field ldm-f">
          <label class="label">BAGS</label>
          <input class="input ldm-in" id="ExpBAGS" inputmode="numeric" maxlength="4"
                 oninput="digitsOnly(this); updateHBagsValidity('exp')">
        </div>

        <div class="field ldm-f">
          <label class="label">POIDS</label>
          <input class="input ldm-in" id="ExpPOIDS" inputmode="numeric" maxlength="4" oninput="digitsOnly(this)">
        </div>
        <div class="field ldm-f">
          <label class="label">H1</label>
          <input class="input ldm-in" id="ExpH1" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('exp')">
        </div>
        <div class="field ldm-f">
          <label class="label">H2</label>
          <input class="input ldm-in" id="ExpH2" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('exp')">
        </div>
        <div class="field ldm-f">
          <label class="label">H3</label>
          <input class="input ldm-in" id="ExpH3" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('exp')">
        </div>
        <div class="field ldm-f">
          <label class="label">H4</label>
          <input class="input ldm-in" id="ExpH4" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('exp')">
        </div>

        <div class="field ldm-span-2">
          <label class="label">SI</label>
          <textarea class="textarea si-uppercase ldm-ta" id="ExpSI"
            autocorrect="off" spellcheck="false" autocapitalize="characters" inputmode="text"></textarea>
        </div>
      </div>
    </section>

    <!-- ===== FINAL ===== -->
    <section class="ldm-card ldm-final">
      <div class="ldm-card-hdr">
        <div class="ldm-dot"></div>
        <div class="ldm-card-title">FINAL</div>
        <div class="ldm-card-sub">Manif + zones + bags</div>
      </div>

      <div class="ldm-grid">
        <div class="field ldm-f"><label class="label">MALE</label><input class="input ldm-in" id="FinalMALE" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>
        <div class="field ldm-f"><label class="label">FEMALE</label><input class="input ldm-in" id="FinalFEMALE" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>

        <div class="field ldm-f"><label class="label">ADULT</label><input class="input ldm-in" id="FinalADULT" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>
        <div class="field ldm-f"><label class="label">CHILD</label><input class="input ldm-in" id="FinalCHILD" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>

        <div class="field ldm-f"><label class="label">INFANT</label><input class="input ldm-in" id="FinalINFANT" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>
        <div class="field ldm-f"><label class="label">TOB</label><input class="input ldm-in has-text-weight-bold" id="FinalTOB" type="text" readonly></div>

        <div class="field ldm-f"><label class="label">OA</label><input class="input ldm-in" id="FinalOA" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>
        <div class="field ldm-f"><label class="label">OB</label><input class="input ldm-in" id="FinalOB" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>

        <div class="field ldm-f"><label class="label">OC</label><input class="input ldm-in" id="FinalOC" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>
        <div class="field ldm-f"><label class="label">OD</label><input class="input ldm-in" id="FinalOD" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalTOB()"></div>

        <div class="field ldm-f"><label class="label">BAGS</label><input class="input ldm-in" id="FinalBAGS" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('final'); updateFinalWeightIfNeeded()"></div>
        <div class="field ldm-f"><label class="label">POIDS</label><input class="input ldm-in" id="FinalPOIDS" inputmode="numeric" readonly></div>

        <div class="field ldm-f"><label class="label">GB</label><input class="input ldm-in" id="FinalGB" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateFinalWeightIfNeeded()"></div>
        <div class="field ldm-f"><label class="label">H1</label><input class="input ldm-in" id="FinalH1" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('final')"></div>

        <div class="field ldm-f"><label class="label">H2</label><input class="input ldm-in" id="FinalH2" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('final')"></div>
        <div class="field ldm-f"><label class="label">H3</label><input class="input ldm-in" id="FinalH3" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('final')"></div>

        <div class="field ldm-f"><label class="label">H4</label><input class="input ldm-in" id="FinalH4" inputmode="numeric" maxlength="4" oninput="digitsOnly(this); updateHBagsValidity('final')"></div>
        <div class="field ldm-f"></div>

        <div class="field ldm-span-2">
          <label class="label">SI</label>
          <textarea class="textarea si-uppercase ldm-ta" id="FinalSI"
            autocorrect="off" spellcheck="false" autocapitalize="characters" inputmode="text"></textarea>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- ===== FIXED HEADER ===== -->
<div class="fixed-header" id="fixedHeader">
  <div class="fixed-header-inner">

   <div class="topbar-inner"></div>

    <div class="tabs-row">
      <div id="tab-bar" class="tabs-chip"></div>
    </div>

    <div class="timer-row">
      <div class="timer-chip">
        <div class="k">HLE</div>
        <div id="timer-h40" class="v">--:--</div>
      </div>
      <div class="timer-chip">
        <div class="k">H-15</div>
        <div id="timer-h15" class="v">--:--</div>
      </div>

      <div id="lidBlock" class="timer-chip" style="display:none;">
        <div class="k">LID</div>
        <div id="timer-h8" class="v">--:--</div>
      </div>

      <div class="timer-chip">
        <div class="k">TOBT</div>
        <div id="timer-tobt" class="v">--:--</div>
      </div>

      <div class="timer-chip">
        <div class="k">CTOT</div>
        <input id="CTOT" class="ctot-pill" type="time" onchange="updateAllCalculations()">
      </div>

      <div class="timer-chip">
        <div class="k">CD</div>
        <div id="timer-cd" class="v">--:--</div>
      </div>
    </div>

  </div>
</div>

<div class="app-wrap">

<!-- INFO VOL -->
<div class="card mb-5">
  <header class="card-header">
    <p class="card-header-title">INFO VOL</p>
  </header>

  <div class="card-content">

    <!-- Bandeau ESSENTIEL -->
    <div class="kv-strip mb-4">
      <div class="kv-card">
        <div class="kv-left">
          <div class="kv-title">Vol</div>
          <div class="kv-value">
            <span id="kvArrVol">----</span> → <span id="kvDepVol">----</span>
          </div>
        </div>
        <div class="kv-left" style="text-align:right;">
          <div class="kv-title">Route</div>
          <div class="kv-value">
            <span id="kvFrom">---</span> → <span id="kvTo">---</span>
          </div>
        </div>
      </div>

      <div class="kv-card">
        <div class="kv-left">
          <div class="kv-title">Immat / Type</div>
          <div class="kv-value">
            <span id="kvImmat">------</span> · <span id="kvType">--</span>
          </div>
        </div>
        <div class="kv-left" style="text-align:right;">
          <div class="kv-title">Salle arr. / Parking</div>
          <div class="kv-value">
            <span id="kvBC">----</span> · <span id="kvPark">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- DÉTAILS (éditables) -->
    <div id="infoVolDetails" class="grid-auto">

      <!-- Date + Salle arrivée -->
      <div class="field span-6">
        <label class="label">Date</label>
        <input class="input" type="date" id="Date">
      </div>

      <div class="field span-6">
        <label class="label">Salle arrivée</label>
        <input class="input uppercase" type="text" id="BorderControl">
      </div>

      <!-- Cie / N° -->
      <div class="field span-3">
        <label class="label">Cie</label>
        <div class="select is-fullwidth">
          <select id="Cie">
            <option value="">--</option>
            <option>FR</option><option>RK</option><option>W4</option><option>W6</option>
            <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
            <option>V7</option><option>Autre</option>
          </select>
        </div>
      </div>

      <div class="field span-3">
        <label class="label">N°</label>
        <input class="input uppercase" type="text" id="NVol">
      </div>

      <!-- From / To -->
      <div class="field span-3">
        <label class="label">From</label>
        <input class="input uppercase" type="text" id="From" maxlength="3">
      </div>

      <div class="field span-3">
        <label class="label">To</label>
        <input class="input uppercase" type="text" id="To" maxlength="3">
      </div>

      <!-- Immat / Type avion -->
      <div class="field span-6">
        <label class="label">Immat</label>
        <input class="input uppercase" type="text" id="Immat" maxlength="6">
      </div>

      <div class="field span-6">
        <label class="label">Type avion</label>
        <div class="select is-fullwidth">
          <select id="TypeAvion">
            <option value="">--</option>
            <option>A319</option><option>A320</option><option>A321</option>
            <option>A20N</option><option>A21N</option><option>A21NY</option>
            <option>B734</option><option>B737</option><option>B738</option>
            <option>B38M</option><option>BCS3</option>
            <option>Autre</option>
          </select>
        </div>
      </div>

      <!-- Parking -->
      <div class="field span-6">
        <label class="label">Parking</label>
        <div class="select is-fullwidth">
          <select id="Parking">
            <option value="">--</option>
            <option>1</option><option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
      </div>

      <!-- LOAD buttons -->
      <div class="span-12">
        <div class="load-row-below">
          <button type="button" class="timer-chip chip-btn" onclick="toggleLoadArr()">
            <div class="k">LOAD</div>
            <div class="v" style="background:#2563eb;">ARR.</div>
          </button>
          <button type="button" class="timer-chip chip-btn" onclick="toggleLoadExp()">
            <div class="k">LOAD</div>
            <div class="v" style="background:#0ea5e9;">EXP.</div>
          </button>
          <button type="button" class="timer-chip chip-btn" onclick="toggleLoadFinal()">
            <div class="k">LOAD</div>
            <div class="v" style="background:#7c3aed;">FINAL</div>
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- HORAIRES -->
<div class="card mb-5">
  <header class="card-header section-collapse" onclick="toggleCardBody(this)">
    <p class="card-header-title">HORAIRES</p>
    <span class="card-header-icon"><span class="icon">⌄</span></span>
  </header>

  <div class="card-content">
    <div class="grid-auto">

      <!-- Arrivée -->
      <div class="span-12">
        <div class="kv-card" style="padding:12px;">
          <div style="font-weight:900; color:var(--muted); text-transform:uppercase;">Arrivée</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <div style="min-width:160px;">
              <label class="label">SIBT</label>
              <input class="input" type="time" id="SIBT" onchange="updateAllCalculations()">
              <div class="btn-actions">
                <button class="button is-dark is-light" type="button" onclick="adjustTime('SIBT',-1);updateAllCalculations()">-1</button>
                <button class="button is-link" type="button" onclick="setNow('SIBT');updateAllCalculations()">Now</button>
                <button class="button is-dark is-light" type="button" onclick="adjustTime('SIBT',1);updateAllCalculations()">+1</button>
              </div>
            </div>

            <div style="min-width:160px;">
              <label class="label">AIBT</label>
              <input class="input" type="time" id="AIBT" onchange="updateAllCalculations()">
              <div class="btn-actions">
                <button class="button is-dark is-light" type="button" onclick="adjustTime('AIBT',-1);updateAllCalculations()">-1</button>
                <button class="button is-link" type="button" onclick="setNow('AIBT');updateAllCalculations()">Now</button>
                <button class="button is-dark is-light" type="button" onclick="adjustTime('AIBT',1);updateAllCalculations()">+1</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Départ -->
      <div class="span-12">
        <div class="kv-card" style="padding:12px;">
          <div style="font-weight:900; color:var(--muted); text-transform:uppercase;">Départ</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <div style="min-width:160px;">
              <label class="label">SOBT</label>
              <input class="input" type="time" id="SOBT" onchange="manualSOBT=true;updateAllCalculations()">
              <div class="btn-actions">
                <button class="button is-dark is-light" type="button" onclick="adjustTime('SOBT',-1);updateAllCalculations()">-1</button>
                <button class="button is-link" type="button" onclick="setNow('SOBT');updateAllCalculations()">Now</button>
                <button class="button is-dark is-light" type="button" onclick="adjustTime('SOBT',1);updateAllCalculations()">+1</button>
              </div>
            </div>

            <div style="min-width:160px;">
              <label class="label">AOBT</label>
              <input class="input" type="time" id="AOBT" onchange="updateAllCalculations()">
              <div class="btn-actions">
                <button class="button is-dark is-light" type="button" onclick="adjustTime('AOBT',-1);updateAllCalculations()">-1</button>
                <button class="button is-link" type="button" onclick="setNow('AOBT');updateAllCalculations()">Now</button>
                <button class="button is-dark is-light" type="button" onclick="adjustTime('AOBT',1);updateAllCalculations()">+1</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

  <!-- TIMING -->
  <div class="card mb-5">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">TIMING</p>
      <span class="card-header-icon"><span class="icon">⌄</span></span>
    </header>
    <div class="card-content">
      <div id="timing-grid"></div>
    </div>
  </div>

  <!-- TIMELINE -->
  <div class="card mb-5">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">TIMELINE</p>
      <span class="card-header-icon"><span class="icon">⌄</span></span>
    </header>
    <div class="card-content">
      <div class="timeline-toolbar">
        <button type="button" class="button is-small" onclick="timelineZoomOut()">−</button>
        <span class="tag is-light" id="timelineZoomLabel">100%</span>
        <button type="button" class="button is-small" onclick="timelineZoomIn()">+</button>
        <button type="button" class="button is-small is-light" onclick="timelineZoomReset()">Reset</button>
      </div>

      <div class="timeline-scroll" id="timelineScroll">
        <div id="timelineCanvas" class="timeline-canvas"></div>
      </div>
    </div>
  </div>

  <!-- RETARDS -->
  <div class="card mb-5">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">RETARDS (Départ)</p>
      <span class="card-header-icon"><span class="icon">⌄</span></span>
    </header>
    <div class="card-content">
      <div class="columns is-multiline">
        <div class="column is-full-mobile is-one-third-tablet is-one-quarter-desktop">
          <div class="field">
            <label class="label">DL Code 1</label>
            <div class="control"><input class="input" type="text" id="DLcode1"></div>
          </div>
        </div>
        <div class="column is-full-mobile is-one-third-tablet is-one-quarter-desktop">
          <div class="field">
            <label class="label">DL Durée 1 (min)</label>
            <div class="control"><input class="input" type="number" id="DLduree1" min="0" step="1" oninput="dldChanged(1)"></div>
          </div>
        </div>

        <div class="column is-full-mobile is-one-third-tablet is-one-quarter-desktop">
          <div class="field">
            <label class="label">DL Code 2</label>
            <div class="control"><input class="input" type="text" id="DLcode2"></div>
          </div>
        </div>
        <div class="column is-full-mobile is-one-third-tablet is-one-quarter-desktop">
          <div class="field">
            <label class="label">DL Durée 2 (min)</label>
            <div class="control"><input class="input" type="number" id="DLduree2" min="0" step="1" oninput="dldChanged(2)"></div>
          </div>
        </div>

        <div class="column is-full-mobile is-one-third-tablet is-one-quarter-desktop">
          <div class="field">
            <label class="label">DL Code 3</label>
            <div class="control"><input class="input" type="text" id="DLcode3"></div>
          </div>
        </div>
        <div class="column is-full-mobile is-one-third-tablet is-one-quarter-desktop">
          <div class="field">
            <label class="label">DL Durée 3 (min)</label>
            <div class="control"><input class="input" type="number" id="DLduree3" min="0" step="1" oninput="dldChanged(3)"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FAITS SAILLANTS -->
  <div class="card mb-5">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">FAITS SAILLANTS</p>
      <span class="card-header-icon"><span class="icon">⌄</span></span>
    </header>
    <div class="card-content">
      <textarea class="textarea" id="FaitsSaillants" placeholder="Faits saillants…"></textarea>
    </div>
  </div>

  <div class="buttons is-centered">
    <button class="button is-success is-medium" id="validate" onclick="openRZAModal()">VALIDER</button>
    <button class="button is-link is-medium" id="save" onclick="manualSave()">SAUVEGARDER</button>
    <button class="button is-danger is-light is-medium" id="reset" onclick="clearAutoSave()">RÉINITIALISER TOUT</button>
  </div>

</div>

  <!-- ===== RZA MODAL ===== -->
<div id="rzaBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:6000;"></div>

<div id="rzaModal" style="display:none; position:fixed; inset:0; z-index:6100; align-items:center; justify-content:center; padding:14px;">
  <div class="card" style="width:min(420px, 100%);">
    <header class="card-header">
      <p class="card-header-title">RZA requis</p>
    </header>
    <div class="card-content">
      <div class="field">
        <label class="label">RZA en charge du vol :</label>
        <div class="control">
          <input id="rzaModalInput" class="input uppercase" type="text" maxlength="3" autocomplete="off" spellcheck="false">
        </div>
        <p class="help" id="rzaHelp" style="display:none; color:#ef4444; font-weight:800;">2 ou 3 lettres uniquement.</p>
      </div>

      <div class="buttons is-right">
        <button class="button is-light" type="button" onclick="closeRZAModal(false)">Annuler</button>
        <button class="button is-link" type="button" onclick="submitRZAModal()">Valider</button>
      </div>
    </div>
  </div>
</div>

<script>
/* Collapse */
function toggleCardBody(headerEl){
  const card = headerEl.closest('.card');
  if(!card) return;
  const content = card.querySelector('.card-content');
  if(!content) return;
  const collapsed = content.classList.toggle('collapsed-body');
  const icon = headerEl.querySelector('.icon');
  if(icon) icon.textContent = collapsed ? '›' : '⌄';
}

/* Header height */
function updateHeaderOffset(){
  const header = document.getElementById('fixedHeader');
  if(!header) return;
  const h = Math.ceil(header.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--fixed-header-h', h + 'px');
}

/* Vars */
let isUTC=false;
let manualSOBT=false;
let currentTabId=null;
let saveTimer=null;

let settingFromAK = false;

/* ===== AK managed fields helpers ===== */
function isEmptyVal(el){
  return !el || ((el.value || '').trim() === '');
}

function setValAK(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  settingFromAK = true;
  el.value = (typeof v === 'string') ? (v ?? '').toUpperCase() : (v ?? '');
  el.dataset.ak = '1';
  el.dispatchEvent(new Event('input',  { bubbles:true }));
  el.dispatchEvent(new Event('change', { bubbles:true }));
  settingFromAK = false;
}

function setTimeFromISOAK(id, iso){
  if(!iso) return;
  const d = new Date(iso);
  if(isNaN(d.getTime())) return;

  const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
  const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');

  setValAK(id, `${hh}:${mm}`);
}

function setTimeFromISOIfEmptyOrAK(id, iso){
  const el = document.getElementById(id);
  if(!el) return;
  if(isEmptyVal(el) || el.dataset.ak === '1'){
    setTimeFromISOAK(id, iso);
  }
}

function setIfEmptyOrAK(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  // si champ vide OU déjà piloté AK -> on écrase
  if(isEmptyVal(el) || el.dataset.ak === '1'){
    setValAK(id, (v ?? ''));
  }
}

/* Si l'utilisateur modifie un champ manuellement -> il n'est plus piloté AK */
document.addEventListener('input', (e)=>{
  const t = e.target;
  if(!t || !t.dataset) return;
  if(settingFromAK) return;
  if(t.dataset.ak === '1') delete t.dataset.ak;
}, true);

/* Timeline */
let timelineZoom = 1;
const TL_ZOOM_MIN = 0.5;
const TL_ZOOM_MAX = 8;
const TL_ZOOM_STEP = 0.25;
window._timelineCurrentRange = null;

/* TOBT brut + TOBT affiché */
window._tobtRawMins = null;
window._tobtAdjMins = null;

/* DL */
let lastDLChanged = 1;

/* digits only */
function digitsOnly(el){ el.value = (el.value || '').replace(/[^0-9]/g,''); }

/* ===== H1–H4 vs BAGS (ARR / EXP / FINAL) ===== */
function updateHBagsValidity(mode){
  const map = {
    arr:   { bags:'LoadBAGS',  h:['LoadH1','LoadH2','LoadH3','LoadH4'] },
    exp:   { bags:'ExpBAGS',   h:['ExpH1','ExpH2','ExpH3','ExpH4'] },
    final: { bags:'FinalBAGS', h:['FinalH1','FinalH2','FinalH3','FinalH4'] },
  };
  const cfg = map[mode];
  if(!cfg) return;

  const bagsEl = document.getElementById(cfg.bags);
  if(!bagsEl) return;

  const bags = parseInt(bagsEl.value || '0', 10);
  let sum = 0;

  cfg.h.forEach(id=>{
    const el = document.getElementById(id);
    if(el) sum += parseInt(el.value || '0', 10);
  });

  bagsEl.classList.toggle('is-invalid', bags > 0 && sum !== bags);
}

/* ===== POIDS auto FR / RK : (BAGS + GB) * 13 ===== */
/* ===== POIDS auto FR / RK : FINAL ===== */
function updateFinalWeightIfNeeded(){
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  if(cie !== 'FR' && cie !== 'RK') return;

  const bags = parseInt(document.getElementById('FinalBAGS')?.value || '0', 10);
  const gb   = parseInt(document.getElementById('FinalGB')?.value   || '0', 10);

  const poids = (bags + gb) * 13;
  const poidsEl = document.getElementById('FinalPOIDS');
  if(!poidsEl) return;

  if(
    (document.getElementById('FinalBAGS')?.value || '') === '' &&
    (document.getElementById('FinalGB')?.value || '') === ''
  ){
    poidsEl.value = '';
    return;
  }

  poidsEl.value = String(poids);
}

/* ===== POIDS auto FR / RK : ARR + EXP ===== */
function updateArrExpWeightIfNeeded(){
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  if(cie !== 'FR' && cie !== 'RK') return;

  // EXP uniquement (ARR désactivé)
  const bagsExp = asInt('ExpBAGS');
  const poidsExpEl = document.getElementById('ExpPOIDS');
  if(bagsExp != null && poidsExpEl && poidsExpEl.value === ''){
    poidsExpEl.value = String(bagsExp * 13);
  }
}

/* ===== COUNTDOWN (CD) ===== */
let countdownTimer = null;

function getNowMinutes(){
  const now = new Date();
  const h = isUTC ? now.getUTCHours() : now.getHours();
  const m = isUTC ? now.getUTCMinutes() : now.getMinutes();
  const s = isUTC ? now.getUTCSeconds() : now.getSeconds();
  return { mins: h*60 + m, secs: s };
}

function fmtMMSSSigned(totalSeconds){
  const isOver = totalSeconds < 0;
  const abs = Math.abs(totalSeconds);

  const mm = Math.floor(abs / 60);
  const ss = abs % 60;

  return `${isOver ? '+' : ''}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}

function stopCountdown(resetDisplay=true){
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
  const el = document.getElementById('timer-cd');
  if(!el) return;
  if(resetDisplay){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
  }
}

function freezeCountdown(){
  // on coupe juste l'interval, on ne touche pas au texte affiché
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
}

function updateCountdownOnce(){
  const el = document.getElementById('timer-cd');
  if(!el) return;

  const sibtTxt = document.getElementById('SIBT')?.value || '';
  const aibtTxt = document.getElementById('AIBT')?.value || '';
  const sobtTxt = document.getElementById('SOBT')?.value || '';
  const aobtTxt = document.getElementById('AOBT')?.value || '';

  if(!aibtTxt || !sobtTxt || !sibtTxt){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
    return;
  }

  const SIBT = parseHHMM(sibtTxt);
  const AIBT = parseHHMM(aibtTxt);
  const SOBT = parseHHMM(sobtTxt);
  if(SIBT == null || AIBT == null || SOBT == null){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
    return;
  }

  // cible = SOBT si retard AIBT<=SIBT, sinon TOBT adj
  let targetMin = null;
  if (AIBT <= SIBT) targetMin = SOBT;
  else {
    const tobt = window._tobtAdjMins;
    if(tobt == null){
      el.textContent = '--:--';
      el.classList.remove('cd-over');
      return;
    }
    targetMin = tobt;
  }

  // ===== CAS AOBT : on fige MAIS on recalcule selon AOBT =====
  if(aobtTxt){
    const AOBT = parseHHMM(aobtTxt);
    if(AOBT == null){
      el.textContent = '--:--';
      el.classList.remove('cd-over');
      return;
    }

    // diff = AOBT - cible (signé, gère minuit)
    let diffMin = AOBT - targetMin;
    if(diffMin > 720) diffMin -= 1440;
    if(diffMin < -720) diffMin += 1440;

    const totalSeconds = diffMin * 60;
    const sign = totalSeconds >= 0 ? '+' : '-';
    const abs = Math.abs(totalSeconds);
    const mm = Math.floor(abs / 60);
    const ss = abs % 60;

    el.textContent = `${sign}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;

    // rouge si + (retard)
    el.classList.toggle('cd-over', totalSeconds > 0);
    return;
  }

  // ===== CAS NORMAL : live avec NOW (décompte puis +) =====
  const now = getNowMinutes();

  let diffMin = targetMin - now.mins;
  if(diffMin < -720) diffMin += 1440;
  if(diffMin > 720) diffMin -= 1440;

  const remainingSeconds = diffMin * 60 - now.secs;

  const sign = remainingSeconds <= 0 ? '+' : ''; // quand on dépasse => +
  const abs = Math.abs(remainingSeconds);
  const mm = Math.floor(abs / 60);
  const ss = abs % 60;

  el.textContent = `${sign}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  el.classList.toggle('cd-over', remainingSeconds < 0); // rouge quand on est passé à +
}

function ensureCountdownRunning(){
  const sibtTxt = document.getElementById('SIBT')?.value || '';
  const aibtTxt = document.getElementById('AIBT')?.value || '';
  const sobtTxt = document.getElementById('SOBT')?.value || '';
  const aobtTxt = document.getElementById('AOBT')?.value || '';

  const baseOK = !!(sibtTxt && aibtTxt && sobtTxt);

  // Si AOBT est rempli : pas d'interval, mais on recalcule l'affichage (donc ça suit si tu modifies AOBT)
  if(baseOK && aobtTxt){
    freezeCountdown();
    updateCountdownOnce();
    return;
  }

  // Si base incomplète : on stop + reset
  if(!baseOK){
    stopCountdown(true);
    return;
  }

  // Live
  if(!countdownTimer){
    updateCountdownOnce();
    countdownTimer = setInterval(updateCountdownOnce, 1000);
  } else {
    updateCountdownOnce();
  }
}

/* Timeline zoom */
function timelineZoomIn(){ timelineSetZoom(timelineZoom + TL_ZOOM_STEP); }
function timelineZoomOut(){ timelineSetZoom(timelineZoom - TL_ZOOM_STEP); }
function timelineZoomReset(){ timelineSetZoom(1); }
function timelineSetZoom(z){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;
  const prevCenterRatio = (scroller.scrollLeft + scroller.clientWidth/2) / Math.max(1, scroller.scrollWidth);
  timelineZoom = Math.max(TL_ZOOM_MIN, Math.min(TL_ZOOM_MAX, z));
  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
  renderTimeline();
  scroller.scrollLeft = prevCenterRatio * scroller.scrollWidth - scroller.clientWidth/2;
}

/* ===== LOAD MODAL (single fullscreen) ===== */
function openLoadModal(mode='arr'){
  const b = document.getElementById('loadBackdrop');
  const m = document.getElementById('loadModal');
  if(b) b.style.display = '';
  if(m) m.style.display = 'flex';
  switchLoadPanel(mode);
}

function closeLoadModal(){
  const b = document.getElementById('loadBackdrop');
  const m = document.getElementById('loadModal');
  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}

function switchLoadPanel(mode){
  const pArr   = document.getElementById('lmPanelArr');
  const pExp   = document.getElementById('lmPanelExp');
  const pFinal = document.getElementById('lmPanelFinal');

  const tArr   = document.getElementById('lmTabArr');
  const tExp   = document.getElementById('lmTabExp');
  const tFinal = document.getElementById('lmTabFinal');

  if(pArr)   pArr.style.display   = (mode==='arr')   ? '' : 'none';
  if(pExp)   pExp.style.display   = (mode==='exp')   ? '' : 'none';
  if(pFinal) pFinal.style.display = (mode==='final') ? '' : 'none';

  if(tArr)   tArr.classList.toggle('is-active', mode==='arr');
  if(tExp)   tExp.classList.toggle('is-active', mode==='exp');
  if(tFinal) tFinal.classList.toggle('is-active', mode==='final');

  const hint = document.getElementById('lmHint');
  if(hint){
    if(mode==='arr') hint.textContent = 'ARRIVÉE';
    if(mode==='exp') hint.textContent = 'EXPLOITATION';
    if(mode==='final') hint.textContent = 'FINAL';
  }

  if(mode === 'final') updateFinalTOB();
  updateHeaderOffset();
}

/* ===== LDM modal ===== */
function openLDM(){
  const b = document.getElementById('ldmBackdrop');
  const m = document.getElementById('ldmModal');
  if(b) b.style.display = '';
  if(m) m.style.display = 'flex';
  updateFinalTOB();
  updateHeaderOffset();
}
function closeLDM(){
  const b = document.getElementById('ldmBackdrop');
  const m = document.getElementById('ldmModal');
  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}

/* compat : tes anciens boutons LOAD ARR/EXP/FINAL */
function hideAllLoadPopovers(){ closeLDM(); }
function toggleLoadArr(){ openLDM(); }
function toggleLoadExp(){ openLDM(); }
function toggleLoadFinal(){ openLDM(); }

document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeLDM();
});

/* ===== FINAL : calcul ADULT + TOB + contrôle OA/OB/OC/OD ===== */
function asInt(id){
  const v = (document.getElementById(id)?.value || '').trim();
  if(v === '') return null;
  const n = parseInt(v,10);
  return isNaN(n) ? null : n;
}
function syncAdultIfNeeded(){
  const m = asInt('FinalMALE');
  const f = asInt('FinalFEMALE');
  const adultEl = document.getElementById('FinalADULT');
  if(!adultEl) return;

  if(m != null && f != null){
    adultEl.value = String(m + f);
    adultEl.readOnly = true;
  }else{
    adultEl.readOnly = false;
  }
}
function setTOBValidity(isValid){
  const tobEl = document.getElementById('FinalTOB');
  if(!tobEl) return;
  tobEl.classList.toggle('is-invalid', !isValid);
  tobEl.classList.toggle('is-valid', isValid);
}
function updateFinalTOB(){
  syncAdultIfNeeded();

  const m = asInt('FinalMALE');
  const f = asInt('FinalFEMALE');
  const a = asInt('FinalADULT');
  const c = asInt('FinalCHILD')  ?? 0;
  const i = asInt('FinalINFANT') ?? 0;

  let main = null; // TOB sans infant
  if(m != null && f != null) main = (m + f) + c;
  else if(a != null) main = a + c;

  const tobEl = document.getElementById('FinalTOB');
  if(!tobEl) return;

  if(main == null){
    tobEl.value = '';
    setTOBValidity(true);
    return;
  }

  tobEl.value = `${main} + ${i}`;

  const oa = asInt('FinalOA') ?? 0;
  const ob = asInt('FinalOB') ?? 0;
  const oc = asInt('FinalOC') ?? 0;
  const od = asInt('FinalOD') ?? 0;
  const sum = oa + ob + oc + od;

  setTOBValidity(sum === main);
}

function refreshUIForTabs(){
  const tabsLS = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  const hasTab = Array.isArray(tabsLS) && tabsLS.length > 0;

  document.body.classList.toggle('has-tab', hasTab);
  document.body.classList.toggle('no-tab', !hasTab);

  if(!hasTab){
    currentTabId = null;
    hideAllLoadPopovers();
    closeAKPicker();
    stopCountdown(true);
  }
}

/* INIT */
function initForm(){
  renderTabs();
  refreshUIForTabs();

  const lastTab = localStorage.getItem('lastTabId') || '';
  const tabsLS  = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  const tabs = Array.isArray(tabsLS) ? tabsLS : [];

  if(tabs.length > 0){
    if(lastTab && tabs.includes(lastTab)){
      switchTab(lastTab);
    }else{
      switchTab(tabs[0]);
    }
  }else{
    // Aucune fiche par défaut
    currentTabId = null;
    stopCountdown();
  }

  generateTimingFields();
  attachAutoSave();
  window.addEventListener('beforeunload', saveCurrentTabData);

  document.getElementById('Parking')?.addEventListener('change', updateTabLabelInstant);
  document.getElementById('Cie')?.addEventListener('change', ()=>{
    updateTabLabelInstant();
    updateAllCalculations();
  });
  document.getElementById('NVol')?.addEventListener('input', updateTabLabelInstant);
  document.getElementById('To')?.addEventListener('input', updateTabLabelInstant);

  setupUppercaseInputs(['NVol','From','To','Immat','BorderControl']);

  const storedDark = (localStorage.getItem('modeDark')||'0') === '1';
  const storedUTC  = (localStorage.getItem('modeUTC')||'0') === '1';
  setDarkMode(storedDark, true);
  setTimeModeUTC(storedUTC, true);

  [
    'AIBT','SOBT','SIBT','AOBT','CTOT','ArrPNT','ArrPNC','TypeAvion',
    'LoadPAX','LoadBAGS','LoadPOIDS',
    'ExpPAX','ExpBAGS','ExpPOIDS',
    'FinalMALE','FinalFEMALE','FinalADULT','FinalCHILD','FinalINFANT',
    'FinalOA','FinalOB','FinalOC','FinalOD',
    'FinalBAGS','FinalPOIDS','FinalGB'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', ()=>{
      updateAllCalculations();
      updateFinalTOB();
    });
  });

  [
    'LoadBAGS','LoadH1','LoadH2','LoadH3','LoadH4',
    'ExpBAGS','ExpH1','ExpH2','ExpH3','ExpH4',
    'FinalBAGS','FinalH1','FinalH2','FinalH3','FinalH4',
    'FinalGB'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', updateAllCalculations);
  });

  const scroller = document.getElementById('timelineScroll');
  if(scroller){
    let isDown=false, startX=0, startLeft=0;
    scroller.addEventListener('mousedown', e=>{
      isDown=true; startX=e.clientX; startLeft=scroller.scrollLeft;
    });
    scroller.addEventListener('mouseleave', ()=>{ isDown=false; });
    scroller.addEventListener('mouseup', ()=>{ isDown=false; });
    scroller.addEventListener('mousemove', e=>{
      if(!isDown) return;
      const dx = e.clientX - startX;
      scroller.scrollLeft = startLeft - dx;
      e.preventDefault();
    });
    ['wheel','mousedown','touchstart','keydown','scroll'].forEach(ev=>{
      scroller.addEventListener(ev, ()=>{ timelineUserScrolled = true; }, {passive:true});
    });
  }

  setDefaultDateToTodayIfEmpty();

  updateHeaderOffset();
  window.addEventListener('resize', ()=>{
    updateHeaderOffset();
    renderTimeline();
  });

  renderTimeline();
  refreshUIForTabs();
  updateFinalTOB();
}

function updateInfoStrip(){
  const v = id => (document.getElementById(id)?.value || '').toUpperCase().trim();
  const set = (id, txt, def='----') => {
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (txt && String(txt).trim()) ? String(txt).trim() : def;
  };

  // ----- vols ARR/DEP depuis AK (prioritaire) -----
  let arrFF = '';
  let depFF = '';

  try{
    if(currentTabId){ // ✅ PAS window.currentTabId
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      arrFF = (data?.akMeta?.arrFF || '').toUpperCase().trim();
      depFF = (data?.akMeta?.depFF || '').toUpperCase().trim();
    }
  }catch(e){}

  // fallback manuel : DEP = CIE+N°
  if(!depFF){
    const cie  = v('Cie');
    const nvol = v('NVol');
    if(cie || nvol) depFF = `${cie}${nvol}`;
  }

  set('kvArrVol', arrFF || '—', '—');
  set('kvDepVol', depFF || '—', '—');

  set('kvFrom', v('From') || '---', '---');
  set('kvTo',   v('To')   || '---', '---');

  set('kvImmat', v('Immat') || '------', '------');
  set('kvType',  v('TypeAvion') || '----', '----');
  set('kvBC',    v('BorderControl') || '--', '--');
  set('kvPark',  v('Parking') || '--', '--');
}

// branche sur ton updateAllCalculations existant
const _oldUpdateAll = updateAllCalculations;
updateAllCalculations = function(){
  _oldUpdateAll();
  updateInfoStrip();
};

/* date défaut */
function setDefaultDateToTodayIfEmpty(){
  const d = document.getElementById('Date');
  if(d && !d.value){ d.valueAsDate = new Date(); }
}

/* uppercase */
function setupUppercaseInputs(ids){
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const toUpper = ()=>{ el.value = (el.value||'').toUpperCase(); };
    el.addEventListener('input', toUpper);
    el.addEventListener('blur', toUpper);
  });
}

/* Autosave */
function attachAutoSave(){
  const handler=()=>{
    clearTimeout(saveTimer);
    saveTimer=setTimeout(()=>{
      saveCurrentTabData();
      renderTimeline();
      updateHeaderOffset();
    }, 300);
  };
  document.addEventListener('input', handler, true);
  document.addEventListener('change', handler, true);
}

/* Tabs */
function renderTabs(){
  const tabBar = document.getElementById('tab-bar');
  if(!tabBar) return;

  tabBar.innerHTML = `
    <button class="button is-success is-light" type="button" onclick="createNewTab()">
      + Ajouter vol
    </button>
    <button class="button is-link is-light" type="button"
            onclick="createNewTab(); openAKPicker();">
      + Liste vols
    </button>
  `;

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  tabs.forEach((id)=>{
    const data = JSON.parse(localStorage.getItem('tab-'+id) || '{}');

    const cie  = (data.Cie  || '').toUpperCase();
    const nvol = (data.NVol || '').toUpperCase();
    const to   = (data.To   || '').toUpperCase();

    let left = `${cie}${nvol}`.trim();
    let label =
      left || to
        ? (to ? `${left} | ${to}`.trim() : left)
        : 'VOL';

    const wrap = document.createElement('span');
    wrap.className = 'tab-wrap';

    // bouton onglet (switch)
    const btn = document.createElement('button');
    btn.className = `button ${id === currentTabId ? 'is-link' : 'is-light'}`;
    btn.textContent = label || 'VOL';
    btn.onclick = ()=> switchTab(id);
    btn.ondblclick = ()=> deleteTab(id);

    // bouton refresh ↻ (sans switch)
    const r = document.createElement('button');
    r.className = 'button is-light tab-refresh';
    r.type = 'button';
    r.title = 'Rafraîchir depuis AK';
    r.innerHTML = '↻';
    r.onclick = async (e)=>{
      e.preventDefault();
      e.stopPropagation();

      r.classList.add('is-loading');
      try{
        await refreshAKTab(id);
      }finally{
        r.classList.remove('is-loading');
      }
    };

    // optionnel : griser si pas de akMeta
    if(!data.akMeta){
      r.disabled = true;
      r.title = "Pas de vol AK associé";
      r.style.opacity = '0.45';
      r.style.cursor = 'not-allowed';
    }

    wrap.appendChild(btn);
    wrap.appendChild(r);
    tabBar.appendChild(wrap);
  });

  updateHeaderOffset();
}

function createNewTab(){
  const id = String(Date.now());

  // ajoute l'onglet dans la liste
  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];
  if(!tabs.includes(id)) tabs.push(id);
  localStorage.setItem('flightTabs', JSON.stringify(tabs));

  currentTabId = id;
  localStorage.setItem('lastTabId', id);

  clearFormFields();            // reset champs
  
  // snapshot initial
  const data = {};
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;
    data[el.id] = (el.type === 'checkbox') ? (el.checked ? '1' : '0') : (el.value || '');
  });
  data.infovolOpen = '0';

  localStorage.setItem('tab-'+id, JSON.stringify(data));

  renderTabs();
  refreshUIForTabs();
  updateInfoStrip();
  renderTimeline();
}

function switchTab(id){
  stopCountdown();
  saveCurrentTabData();

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  id = String(id);
  if(!tabs.includes(id)) return;

  currentTabId = id;
  localStorage.setItem('lastTabId', id);

  loadTabData(id);

  renderTabs();
  refreshUIForTabs();
  renderTimeline();
}

function deleteTab(id){
  stopCountdown();
  if(!confirm('Supprimer cette fiche ?')) return;

  id = String(id);

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  const idx = tabs.indexOf(id);
  if(idx === -1) return;

  tabs.splice(idx, 1);
  localStorage.setItem('flightTabs', JSON.stringify(tabs));
  localStorage.removeItem('tab-' + id);

  if(tabs.length > 0){
    const nextId = tabs[Math.max(0, idx - 1)];
    currentTabId = nextId;
    localStorage.setItem('lastTabId', nextId);
    loadTabData(nextId);
  }else{
    localStorage.removeItem('lastTabId');
    currentTabId = null;
    clearFormFields();
    stopCountdown(true);
  }

  renderTabs();
  refreshUIForTabs();
  renderTimeline();
  updateInfoStrip();
}

function clearFormFields(){
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;

    if(el.type === 'checkbox'){
      el.checked = false;
    }else{
      el.value = '';
    }
  });

  // date du jour auto
  const d = document.getElementById('Date');
  if(d){
    const today = new Date().toISOString().slice(0,10);
    d.value = today;
  }

  updateAllCalculations();
  updateTabLabelInstant();
}
function saveCurrentTabData(){
  if(!currentTabId) return;

  // ✅ on part des données existantes pour ne pas perdre akMeta
  let data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');

  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;
    if(el.type==='checkbox') data[el.id]=el.checked ? '1':'0';
    else data[el.id]=el.value;
  });

  data.modeDark=document.body.classList.contains('dark')?'1':'0';
  data.modeUTC=isUTC?'1':'0';

  data.timer_h40=document.getElementById('timer-h40')?.textContent || '--:--';
  data.timer_h15=document.getElementById('timer-h15')?.textContent || '--:--';
  data.timer_h8=document.getElementById('timer-h8')?.textContent || '--:--';
  data.timer_tobt=document.getElementById('timer-tobt')?.textContent || '--:--';
  data.timer_cd=document.getElementById('timer-cd')?.textContent || '--:--';

  data.timingPanel = localStorage.getItem('timingPanel') || 'dep';

  localStorage.setItem('tab-'+currentTabId,JSON.stringify(data));
  localStorage.setItem('lastTabId',currentTabId);
  renderTabs();
}

function loadTabData(id){
  currentTabId = String(id);

  const raw = localStorage.getItem('tab-'+currentTabId);
  if(!raw) return;

  const data = JSON.parse(raw);

  // recharge champs
  for(const k in data){
    const el = document.getElementById(k);
    if(!el) continue;

    if(el.type === 'checkbox'){
      el.checked = (data[k] === true || data[k] === '1');
    }else{
      el.value = data[k];
    }
  }

  updateAllCalculations();
  updateHeaderOffset();
  updateInfoStrip();
}

function updateTabLabelInstant(){ saveCurrentTabData(); renderTabs(); }

/* TIMING FIELDS – ARR / DEP (responsive pro) */
function generateTimingFields(){
  const container = document.getElementById('timing-grid');
  if(!container) return;

  const fieldHTML = (id,label,full=false)=>`
    <div class="${full ? 'span-12' : 'span-6'}">
      <div class="field">
        <label class="label">${label}</label>
        <div class="control">
          <input class="input" type="time" id="${id}" onchange="updateAllCalculations()">
        </div>
        <div class="btn-actions">
          <button class="button is-dark is-light" type="button"
            onclick="adjustTime('${id}',-1);updateAllCalculations()">-1</button>
          <button class="button is-link" type="button"
            onclick="setNow('${id}');updateAllCalculations()">Now</button>
          <button class="button is-dark is-light" type="button"
            onclick="adjustTime('${id}',1);updateAllCalculations()">+1</button>
        </div>
      </div>
    </div>`;

  /* ===== ARRIVÉE ===== */
  const arrNoHeader = `
    <div class="card mb-4">
      <div class="card-content">
        <div class="grid-auto">
          ${fieldHTML('ArriveeFuel','Arrivée Avitair',true)}
          ${fieldHTML('PremierDebarque','Premier débarqué')}
          ${fieldHTML('DernierDebarque','Dernier débarqué')}
          ${fieldHTML('ArriveeLiftArr','Arrivée lift')}
          ${fieldHTML('DepartLiftArr','Départ lift')}
        </div>
      </div>
    </div>`;

  /* ===== DÉPART ===== */
  const depNoHeader = `
    <div class="card">
      <div class="card-content">
        <div class="grid-auto">
          ${fieldHTML('ArrPNT','Arrivée PNT')}
          ${fieldHTML('ArrPNC','Arrivée PNC')}
          ${fieldHTML('AvionPremierEmbarque','Premier embarqué')}
          ${fieldHTML('AvionDernierEmbarque','Dernier embarqué')}
          ${fieldHTML('ArriveeLift','Arrivée lift')}
          ${fieldHTML('DepartLift','Départ lift')}

          <!-- Départ Avitair + Arrivée INAD sur la même ligne -->
          <div class="span-12">
            <div class="grid-auto">
              <div class="span-6">
                ${fieldHTML('DepartFuel','Départ Avitair')}
              </div>
              <div class="span-6">
                ${fieldHTML('ArriveeINAD','Arrivée INAD')}
              </div>
            </div>
          </div>

          ${fieldHTML('RemiseLID','Remise LID/LDS')}
          ${fieldHTML('FermeturePorteAvion','Fermeture porte avion')}
        </div>
      </div>
    </div>`;

  const toggle = `
    <div class="tabs is-toggle is-toggle-rounded is-centered mb-4">
      <ul>
        <li id="seg-arr-li"><a onclick="switchTimingPanel('arr')"><span>Arrivée</span></a></li>
        <li id="seg-dep-li"><a onclick="switchTimingPanel('dep')"><span>Départ</span></a></li>
      </ul>
    </div>`;

  container.innerHTML =
    toggle +
    `<div id="panel-arr" style="display:none;">${arrNoHeader}</div>` +
    `<div id="panel-dep" style="display:none;">${depNoHeader}</div>`;

  const saved = localStorage.getItem('timingPanel') || 'dep';
  switchTimingPanel(saved);
}

function switchTimingPanel(mode){
  const arrPanel=document.getElementById('panel-arr');
  const depPanel=document.getElementById('panel-dep');
  const liArr=document.getElementById('seg-arr-li');
  const liDep=document.getElementById('seg-dep-li');

  if(arrPanel) arrPanel.style.display = (mode==='arr') ? '' : 'none';
  if(depPanel) depPanel.style.display = (mode==='dep') ? '' : 'none';

  if(liArr) liArr.classList.toggle('is-active', mode==='arr');
  if(liDep) liDep.classList.toggle('is-active', mode!=='arr');

  localStorage.setItem('timingPanel', mode);
}

/* LID visible FR/RK */
function updateLIDVisibility(){
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const lid = document.getElementById('lidBlock');
  if(!lid) return;
  lid.style.display = (cie === 'FR' || cie === 'RK') ? '' : 'none';
  updateHeaderOffset();
}

/* CALCULS */
function updateAllCalculations() {
  updateTimers();
  updateSOBTDefault();
  updateTOBT();
  updateDLCode();
  redistributeDL();
  updateLID();
  updateLIDVisibility();

  updateHBagsValidity('arr');
  updateHBagsValidity('exp');
  updateHBagsValidity('final');

  updateArrExpWeightIfNeeded();
  updateFinalWeightIfNeeded();

  ensureCountdownRunning();
  renderTimeline();
  updateHeaderOffset();

  updateInfoStrip();
}

/* TIMERS HLE/H-15 */
function updateTimers() {
  const sobt = document.getElementById('SOBT')?.value || '';
  if (!sobt) {
    ['timer-h40', 'timer-h15', 'timer-h8'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.textContent = '--:--';
    });
    return;
  }
  const [hh, mm] = sobt.split(':').map(Number);
  const base = new Date(); base.setHours(hh, mm, 0, 0);
  const h40 = new Date(base.getTime() - 40 * 60000);
  const h15 = new Date(base.getTime() - 15 * 60000);
  document.getElementById('timer-h40').textContent = `${String(h40.getHours()).padStart(2, '0')}:${String(h40.getMinutes()).padStart(2, '0')}`;
  document.getElementById('timer-h15').textContent = `${String(h15.getHours()).padStart(2, '0')}:${String(h15.getMinutes()).padStart(2, '0')}`;
}

/* LID = TOBT - 8 */
function updateLID() {
  const tobtRawMins = window._tobtRawMins;
  const el = document.getElementById('timer-h8');
  if (!el) return;
  if (tobtRawMins == null) { el.textContent = "--:--"; return; }
  el.textContent = fmtHHMM(tobtRawMins - 8);
}

function updateSOBTDefault() {
  const sobtEl = document.getElementById('SOBT');
  if(!sobtEl) return;

  // Si SOBT déjà remplie (ex : import Keeper), on ne touche pas
  if ((sobtEl.value || '').trim() !== '') return;

  const cie = (document.getElementById('Cie').value||'').toUpperCase();

  // FR / RK : SOBT vient de Keeper
  if(cie === "FR" || cie === "RK"){
    return;
  }

  const sibt = document.getElementById('SIBT')?.value || '';
  const arrPNT = document.getElementById('ArrPNT')?.value || '';
  const arrPNC = document.getElementById('ArrPNC')?.value || '';
  if (!sibt) return;
  if (!(cie === "W4" || cie === "W6")) return;

  let [sH, sM] = sibt.split(':').map(Number);
  const base = new Date(); base.setHours(sH, sM);

  const add = (document.getElementById('TypeAvion')?.value === 'A321') ? 35 : 30;
  const sobtCalc = new Date(base.getTime() + add * 60000);

  sobtEl.value =
    `${String(sobtCalc.getHours()).padStart(2,'0')}:${String(sobtCalc.getMinutes()).padStart(2,'0')}`;
}

/* TOBT + règle CTOT */
function updateTOBT() {
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const sibttxt = document.getElementById('SIBT')?.value || '';
  const aibttxt = document.getElementById('AIBT')?.value || '';
  const sobttxt = document.getElementById('SOBT')?.value || '';
  const ctottxt = document.getElementById('CTOT')?.value || '';

  if (!cie || !sibttxt || !sobttxt) {
    document.getElementById('timer-tobt').textContent = '--:--';
    window._tobtRawMins = null;
    window._tobtAdjMins = null;
    return;
  }

  const [sH, sM] = sibttxt.split(':').map(Number);
  const [aH, aM] = aibttxt ? aibttxt.split(':').map(Number) : [sH, sM];
  const [soH, soM] = sobttxt.split(':').map(Number);

  const SIBT = new Date(); SIBT.setHours(sH, sM, 0, 0);
  const AIBT = new Date(); AIBT.setHours(aH, aM, 0, 0);
  const SOBT = new Date(); SOBT.setHours(soH, soM, 0, 0);

  const isDelayed = (aibttxt && (AIBT > SIBT));
  const crewChange = !!(document.getElementById('ArrPNT')?.value || document.getElementById('ArrPNC')?.value);
  const addMin = (d, m)=> new Date(d.getTime() + m*60000);

  let TOBT_raw;

  if (cie === 'FR' || cie === 'RK') {
    if (!isDelayed) TOBT_raw = new Date(SOBT);
    else {
      const turn = crewChange ? 35 : 25;
      const candidate = addMin(AIBT, turn);
      TOBT_raw = (candidate <= SOBT) ? new Date(SOBT) : candidate;
    }
  } else if (cie === 'W4' || cie === 'W6') {
    if (!isDelayed) TOBT_raw = new Date(SOBT);
    else {
      const type = (document.getElementById('TypeAvion')?.value || '').toUpperCase();
      const turn = (type === 'A321') ? 35 : 30;
      const candidate = addMin(AIBT, turn);
      TOBT_raw = (candidate <= SOBT) ? new Date(SOBT) : candidate;
    }
  } else {
    if (aibttxt && AIBT > SIBT) {
      const diff = (SOBT - SIBT) / 60000;
      TOBT_raw = new Date(AIBT.getTime() + diff * 60000);
    } else TOBT_raw = new Date(SOBT);
  }

  if (TOBT_raw < SOBT) TOBT_raw = new Date(SOBT);
  window._tobtRawMins = TOBT_raw.getHours() * 60 + TOBT_raw.getMinutes();

  let TOBT_adj = new Date(TOBT_raw);
  if (ctottxt) {
    const [cH, cM] = ctottxt.split(':').map(Number);
    const CTOT = new Date(); CTOT.setHours(cH, cM, 0, 0);
    const tobtPlus15 = new Date(TOBT_adj.getTime() + 15*60000);
    if (CTOT > tobtPlus15) TOBT_adj = new Date(CTOT.getTime() - 15*60000);
    if (TOBT_adj < SOBT) TOBT_adj = new Date(SOBT);
  }

  window._tobtAdjMins = TOBT_adj.getHours() * 60 + TOBT_adj.getMinutes();

  document.getElementById('timer-tobt').textContent =
    `${String(TOBT_adj.getHours()).padStart(2, '0')}:${String(TOBT_adj.getMinutes()).padStart(2, '0')}`;
}

/* DL CODES */
function updateDLCode() {
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const sibttxt = document.getElementById('SIBT')?.value || '';
  const aibttxt = document.getElementById('AIBT')?.value || '';
  if (!sibttxt || !aibttxt) return;

  const [sH, sM] = sibttxt.split(':').map(Number);
  const [aH, aM] = aibttxt.split(':').map(Number);
  const SIBT = new Date(); SIBT.setHours(sH, sM);
  const AIBT = new Date(); AIBT.setHours(aH, aM);

  if (AIBT > SIBT) {
    if (cie === 'FR' || cie === 'RK') document.getElementById('DLcode1').value = '93';
    else if (cie === 'W4' || cie === 'W6') document.getElementById('DLcode1').value = '93A';
    else document.getElementById('DLcode1').value = '';
    document.getElementById('DLduree1').value = Math.round((AIBT - SIBT) / 60000) || '';
  } else {
    document.getElementById('DLcode1').value = '';
    document.getElementById('DLduree1').value = '';
  }
}

/* DL redistribution */
function dldChanged(index){ lastDLChanged = index; redistributeDL(); }
function totalDelayMinutes(){
  const so = document.getElementById('SOBT')?.value || '';
  const ao = document.getElementById('AOBT')?.value || '';
  if(!so || !ao) return null;
  const s = parseHHMM(so);
  const a = parseHHMM(ao);
  if (s==null || a==null) return null;
  let total = a - s;
  if (total < 0) total += 1440;
  return total;
}
function redistributeDL(){
  const total = totalDelayMinutes();
  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  if(!f1 || !f2 || !f3) return;

  let d1 = parseInt(f1.value)||0;
  let d2 = parseInt(f2.value)||0;
  let d3 = parseInt(f3.value)||0;

  if(total==null){ clearDLBorders(); return; }

  d1 = Math.max(0, Math.min(d1, total));

  if(lastDLChanged === 1){
    let remain = total - d1;
    d2 = Math.min(remain, Math.max(0, d2));
    d2 = Math.min(remain, d2 + (remain - d2));
    remain = total - d1 - d2;
    d3 = Math.max(0, remain);
  } else if (lastDLChanged === 2){
    const maxD2 = Math.max(0, total - d1);
    d2 = Math.max(0, Math.min(d2, maxD2));
    d3 = Math.max(0, total - d1 - d2);
  } else {
    const maxD3 = Math.max(0, total - d1 - d2);
    d3 = Math.max(0, Math.min(d3, maxD3));
  }

  f1.value = d1 || '';
  f2.value = d2 || '';
  f3.value = d3 || '';

  const sum = d1 + d2 + d3;
  if (sum > total) markLastFilledDLError();
  else clearDLBorders();
}
function markLastFilledDLError(){
  clearDLBorders();
  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  const d1 = parseInt(f1.value)||0;
  const d2 = parseInt(f2.value)||0;
  const d3 = parseInt(f3.value)||0;
  if (d3 > 0) f3.classList.add('dl-error');
  else if (d2 > 0) f2.classList.add('dl-error');
  else if (d1 > 0) f1.classList.add('dl-error');
}
function clearDLBorders(){
  ['DLduree1','DLduree2','DLduree3'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove('dl-error');
  });
}

/* Utils time */
function setNow(fieldId) {
  const now = new Date();
  const hh = isUTC ? now.getUTCHours() : now.getHours();
  const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
  document.getElementById(fieldId).value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}
function adjustTime(fieldId, delta) {
  const input = document.getElementById(fieldId);
  if (!input || !input.value) return;
  let [hh, mm] = input.value.split(':').map(Number);
  let total = hh * 60 + mm + delta;
  if (total < 0) total += 1440;
  if (total >= 1440) total -= 1440;
  hh = Math.floor(total / 60);
  mm = total % 60;
  input.value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

/* Switches */
function setDarkMode(enable, fromInit=false){
  const currentlyDark = document.body.classList.contains('dark');

  if (enable && !currentlyDark) document.body.classList.add('dark');
  if (!enable && currentlyDark) document.body.classList.remove('dark');

  // ✅ applique aussi sur <html> pour les variables CSS
  document.documentElement.classList.toggle('dark', enable);

  const dt = document.getElementById('darkToggle');
  if(dt) dt.checked = enable;

  const darkLabel = document.getElementById('darkLabel');
  if(darkLabel) darkLabel.textContent = enable ? 'Sombre' : 'Clair';

  localStorage.setItem('modeDark', enable ? '1' : '0');

  updateHeaderOffset();
  renderTimeline();
}

function setTimeModeUTC(enable, fromInit=false){
  const offsetHours = -new Date().getTimezoneOffset() / 60;

  if (!fromInit && enable !== isUTC) {
    const inputs = document.querySelectorAll('input[type="time"]');
    inputs.forEach(input => {
      if (!input.value) return;
      let [hh, mm] = input.value.split(':').map(Number);
      let newH = enable ? hh - offsetHours : hh + offsetHours;
      let totalMin = Math.round(newH * 60 + mm);
      totalMin = ((totalMin % 1440) + 1440) % 1440;
      const outH = Math.floor(totalMin / 60);
      const outM = totalMin % 60;
      input.value = `${String(outH).padStart(2, '0')}:${String(outM).padStart(2, '0')}`;
    });
  }

  isUTC = enable;

  const ut = document.getElementById('utcToggle');
  if(ut) ut.checked = enable;

  const tzLabel = document.getElementById('tzLabel');
  if(tzLabel) tzLabel.textContent = enable ? 'UTC' : 'Locale';

  localStorage.setItem('modeUTC', enable ? '1' : '0');

  updateAllCalculations();

  // 🔁 refresh flight list AK si ouverte
  if(document.getElementById('akPopover')?.style.display !== 'none'){
    loadAKFlights();
  }
}

/* Popup */
function showPopup(message, color = "#2563eb", duration = 2000) {
  const popup = document.createElement('div');
  popup.id = "popup";
  popup.textContent = message;
  popup.style.background = color;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), duration);
}

/* Timeline helpers */
let showTimeLabels = true;
let timelineUserScrolled = false;

function parseHHMM(str){
  if(!str || !/^\d{2}:\d{2}$/.test(str)) return null;
  const [h,m] = str.split(':').map(Number);
  return h*60 + m;
}
function fmtHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  const h = Math.floor(mins/60), m = mins%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function toExtended(t, min, max){
  const wraps = (max > 1440);
  if (!wraps) return t;
  const startMod = ((min % 1440) + 1440) % 1440;
  return (t < startMod) ? t + 1440 : t;
}
function computeTimelineWindow(allTimes){
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));
  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');

  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM(document.getElementById('CTOT')?.value || '');

  const starts = [H40, SIBT, AIBT].filter(v => v != null);
  const ends   = [SOBT, AOBT, TOBT, CTOT].filter(v => v != null);

  if(starts.length && ends.length){
    let startRef = Math.min(...starts);
    let endRef   = Math.max(...ends);

    if(endRef <= startRef) endRef += 1440;

    let min = startRef - 5;
    let max = endRef + 5;

    if(max - min < 30){ min -= 10; max += 10; }

    return { min, max };
  }

  if(allTimes && allTimes.length){
    let min = Math.min(...allTimes) - 10;
    let max = Math.max(...allTimes) + 10;
    if(max <= min) max += 1440;
    if(max - min < 30){ min -= 10; max += 10; }
    return {min, max};
  }

  return {min:0, max:60};
}
function getPairWindow(idA,idB){
  const a = parseHHMM(document.getElementById(idA)?.value || '');
  const b = parseHHMM(document.getElementById(idB)?.value || '');
  if(a==null || b==null) return null;
  return [Math.min(a,b), Math.max(a,b)];
}
function collectTimelineData(){
  const fixedPoints = [];
  const addPoint = (label, t, cls='tl--std')=>{ if(t==null) return; fixedPoints.push({label, t, cls}); };

  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');
  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM(document.getElementById('CTOT')?.value || '');
  const H15  = parseHHMM((document.getElementById('timer-h15')?.textContent || '').replace('--:--',''));
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));

  addPoint('SIBT', SIBT, 'tl--std'); addPoint('AIBT', AIBT, 'tl--std');
  addPoint('SOBT', SOBT, 'tl--std'); addPoint('AOBT', AOBT, 'tl--std');
  addPoint('TOBT', TOBT, 'tl--tobt'); addPoint('CTOT', CTOT, 'tl--ctot');
  addPoint('HLE',  H40,  'tl--turn');
  addPoint('H-15', H15,  'tl--turn');

  const singles = [
    ['ArrPNT','Arrivée PNT'],
    ['ArrPNC','Arrivée PNC'],
    ['FermeturePorteAvion','Fermeture porte avion'],
  ];
  singles.forEach(([id,label])=>{
    const t = parseHHMM(document.getElementById(id)?.value || '');
    if(t!=null) fixedPoints.push({label, t, cls:'tl--std'});
  });

  const rows = [
    {label:'Débarquement', pair:getPairWindow('PremierDebarque','DernierDebarque'), cls:'tl--turn', color:null},
    {label:'Embarquement', pair:getPairWindow('AvionPremierEmbarque','AvionDernierEmbarque'), cls:'tl--ops',  color:null},
    {label:'Avitair',      pair:getPairWindow('ArriveeFuel','DepartFuel'), cls:'tl--std', color:'#f59e0b'},
    {label:'Lift (Arr)',   pair:getPairWindow('ArriveeLiftArr','DepartLiftArr'), cls:'tl--std', color:'#a855f7'},
    {label:'Lift (Dep)',   pair:getPairWindow('ArriveeLift','DepartLift'), cls:'tl--std', color:'#16a34a'},
  ];

  const durations = rows
    .filter(r=>r.pair!=null)
    .map(r=>({label:r.label, a:r.pair[0], b:r.pair[1], cls:r.cls, color:r.color}));

  const allTimes = [ ...fixedPoints.map(p=>p.t), ...durations.flatMap(d=>[d.a,d.b]) ];
  const windowInfo = computeTimelineWindow(allTimes);

  return {fixedPoints, durations, windowInfo};
}
function renderTimeline(){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;

  canvas.innerHTML = '';

  const {fixedPoints, durations, windowInfo} = collectTimelineData();
  const {min, max} = windowInfo;
  if(min === undefined) return;

  window._timelineCurrentRange = {min, max};
  const total = Math.max(1, max - min);

  const viewport = scroller.clientWidth || 1200;
  const canvasPx = Math.max(viewport, Math.round(viewport * timelineZoom));
  canvas.style.width = canvasPx + 'px';

  const MIN_HEIGHT = 180;
  const PT_LANE_H  = 50;
  const DUR_LANE_H = 50;
  const TOP_PAD    = 40;
  const AFTER_POINTS = 28;
  const AFTER_TRACK  = 36;
  const BOTTOM_PAD   = 40;

  const lanesEndX = [];
  const pointEls = [];

  fixedPoints.sort((a,b)=>a.t-b.t).forEach(p=>{
    const tExt = toExtended(p.t, min, max);
    const leftPct = 6 + ((tExt-min)/total)*88;

    const el = document.createElement('div');
    el.className = `tl-event ${p.cls}`;
    el.style.left = `${leftPct}%`;
    el.style.top  = `0px`;
    el.style.visibility = 'hidden';

    const dot = document.createElement('div'); dot.className = 'tl-dot';
    const label = document.createElement('div'); label.className='tl-label';
    label.textContent = showTimeLabels ? `${p.label} : ${fmtHHMM(p.t)}` : p.label;
    el.appendChild(dot); el.appendChild(label);
    canvas.appendChild(el);

    const w = Math.max(label.offsetWidth, 12);
    const centerX = (leftPct/100) * canvasPx;
    const startX = centerX - (w/2) - 16;
    const endX   = centerX + (w/2) + 16;

    let lane = 0;
    while(lanesEndX[lane] !== undefined && startX <= lanesEndX[lane]) lane++;
    lanesEndX[lane] = endX;

    pointEls.push({el, lane});
  });

  const pointLaneCount = lanesEndX.length || 0;
  const trackY = TOP_PAD + pointLaneCount*PT_LANE_H + AFTER_POINTS;

  const durItems = durations.map(d=>{
    const aExt = toExtended(d.a, min, max);
    const bExt = toExtended(d.b, min, max);
    return { ...d, start: Math.min(aExt,bExt), end: Math.max(aExt,bExt) };
  }).sort((x,y)=> x.start - y.start);

  function packLanes(items, pad = 2){
    const lanes = [];
    return items.map(it => {
      let laneIdx = lanes.findIndex(nextFree => it.start >= nextFree);
      if (laneIdx === -1) {
        laneIdx = lanes.length;
        lanes.push(it.end + pad);
      } else {
        lanes[laneIdx] = it.end + pad;
      }
      return { ...it, lane: laneIdx };
    });
  }

  const durWithLane = packLanes(durItems);
  const durLaneCount = Math.max(0, ...durWithLane.map(d => d.lane)) + 1;

  const finalHeight = Math.max(
    MIN_HEIGHT,
    trackY + AFTER_TRACK + durLaneCount*DUR_LANE_H + BOTTOM_PAD
  );
  canvas.style.height = `${finalHeight}px`;

  for(let t = Math.ceil(min); t <= Math.floor(max); t++){
    const x = (t-min)/total;
    const leftPct = 6 + x*88;

    const vline = document.createElement('div');
    vline.className = 'timeline-tick';
    vline.style.left = `${leftPct}%`;
    vline.style.top = `${8}px`;
    vline.style.height = `${finalHeight - 36}px`;
    canvas.appendChild(vline);

    if(t % 5 === 0){
      const lbl = document.createElement('div');
      lbl.className = 'timeline-tick-label';
      lbl.textContent = fmtHHMM(t);
      lbl.style.left = `${leftPct}%`;
      lbl.style.top = `${finalHeight - 18}px`;
      canvas.appendChild(lbl);
    }
  }

  const track = document.createElement('div');
  track.className = 'timeline-track';
  track.style.top = `${trackY}px`;
  canvas.appendChild(track);

  pointEls.forEach(({el,lane})=>{
    el.style.top = `${TOP_PAD + lane*PT_LANE_H}px`;
    el.style.visibility = 'visible';
  });

  const downStart = trackY + AFTER_TRACK;
  durWithLane.forEach(d=>{
    const leftStartPct = 6 + ((d.start-min)/total)*88;
    const widthPct     = ((d.end-d.start)/total)*88;

    const bar = document.createElement('div');
    bar.className = `tl-range ${d.cls}`;
    if(d.color){ bar.style.setProperty('--c', d.color); }
    bar.style.left = `${leftStartPct}%`;
    bar.style.width = `${widthPct}%`;
    bar.style.top = `${downStart + d.lane*DUR_LANE_H}px`;
    bar.style.transform = 'translateX(-50%)';
    canvas.appendChild(bar);

    const lab = document.createElement('div');
    lab.className = 'tl-range-label';
    const durMin = Math.max(0, d.b - d.a);
    lab.textContent = showTimeLabels ? `${d.label} : ${durMin} min` : d.label;
    bar.appendChild(lab);
  });

  if(!timelineUserScrolled){
    const centerMin = (min + max) / 2;
    const midX = (centerMin - min) / total;
    const centerLeft = midX * scroller.scrollWidth - scroller.clientWidth / 2;
    scroller.scrollLeft = Math.max(0, centerLeft);
  }

  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
}
function setVal(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  // si string -> uppercase, sinon valeur brute
  el.value = (typeof v === 'string') ? v.toUpperCase() : (v ?? '');

  // déclenche les listeners
  el.dispatchEvent(new Event('input',  { bubbles:true }));
  el.dispatchEvent(new Event('change', { bubbles:true }));
}

function setTimeFromISO(id, iso){
  if(!iso) return;
  const d = new Date(iso);
  if(isNaN(d.getTime())) return;

  const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
  const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');

  setVal(id, `${hh}:${mm}`);
}

function setIfEmpty(id, v){
  const el = document.getElementById(id);
  if(!el) return;
  if((el.value || '').trim() !== '') return;
  setVal(id, v);
}

function setTimeFromISOIfEmpty(id, iso){
  const el = document.getElementById(id);
  if(!el) return;
  if((el.value || '').trim() !== '') return;
  setTimeFromISO(id, iso);
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function pickBestTimeForList(f, flow){
  const iso = (v)=> v ? new Date(v) : null;

  const toHHMM = (d)=>{
    if(!d || isNaN(d.getTime())) return '';
    const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
    const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  };

  if(flow === 'DEP'){
    return toHHMM(
      iso(f.aobt) || iso(f.sobt) || iso(f.eobt) || iso(f.atot) || iso(f.etot)
    );
  }

  return toHHMM(
    iso(f.aibt) || iso(f.sibt) || iso(f.eibt) || iso(f.aldt) || iso(f.eldt)
  );
}

  /* ===== SETTINGS MENU ===== */
function openSettingsMenu(){
  const b = document.getElementById('settingsBackdrop');
  const m = document.getElementById('settingsMenu');
  if(b) b.style.display = '';
  if(m) m.style.display = 'block';
}
function closeSettingsMenu(){
  const b = document.getElementById('settingsBackdrop');
  const m = document.getElementById('settingsMenu');
  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}
function toggleSettingsMenu(){
  const m = document.getElementById('settingsMenu');
  const isOpen = m && m.style.display !== 'none' && m.style.display !== '';
  if(isOpen) closeSettingsMenu();
  else openSettingsMenu();
}

// ESC ferme aussi le menu settings
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeSettingsMenu();
});

// ===== Airport Keeper (AK) =====
const AK_TOKEN = "Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJidmFfZXh0IiwidXNlcm5hbWUiOiJidmFfZXh0IiwiYWlycG9ydHMiOiJMRk9CIn0.PkSbBw_BF5dnX0bG3gbP7E7P7SHhW9egJ_in6OaWTnJm0OpirhJP4FZzbztH0r6lQxrA5JliEopo7__CyYvfIA";
const AK_BASE    = "https://api.app.airport-keeper.com/flights/v1/airport";
const AK_AIRPORT = "LFOB";
const HOME_IATA  = "BVA";

// Ouvrir/Fermer
function openAKPicker(){
  const b = document.getElementById('akBackdrop');
  const p = document.getElementById('akPopover');
  const flowSel = document.getElementById('akFlow');

  if(flowSel) flowSel.value = 'DEP';   // <-- reset ici

  if(b) b.style.display = '';
  if(p) p.style.display = 'flex';
  loadAKFlights();
}

function closeAKPicker(){
  const b = document.getElementById('akBackdrop');
  const p = document.getElementById('akPopover');
  if(p) p.style.display = 'none';
  if(b) b.style.display = 'none';
}

async function fetchAK(flow, from, to){
  const url = `${AK_BASE}?airport=${encodeURIComponent(AK_AIRPORT)}&flow=${encodeURIComponent(flow)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
  const res = await fetch(url, { headers: { Authorization: AK_TOKEN }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  return Array.isArray(data?.flights) ? data.flights : [];
}

// ===== Temps + linking (immat) =====
function arrTimeMs(f){
  return Date.parse(f?.aibt || f?.sibt || f?.eibt || '') || null;
}
function depTimeMs(f){
  // IMPORTANT: AOBT d'abord (sinon tu matches n'importe quoi)
  return Date.parse(f?.aobt || f?.sobt || f?.eobt || '') || null;
}
function sameLocalDay(a, b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

// premier DEP après ARR (le plus proche)
function findLinkedDepForArr(arr){
  const reg = (arr?.reg || '').toUpperCase().trim();
  if(!reg) return null;

  const arrT = arrTimeMs(arr);
  if(arrT == null) return null;

  const deps = window._akCache?.dep || [];
  let best = null;
  let bestT = Infinity;

  for(const d of deps){
    const r = (d?.reg || '').toUpperCase().trim();
    if(r !== reg) continue;

    const t = depTimeMs(d);
    if(t == null) continue;
    if(t < arrT) continue;

    if(t < bestT){
      best = d;
      bestT = t;
    }
  }
  return best;
}

// dernière ARR avant DEP (la plus proche)
function findLinkedArrForDep(dep){
  const reg = (dep?.reg || '').toUpperCase().trim();
  if(!reg) return null;

  const depT = depTimeMs(dep);
  if(depT == null) return null;

  const arrs = window._akCache?.arr || [];
  let best = null;
  let bestT = -Infinity;

  for(const a of arrs){
    const r = (a?.reg || '').toUpperCase().trim();
    if(r !== reg) continue;

    const t = arrTimeMs(a);
    if(t == null) continue;
    if(t > depT) continue;

    if(t > bestT){
      best = a;
      bestT = t;
    }
  }
  return best;
}

function depAobtTooOld(dep, minutes = 15){
  const aobt = dep?.aobt;
  if(!aobt) return false;
  const t = Date.parse(aobt);
  if(!t) return false;
  return (Date.now() - t) > minutes*60*1000;
}

function depAtotTooOld(dep, minutes = 15){
  // ATOT = info Keeper uniquement (non affichée)
  const iso = dep?.atot || dep?.aobt; // fallback sécurité
  if(!iso) return false;

  const t = Date.parse(iso);
  if(!t) return false;

  return (Date.now() - t) > minutes * 60 * 1000;
}

// ===== Chargement liste (vols du jour) + TRI + SUPPRESSION ATOT+15 =====
async function loadAKFlights(){
  const flow = document.getElementById('akFlow')?.value || 'DEP';
  const st   = document.getElementById('akStatus');
  const list = document.getElementById('akList');

  if(st) st.textContent = 'Chargement…';
  if(list) list.innerHTML = '';

  const now = new Date();
  const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const endDay   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);

  // fenêtre large pour le linking (hier soir -> demain matin)
  const linkFromDate = new Date(startDay.getTime() - 12*60*60*1000);
  const linkToDate   = new Date(endDay.getTime()   + 12*60*60*1000);

  const linkFrom = linkFromDate.toISOString().replace(/\.\d{3}Z$/, "Z");
  const linkTo   = linkToDate.toISOString().replace(/\.\d{3}Z$/, "Z");

  try{
    const [arrAll, depAll] = await Promise.all([
      fetchAK('ARR', linkFrom, linkTo),
      fetchAK('DEP', linkFrom, linkTo),
    ]);

    // cache pour applyAKFlight + linking
    window._akCache = { arr: arrAll, dep: depAll };

    const inToday = (f, flow) => {
      const t = Date.parse(
        flow === 'DEP'
          ? (f.sobt || f.eobt || f.aobt || f.atot || '')
          : (f.sibt || f.eibt || f.aibt || '')
      );
      return t && t >= startDay.getTime() && t <= endDay.getTime();
    };

    let flights = (flow === 'DEP' ? depAll : arrAll).filter(f => inToday(f, flow));

    // DEP : virer si ATOT > 15 min (fallback AOBT si pas d'ATOT)
    if(flow === 'DEP'){
      flights = flights.filter(d => !depAtotTooOld(d, 15));
    }

    // ARR : virer seulement si le DEP lié (après ARR) est parti (ATOT) depuis > 15 min
    if(flow === 'ARR'){
      flights = flights.filter(arr => {
        const nextDep = findLinkedDepForArr(arr);
        if(!nextDep) return true;                 // repart demain / pas de rota -> on garde
        return !depAtotTooOld(nextDep, 15);       // on vire quand le DEP lié est trop vieux
      });
    }

    // ===== TRI CHRONO =====
    flights.sort((a,b)=>{
      const ta = flow === 'DEP' ? depTimeMs(a) : arrTimeMs(a);
      const tb = flow === 'DEP' ? depTimeMs(b) : arrTimeMs(b);

      if(ta == null && tb == null) return 0;
      if(ta == null) return 1;
      if(tb == null) return -1;
      return ta - tb;
    });

    if(st) st.textContent = `${flights.length} vol(s)`;
    renderAKList(flights, flow);

  }catch(e){
    if(st) st.textContent = `Erreur (${String(e.message || e)})`;
  }
}

// ===== Rendu liste : ARR = provenance, DEP = destination =====
function renderAKList(flights, flow){
  const list = document.getElementById('akList');
  if(!list) return;

  function delayMinutes(f, flow){
    const parse = v => v ? Date.parse(v) : NaN;

    if(flow === 'ARR'){
      const s = parse(f?.sibt);
      const r = parse(f?.aibt || f?.eibt);
      if(!isFinite(s) || !isFinite(r)) return 0;
      const d = Math.round((r - s) / 60000);
      return d > 0 ? d : 0;
    }else{
      const s = parse(f?.sobt);
      const r = parse(f?.aobt || f?.eobt);
      if(!isFinite(s) || !isFinite(r)) return 0;
      const d = Math.round((r - s) / 60000);
      return d > 0 ? d : 0;
    }
  }

  const safeJsonForOnclick = obj =>
    JSON.stringify(obj)
      .replace(/</g,"\\u003c")
      .replace(/>/g,"\\u003e")
      .replace(/&/g,"\\u0026")
      .replace(/'/g,"\\u0027")
      .replace(/\u2028/g,"\\u2028")
      .replace(/\u2029/g,"\\u2029");

  const row = (f)=>{
    const ff    = (f.fullFlightNumber || f.callsign || '').trim();
    const reg   = (f.reg || '').trim();
    const stand = (f.pkg || '').toString().replace(/^P/i,'');
    const t     = pickBestTimeForList(f, flow);

    let statusRaw = (f.status || f.milestone || '').toString().toUpperCase();
    let status = statusRaw;

    if(statusRaw === 'SCHEDULED') status = 'PRÉVU';

    if(flow === 'DEP'){
      if(statusRaw === 'IN_FLIGHT') status = 'DÉCOLLÉ';
    }else{
      // ARR
      if(statusRaw === 'TERMINATED') status = 'ARRIVÉ';
      if(statusRaw === 'IN_FLIGHT')  status = 'EN VOL';

      // 🔥 ARR affiché DÉCOLLÉ si le DEP lié a décollé
      const nextDep = findLinkedDepForArr(f);
      if(nextDep){
        const depStatusRaw = (nextDep.status || nextDep.milestone || '').toString().toUpperCase();
        const depIsOff = depStatusRaw === 'IN_FLIGHT' || !!nextDep.atot;
        if(depIsOff) status = 'DÉCOLLÉ';
      }
    }

    const dly = delayMinutes(f, flow);
    const showDelay = dly >= 5;

    let bg = 'var(--card)';
    if(flow === 'ARR' && status === 'DÉCOLLÉ'){
      bg = 'rgba(0,0,0,.04)';
    }else if(flow === 'ARR' && statusRaw === 'IN_FLIGHT'){
      bg = 'rgba(37,99,235,0.12)';
    }else if(flow === 'DEP' && statusRaw === 'IN_FLIGHT'){
      bg = 'rgba(0,0,0,.04)';
    }else if(showDelay){
      bg = (dly <= 15)
        ? 'rgba(245,158,11,0.18)'
        : 'rgba(239,68,68,0.16)';
    }

    const mainIata = (flow === 'ARR')
      ? (f.adepIata || f.adepIcao || '')
      : (f.adesIata || f.adesIcao || '');

    const delayBadge = showDelay
      ? `<span class="tag" style="font-weight:900; margin-left:6px;
           background:${dly<=15 ? 'rgba(245,158,11,0.20)' : 'rgba(239,68,68,0.18)'};">
           RETARD +${dly}
         </span>`
      : '';

    const json = safeJsonForOnclick(f);

    return `
      <div class="card mb-2"
        style="box-shadow:none;border:1px solid rgba(0,0,0,.08);background:${bg};">
        <div class="card-content" style="padding:10px 12px;">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
            <div style="min-width:220px;">
              <div style="font-weight:900;font-size:1.05rem;display:flex;gap:6px;flex-wrap:wrap;">
                <span>${escapeHtml(mainIata || '---')}</span>
                ${delayBadge}
              </div>

              <div style="color:var(--muted);font-weight:800;font-size:.95rem;">
                ${escapeHtml(ff || '(sans numéro)')}
                · Stand ${escapeHtml(stand || '—')}
                · ${escapeHtml(reg || '—')}
              </div>

              <div style="color:var(--muted);font-weight:800;font-size:.9rem;">
                ${escapeHtml(t || '—')}
                ${status ? '· ' + escapeHtml(status) : ''}
              </div>
            </div>

            <button class="button is-small is-link" type="button"
              onclick='applyAKFlight(${json}, "${flow}")'>
              Utiliser
            </button>
          </div>
        </div>
      </div>
    `;
  };

  list.innerHTML = flights.length
    ? flights.map(row).join('')
    : `<p class="has-text-grey">Aucun vol.</p>`;
}

 // ===== Import : règles BVA =====
function akBuildSI(f, allowDL = true){
  const parts = [];

  const rmk = (f?.remarks || '').trim();
  if(rmk) parts.push(rmk);

  if(allowDL){
    const tb = f?.dlCodes?.typeb;
    if(Array.isArray(tb) && tb.length){
      parts.push(`DL: ${tb.map(x=>`${x.code} +${x.delay}`).join(' / ')}`);
    }
  }

  return parts.join('\n').trim();
}

function storeAKMetaForTab(meta){
  if(!currentTabId) return;

  const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');

  data.akMeta = {
    flow: meta.flow || null,
    reg:  (meta.reg  || '').toUpperCase().trim(),
    arrFF:(meta.arrFF|| '').toUpperCase().trim(),
    depFF:(meta.depFF|| '').toUpperCase().trim(),
    pkg:  (meta.pkg  || '') + '',
    ts: Date.now()
  };

  localStorage.setItem('tab-'+currentTabId, JSON.stringify(data));
}

function parseIsoMs(iso){
  const t = Date.parse(iso || '');
  return Number.isFinite(t) ? t : null;
}

function findBestAKMatch(list, meta, flow){
  if(!Array.isArray(list) || !meta?.reg) return null;

  const wantReg = meta.reg;
  const wantFF  = meta.ff;

  const wantT = parseIsoMs(flow === 'DEP' ? meta.sobt : meta.sibt) ?? parseIsoMs(meta.sibt) ?? parseIsoMs(meta.sobt);

  let best = null;
  let bestScore = Infinity;

  for(const f of list){
    const reg = ((f?.reg || '') + '').toUpperCase().trim();
    if(reg !== wantReg) continue;

    const ff = ((f?.fullFlightNumber || f?.callsign || '') + '').toUpperCase().trim();
    if(wantFF && ff && wantFF !== ff) continue;

    const candT = parseIsoMs(
      flow === 'DEP'
        ? (f?.sobt || f?.eobt || f?.aobt || f?.atot || null)
        : (f?.sibt || f?.eibt || f?.aibt || f?.aldt || null)
    );

    // score : diff temps si possible, sinon favorise match simple
    let score = 999999999;
    if(wantT != null && candT != null) score = Math.abs(candT - wantT);
    else score = 60 * 60 * 1000; // 1h arbitraire

    if(score < bestScore){
      best = f;
      bestScore = score;
    }
  }

  // garde-fou : si on a une comparaison temps, refuse au-delà de 12h
  if(best && wantT != null){
    if(bestScore > 12 * 60 * 60 * 1000) return null;
  }

  return best;
}

async function refreshAKTab(tabId){
  const data = JSON.parse(localStorage.getItem('tab-'+tabId) || '{}');
  const meta = data.akMeta;
  if(!meta){
    showPopup("Pas de données AK à rafraîchir", "#ef4444", 1600);
    return;
  }

  const now = new Date();
  const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const endDay   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);
  const linkFrom = new Date(startDay.getTime() - 12*60*60*1000).toISOString().replace(/\.\d{3}Z$/, "Z");
  const linkTo   = new Date(endDay.getTime()   + 12*60*60*1000).toISOString().replace(/\.\d{3}Z$/, "Z");

  try{
    const [arrAll, depAll] = await Promise.all([
      fetchAK('ARR', linkFrom, linkTo),
      fetchAK('DEP', linkFrom, linkTo),
    ]);

    window._akCache = { arr: arrAll, dep: depAll };

    const flow = meta.flow || 'DEP';
    const list = flow === 'DEP' ? depAll : arrAll;
    const match = findBestAKMatch(list, meta, flow);

    if(!match){
      showPopup("Vol AK introuvable", "#ef4444", 1800);
      return;
    }

    if(currentTabId !== tabId) switchTab(tabId);

    applyAKFlight(match, flow, { refresh: true });
    saveCurrentTabData();

    showPopup("AK rafraîchi", "#16a34a", 1400);

  }catch(e){
    showPopup(`Erreur AK (${String(e.message || e)})`, "#ef4444", 2000);
  }
}

function applyAKFlight(f, flow, opts = {}){
  const isRefresh = !!opts.refresh;

  /* ===== champs communs ===== */
  setValAK('Immat', (f.reg || ''));

  const stand = (f.pkg || '').toString().replace(/^P/i,'').trim();
  if(stand) setValAK('Parking', stand);

  const ac = (f.acTypeIcao || f.acTypeIata || '').toUpperCase().trim();
  if(ac) setValAK('TypeAvion', ac);

  const ff = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();
  if(ff){
    const m = ff.match(/^([A-Z0-9]{2})([0-9]{1,6})$/);
    if(m){
      const cie  = m[1];
      const nvol = m[2];
      const cieSel = document.getElementById('Cie');
      if(cieSel){
        const ok = Array.from(cieSel.options).some(o => o.value === cie);
        setValAK('Cie', ok ? cie : 'Autre');
      }
      setValAK('NVol', nvol);
    }else{
      setValAK('NVol', ff);
    }
  }

  /* ===== DEP ===== */
  if(flow === 'DEP'){
    setValAK('To', (f.adesIata || '') || HOME_IATA);

    setTimeFromISOAK('SOBT', f.sobt || f.eobt);
    setTimeFromISOAK('AOBT', f.aobt);
    setTimeFromISOIfEmptyOrAK('CTOT', f.ctot);

    setTimeFromISOIfEmptyOrAK('AvionPremierEmbarque', f?.boardingDetails?.startTime);
    setTimeFromISOIfEmptyOrAK('AvionDernierEmbarque', f?.boardingDetails?.endTime);

    const si = akBuildSI(f, true);
    setIfEmptyOrAK('ExpSI', si);
    setIfEmptyOrAK('FinalSI', si);

    const prevArr = findLinkedArrForDep(f);

    if(prevArr){
      setValAK('From', (prevArr.adepIata || '') || HOME_IATA);

      setTimeFromISOIfEmptyOrAK('SIBT', prevArr.sibt || prevArr.eibt);
      setTimeFromISOIfEmptyOrAK('AIBT', prevArr.aibt);

      setIfEmptyOrAK('BorderControl', (prevArr.borderControl || '').toUpperCase());

      if(prevArr?.bags != null) setIfEmptyOrAK('LoadPOIDS', String(prevArr.bags));
      if(prevArr?.paxNb != null) setIfEmptyOrAK('LoadPAX', String(prevArr.paxNb));

      setIfEmptyOrAK('LoadSI', akBuildSI(prevArr, false));
    }else{
      setValAK('From', HOME_IATA);
    }

  /* ===== ARR ===== */
  }else{
    setValAK('From', (f.adepIata || '') || HOME_IATA);

    setTimeFromISOAK('SIBT', f.sibt || f.eibt);
    setTimeFromISOAK('AIBT', f.aibt);

    setIfEmptyOrAK('BorderControl', (f.borderControl || '').toUpperCase());

    if(f?.bags != null) setIfEmptyOrAK('LoadPOIDS', String(f.bags));
    if(f?.paxNb != null) setIfEmptyOrAK('LoadPAX', String(f.paxNb));

    setIfEmptyOrAK('LoadSI', akBuildSI(f, false));

    const nextDep = findLinkedDepForArr(f);
    if(nextDep){
      setValAK('To', (nextDep.adesIata || '') || HOME_IATA);

      setTimeFromISOIfEmptyOrAK('SOBT', nextDep.sobt || nextDep.eobt);
      setTimeFromISOIfEmptyOrAK('AOBT', nextDep.aobt);
      setTimeFromISOIfEmptyOrAK('CTOT', nextDep.ctot);

      const siDep = akBuildSI(nextDep, true);
      setIfEmptyOrAK('ExpSI', siDep);
      setIfEmptyOrAK('FinalSI', siDep);
    }else{
      setValAK('To', HOME_IATA);
    }
  }

  /* ===== mémorise ARR + DEP fullFlightNumber pour le bandeau ===== */
  let arrFF = '';
  let depFF = '';

  if(flow === 'ARR'){
    arrFF = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();
    const nextDep = findLinkedDepForArr(f);
    if(nextDep){
      depFF = (nextDep.fullFlightNumber || nextDep.callsign || '').toUpperCase().trim();
    }
  }else{
    depFF = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();
    const prevArr = findLinkedArrForDep(f);
    if(prevArr){
      arrFF = (prevArr.fullFlightNumber || prevArr.callsign || '').toUpperCase().trim();
    }
  }

  storeAKMetaForTab({
    flow,
    reg: f.reg || '',
    pkg: f.pkg || '',
    arrFF,
    depFF
  });

  updateAllCalculations();
  updateTabLabelInstant();

  /* ✅ CORRECTION : fermeture auto quand sélection utilisateur */
  if(!isRefresh){
    closeAKPicker();

    // ✅ et on remet DEP par défaut pour la prochaine ouverture
    const flowSel = document.getElementById('akFlow');
    if(flowSel) flowSel.value = 'DEP';

    showPopup("Vol importé", "#16a34a", 1600);
  }
}

function openRZAModal(){
  const back  = document.getElementById('rzaBackdrop');
  const modal = document.getElementById('rzaModal');
  const inp   = document.getElementById('rzaModalInput');

  if(back) back.style.display = '';
  if(modal) modal.style.display = 'flex';

  // RZA vient du storage de l’onglet (plus de champ #RZA dans INFO VOL)
  let current = '';
  try{
    if(currentTabId){
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      current = (data.RZA || '').toUpperCase().trim();
    }
  }catch(e){}

  if(inp){
    inp.value = current;
    inp.focus();
    inp.select();

    // MAJUSCULE + lettres uniquement + max 3
    inp.oninput = ()=>{
      inp.value = (inp.value || '')
        .toUpperCase()
        .replace(/[^A-Z]/g,'')
        .slice(0,3);
      const ok = inp.value.length >= 2;
      const help = document.getElementById('rzaHelp');
      if(help) help.style.display = ok ? 'none' : '';
    };
    inp.oninput();
  }
}

function closeRZAModal(validate){
  const back = document.getElementById('rzaBackdrop');
  const modal = document.getElementById('rzaModal');
  if(modal) modal.style.display = 'none';
  if(back) back.style.display = 'none';

  if(validate) validateForm();
}

function submitRZAModal(){
  const inp = document.getElementById('rzaModalInput');
  const v = (inp?.value || '').toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);

  if(v.length < 2){
    const h = document.getElementById('rzaHelp');
    if(h) h.style.display = '';
    if(inp) inp.focus();
    return;
  }

  // Stocke RZA dans l'onglet courant
  if(currentTabId){
    const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
    data.RZA = v;
    localStorage.setItem('tab-'+currentTabId, JSON.stringify(data));
  }

  closeRZAModal(true);
}

// Enter/Escape
document.addEventListener('keydown', (e)=>{
  const modal = document.getElementById('rzaModal');
  if(!modal || modal.style.display === 'none') return;

  if(e.key === 'Escape') closeRZAModal(false);
  if(e.key === 'Enter') submitRZAModal();
});

/* validateForm */
function validateForm() {
  const val = id => (document.getElementById(id)?.value || "");

  const dateRaw = val("Date");
  const [yyyy, mm, dd] = (dateRaw || "").split("-");
  const dateTitre = (yyyy && mm && dd) ? `${dd}-${mm}-${yyyy}` : "";

  const cie = val("Cie");
  const vol = val("NVol");
  const from = val("From");
  const to = val("To");
  const immat = val("Immat");
  const typeAvion = val("TypeAvion");

  // ✅ RZA : plus dans INFO VOL -> on le prend du storage de l'onglet
  let rza = '';
  try{
    if(currentTabId){
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      rza = (data.RZA || '').toUpperCase().trim();
    }
  }catch(e){}

  // si pas de RZA -> on ouvre le popup et on stoppe l'envoi
  if(!rza){
    openRZAModal();
    return;
  }

  const titre = `[TIMING] ${dateTitre} / ${cie}${vol} ${from}-${to} / ${immat} / ${rza}`;

  const liftArrivee = `${val("ArriveeLiftArr")} - ${val("DepartLiftArr")}`;
  const liftDepart  = `${val("ArriveeLift")} - ${val("DepartLift")}`;

  // DL block
  const dlLines = [];
  if (val("DLcode1")) dlLines.push(`DL (${val("DLcode1")}) : ${val("DLduree1")} min`);
  if (val("DLcode2")) dlLines.push(`DL (${val("DLcode2")}) : ${val("DLduree2")} min`);
  if (val("DLcode3")) dlLines.push(`DL (${val("DLcode3")}) : ${val("DLduree3")} min`);
  const dlBlock = dlLines.length ? `\n== DL ==\n\n${dlLines.join("\n")}\n` : "";

  // Faits saillants
  const faitsTxt = (val("FaitsSaillants") || "").trim();
  const faitsBlock = faitsTxt ? `\n== FAITS SAILLANTS ==\n\n${faitsTxt}\n` : "";

  // LOAD blocks (POIDS + H1..H4 + SI)
  const loadArrBlock =
`== LOAD ARR ==
PAX : ${val("LoadPAX")}
BAGS : ${val("LoadBAGS")}
POIDS : ${val("LoadPOIDS")}
H1 : ${val("LoadH1")} / H2 : ${val("LoadH2")} / H3 : ${val("LoadH3")} / H4 : ${val("LoadH4")}
SI : ${val("LoadSI")}`;

  const loadExpBlock =
`== LOAD EXP ==
PAX : ${val("ExpPAX")}
BAGS : ${val("ExpBAGS")}
POIDS : ${val("ExpPOIDS")}
H1 : ${val("ExpH1")} / H2 : ${val("ExpH2")} / H3 : ${val("ExpH3")} / H4 : ${val("ExpH4")}
SI : ${val("ExpSI")}`;

  // FINAL : passagers + zones + bagages/poids + H1..H4 + SI
  const loadFinalBlock =
`== LOAD FINAL ==
MALE : ${val("FinalMALE")}
FEMALE : ${val("FinalFEMALE")}
ADULT : ${val("FinalADULT")}
CHILD : ${val("FinalCHILD")}
INFANT : ${val("FinalINFANT")}
TOB : ${val("FinalTOB")}
OA : ${val("FinalOA")} / OB : ${val("FinalOB")} / OC : ${val("FinalOC")} / OD : ${val("FinalOD")}
BAGS : ${val("FinalBAGS")} / POIDS : ${val("FinalPOIDS")} / GB : ${val("FinalGB")}
H1 : ${val("FinalH1")} / H2 : ${val("FinalH2")} / H3 : ${val("FinalH3")} / H4 : ${val("FinalH4")}
SI : ${val("FinalSI")}`;

  const body =
`Vol : ${cie}${vol}
Date : ${dateTitre}
Rotation : ${from} - ${to}
Immat : ${immat}
Type avion : ${typeAvion}
RZA : ${rza}

== HORAIRES ==

SIBT : ${val("SIBT")}
AIBT : ${val("AIBT")}
-
SOBT : ${val("SOBT")}
AOBT : ${val("AOBT")}
CTOT : ${val("CTOT")}

== TIMINGS ==

Arrivée PNT : ${val("ArrPNT")}
Arrivée PNC : ${val("ArrPNC")}

Premier débarqué : ${val("PremierDebarque")}
Dernier débarqué : ${val("DernierDebarque")}

Premier embarqué : ${val("AvionPremierEmbarque")}
Dernier embarqué : ${val("AvionDernierEmbarque")}

Arrivée fuel : ${val("ArriveeFuel")}
Départ fuel : ${val("DepartFuel")}

Arrivée INAD : ${val("ArriveeINAD")}

Lift arrivée : ${liftArrivee}
Lift départ  : ${liftDepart}

Remise LID/LDS : ${val("RemiseLID")}
Fermeture porte avion : ${val("FermeturePorteAvion")}

${loadArrBlock}

${loadExpBlock}

${loadFinalBlock}

${[dlBlock, faitsBlock].filter(Boolean).join("\n")}`;

  window.location.href =
    `mailto:trafic@aeroportbeauvais.com?subject=${encodeURIComponent(titre)}&body=${encodeURIComponent(body)}`;
}

function manualSave() {
  saveCurrentTabData();
  showPopup("Enregistrement réussi", "#2563eb", 2000);
}

function clearAutoSave() {
  if (confirm("Tout réinitialiser ?")) {
    localStorage.clear();
    location.reload();
  }
}
</script>

<!-- ===== Airport Keeper Picker ===== -->
<div id="akBackdrop" onclick="closeAKPicker()"></div>

<div id="akPopover">
  <div class="ak-header" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
    <div class="select">
      <select id="akFlow" onchange="loadAKFlights()">
        <option value="DEP" selected>DEP</option>
        <option value="ARR">ARR</option>
      </select>
    </div>

    <button class="button is-small is-link" type="button" onclick="loadAKFlights()">
      Rafraîchir
    </button>

    <span class="tag is-light" id="akStatus">—</span>

    <button class="button is-small is-light" type="button"
            style="margin-left:auto"
            onclick="closeAKPicker()">
      Fermer
    </button>
  </div>

  <div id="akList"></div>
</div>

<!-- ===== SETTINGS MENU (bottom gear) ===== -->
<div id="settingsBackdrop" onclick="closeSettingsMenu()"></div>

<button id="settingsFab" class="button is-link" type="button" onclick="toggleSettingsMenu()" aria-label="Paramètres">
  ⚙️
</button>

<div id="settingsMenu" role="dialog" aria-modal="true">
  <div class="settings-title">Paramètres</div>

  <div class="settings-row">
    <label class="toggle" style="justify-content:space-between;">
      <span id="darkLabel">Clair</span>
      <input id="darkToggle" type="checkbox" onchange="setDarkMode(this.checked)">
      <span class="track"><span class="thumb"></span></span>
    </label>

    <label class="toggle" style="justify-content:space-between;">
      <span id="tzLabel">Locale</span>
      <input id="utcToggle" type="checkbox" onchange="setTimeModeUTC(this.checked)">
      <span class="track"><span class="thumb"></span></span>
    </label>

    <button class="button is-small is-light" type="button" onclick="closeSettingsMenu()">Fermer</button>
  </div>
</div>


</body>
</html>
