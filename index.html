<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SUIVI PERFORMANCE</title>

<!-- Bulma -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">

<style>
:root{
  --bg: #f6f7fb;
  --card: #ffffff;
  --text: #111827;
  --muted: #6b7280;
  --shadow: 0 10px 28px rgba(0,0,0,.08);
  --shadow2: 0 6px 18px rgba(0,0,0,.10);
  --radius: 14px;

  --field-bg: #ffffff;
  --field-text: #111827;
  --field-border: rgba(17,24,39,.18);
  --field-placeholder: rgba(107,114,128,.95);

  --fixed-header-h: 140px;

  --gap: 10px;
  --padCard: 12px;
  --labelSize: .78rem;
  --inputH: 42px;
}

@media (min-width: 769px){
  :root{ --gap: 12px; --padCard: 14px; --inputH: 44px; }
}

body{ background: var(--bg); color: var(--text); margin: 0; }
html, body{ min-height: 100%; background: var(--bg) !important; }

html.dark, body.dark{
  --bg: #0f1115;
  --card: #151922;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --shadow: 0 10px 28px rgba(0,0,0,.45);
  --shadow2: 0 6px 18px rgba(0,0,0,.50);

  --field-bg: #0f172a;
  --field-text: #e5e7eb;
  --field-border: rgba(229,231,235,.16);
  --field-placeholder: rgba(156,163,175,.95);
}

/* ===== FIXED HEADER ===== */
.fixed-header{
  position: fixed;
  inset: 0 0 auto 0;
  z-index: 3000;
  background: var(--bg) !important;
  backdrop-filter: none !important;
  border-bottom: 1px solid rgba(0,0,0,.08);
}
html.dark .fixed-header{ border-bottom-color: rgba(255,255,255,.08); }

.fixed-header-inner{
  max-width: 1120px;
  margin: 0 auto;
  padding: 10px 14px 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.app-wrap{
  max-width: 1120px;
  margin: 0 auto;
  padding: calc(var(--fixed-header-h) + 14px) 14px 14px;
}

/* rien afficher tant qu'il n'y a pas d'onglet */
.app-wrap{ display:none; }
body.has-tab .app-wrap{ display:block; }
body.no-tab .timer-row{ display:none !important; }

/* Topbar */
.topbar-inner{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content: space-between;
  flex-wrap: wrap;
}

/* Tabs row */
.tabs-row{ display:flex; justify-content:center; }
.tabs-chip{
  width: 100%;
  max-width: 1120px;
  border-radius: 999px;
  padding: 10px 14px;
  background: var(--card);
  box-shadow: var(--shadow2);
  display:flex;
  align-items:center;
  gap:8px;
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  white-space: nowrap;
  scrollbar-width: thin;
}
.tabs-chip .button{
  border-radius: 999px;
  flex: 0 0 auto;
  font-weight: 900;
}

/* bouton refresh coll√© √† chaque onglet */
.tab-wrap{
  display:inline-flex;
  align-items:center;
  gap:6px;
  flex: 0 0 auto;
}
.tab-refresh{
  border-radius: 999px !important;
  padding: 0 10px !important;
  height: 36px;
  min-width: 36px;
  font-weight: 900;
}
.tab-refresh.is-loading{ pointer-events:none; opacity:.7; }

/* Timers chips */
.timer-row{
  display:flex;
  gap:10px;
  flex-wrap: wrap;
  justify-content: center;
}
.timer-chip{
  min-width: 140px;
  border-radius: 999px;
  padding: 10px 14px;
  background: var(--card);
  box-shadow: var(--shadow2);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap:10px;
  color: var(--text);
}
.timer-chip .k{ font-weight: 900; color: var(--text); }
.timer-chip .v{
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background:#ef4444;
  color:#fff;
  min-width: 70px;
  text-align:center;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

#timer-tobt{ background:#16a34a !important; }
#timer-h8{ background:#facc15 !important; color:#fff !important; }
#timer-cd{ background:#93c5fd !important; color:#111 !important; }
#timer-cd.cd-over{ background:#fee2e2 !important; color:#ef4444 !important; }

/* CTOT √©ditable */
.ctot-pill{
  width: auto;
  min-width: 70px;
  border: 0 !important;
  outline: 0 !important;
  box-shadow: none !important;
  background:#334155 !important;
  color:#fff !important;
  font-weight: 900 !important;
  border-radius: 999px !important;
  padding: 6px 10px !important;
  text-align:center;
  height: auto;
  line-height: 1.2;
  font-size: 1rem;
  appearance: none;
  -webkit-appearance: none;
}
.ctot-pill::-webkit-datetime-edit{ color:#fff; }
.ctot-pill::-webkit-calendar-picker-indicator{ display:none; -webkit-appearance:none; }

/* Bulma tweaks */
.card{
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  background: var(--card);
  color: var(--text);
}
.card-header{
  border-top-left-radius: var(--radius);
  border-top-right-radius: var(--radius);
  background: color-mix(in srgb, var(--card) 85%, #3b82f6 15%);
}
body.dark .card-header{
  background: color-mix(in srgb, var(--card) 80%, #60a5fa 20%);
}
.card-header-title{ font-weight: 900; color: var(--text) !important; }
.section-collapse{ cursor: pointer; user-select: none; }
.collapsed-body{ display: none; }

.card-content{ padding: var(--padCard) !important; }

/* Inputs */
.input, .select select, .textarea{
  border-radius: 12px;
  background: var(--field-bg) !important;
  color: var(--field-text) !important;
  border-color: var(--field-border) !important;
  height: var(--inputH);
  font-weight: 800;
}
.textarea{ min-height: 110px; height: auto; }
.input.uppercase{ text-transform: uppercase; }
textarea.si-uppercase{ text-transform: uppercase; }

.input::placeholder, .textarea::placeholder{ color: var(--field-placeholder) !important; }

.field .label{
  font-weight: 900;
  color: var(--text) !important;
  font-size: var(--labelSize) !important;
  letter-spacing: .02em;
  text-transform: uppercase;
  opacity: .9;
}

/* FORCE couleur TOB */
#FinalTOB.is-invalid{ color:#ef4444 !important; }
#FinalTOB.is-valid{ color: var(--field-text) !important; }

/* Buttons */
.btn-actions{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-top: 8px;
}
.btn-actions .button{ border-radius: 12px; font-weight: 900; height: 40px; }

/* Grilles responsive simples */
.grid-auto{
  display:grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: var(--gap);
}
.span-12{ grid-column: span 12; }
.span-6{  grid-column: span 12; }
.span-4{  grid-column: span 6; }
.span-3{  grid-column: span 6; }
@media (min-width: 769px){
  .span-6{ grid-column: span 6; }
  .span-4{ grid-column: span 4; }
  .span-3{ grid-column: span 3; }
}
/* ===== BANDEAUX ESSENTIELS : 2 PAR LIGNE (base) ===== */
.kv-strip{
  display: grid;
  grid-template-columns: 1fr; /* mobile */
  gap: var(--gap);
}
@media (min-width: 600px){
  .kv-strip{
    grid-template-columns: 1fr 1fr; /* tablette + */
  }
}

/* ===== TABLET (600‚Äì900) ===== */
@media (min-width: 600px) and (max-width: 900px){

  :root{
    --gap: 8px;
    --padCard: 9px;
    --labelSize: .68rem;
    --inputH: 34px;
  }

  /* grid spans tablette */
  .span-2{ grid-column: span 2; }
  .span-3{ grid-column: span 3; }
  .span-4{ grid-column: span 4; }
  .span-6{ grid-column: span 6; }

  /* R√©duction globale */
  .card-content{ padding: var(--padCard) !important; }

  /* Bandeaux essentiels */
  .kv-card{ padding: 8px 10px; }
  .kv-title{ font-size: .70rem; letter-spacing: .04em; }
  .kv-value{ font-size: 1rem; font-weight: 800; }

  /* Timers chips */
  .timer-chip{ min-width: 124px; padding: 8px 12px; }
  .timer-chip .k{ font-size: .75rem; }
  .timer-chip .v{ padding: 5px 8px; min-width: 64px; }

  /* Header INFO VOL */
  .flight-info-header{ padding: 8px 10px !important; }
  .flight-info-grid{ gap: 6px !important; }
  .fi-item .fi-label{ font-size: .62rem !important; }
  .fi-item .fi-value{ font-size: .82rem !important; }

  /* Horaires cards */
  .horaire-card{ padding: 10px !important; }
  .horaire-card .card-header-title{ font-size: .85rem !important; padding: 8px 10px !important; }
  .horaire-grid{ gap: 6px !important; }
  .horaire-item .h-label{ font-size: .65rem !important; }
  .horaire-item .h-value{ font-size: .88rem !important; }
}

/* ===== NOUVEAUX STYLES INFO VOL HEADER ===== */
.flight-info-header{
  background: var(--card);
  border-radius: var(--radius);
  padding: 12px 14px;
  box-shadow: var(--shadow2);
  margin-bottom: 14px;
  position: relative;
}

.flight-info-top{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  gap: 10px;
}

.flight-main-title{
  font-size: 1.4rem;
  font-weight: 900;
  color: var(--text);
  letter-spacing: -0.02em;
}

.flight-edit-btn{
  border-radius: 999px !important;
  height: 36px;
  padding: 0 16px !important;
  font-weight: 900 !important;
  font-size: 0.85rem;
  flex-shrink: 0;
}

.flight-info-grid{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}

@media (min-width: 600px){
  .flight-info-grid{
    grid-template-columns: repeat(3, 1fr);
  }
}

.fi-item{
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.fi-label{
  font-size: 0.7rem;
  font-weight: 900;
  text-transform: uppercase;
  color: var(--muted);
  letter-spacing: 0.04em;
}

.fi-value{
  font-size: 0.95rem;
  font-weight: 800;
  color: var(--text);
}

/* ===== MODAL EDIT INFO VOL ===== */
.modal-backdrop{
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 4000;
  backdrop-filter: blur(2px);
}

.modal-container{
  display: none;
  position: fixed;
  inset: 0;
  z-index: 4001;
  overflow-y: auto;
  padding: 20px;
  align-items: center;
  justify-content: center;
}

.modal-box{
  background: var(--card);
  border-radius: var(--radius);
  max-width: 600px;
  width: 100%;
  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
  padding: 20px;
}

.modal-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--field-border);
}

.modal-title{
  font-size: 1.3rem;
  font-weight: 900;
  color: var(--text);
}

.modal-close-btn{
  border-radius: 50% !important;
  width: 36px !important;
  height: 36px !important;
  padding: 0 !important;
  font-size: 1.2rem;
}

.modal-body{
  max-height: 60vh;
  overflow-y: auto;
}

.modal-footer{
  margin-top: 16px;
  padding-top: 12px;
  border-top: 2px solid var(--field-border);
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* ===== HORAIRES CARDS ===== */
.horaires-container{
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 14px;
}

@media (min-width: 600px){
  .horaires-container{
    grid-template-columns: 1fr 1fr;
  }
}

.horaire-card{
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.horaire-card .card-header{
  padding: 0;
  box-shadow: none;
}

.horaire-card.arr-card .card-header{
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.horaire-card.dep-card .card-header{
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.horaire-card .card-header-title{
  color: #ffffff !important;
  padding: 12px 14px;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.horaire-card .card-header-icon{
  font-size: 1.2rem;
}

.horaire-card .card-content{
  padding: 14px !important;
}

.horaire-grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}

.horaire-item{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--field-bg);
  border-radius: 10px;
  border: 1px solid var(--field-border);
}

.h-label{
  font-size: 0.75rem;
  font-weight: 900;
  text-transform: uppercase;
  color: var(--muted);
  letter-spacing: 0.03em;
}

.h-value{
  font-size: 1rem;
  font-weight: 900;
  color: var(--text);
  font-family: 'Courier New', monospace;
}

.horaire-item.highlight{
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
  border-color: rgba(59, 130, 246, 0.3);
}

.horaire-item.ctot-row{
  background: linear-gradient(135deg, rgba(51, 65, 85, 0.15), rgba(51, 65, 85, 0.05));
  border-color: rgba(51, 65, 85, 0.3);
}

/* Airport Keeper Picker */
#akBackdrop{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:5000;
  backdrop-filter: blur(3px);
}

#akPopover{
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:90%;
  max-width:700px;
  max-height:80vh;
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:0 25px 60px rgba(0,0,0,.4);
  padding:16px;
  z-index:5001;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

#akList{
  overflow-y:auto;
  flex:1;
  margin-top:10px;
}

.ak-flight{
  padding:12px;
  margin-bottom:8px;
  background:var(--field-bg);
  border:1px solid var(--field-border);
  border-radius:10px;
  cursor:pointer;
  transition: all .2s;
}

.ak-flight:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow2);
  border-color:#3b82f6;
}

.ak-flight strong{
  color:var(--text);
  font-weight:900;
}

/* Settings FAB & Menu */
#settingsFab{
  position:fixed;
  bottom:20px;
  right:20px;
  width:56px;
  height:56px;
  border-radius:50% !important;
  box-shadow:0 8px 24px rgba(0,0,0,.25);
  z-index:2000;
  font-size:1.5rem;
  padding:0 !important;
  border:none;
}

#settingsBackdrop{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:2500;
  backdrop-filter:blur(2px);
}

#settingsMenu{
  display:none;
  position:fixed;
  bottom:90px;
  right:20px;
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:0 12px 40px rgba(0,0,0,.3);
  padding:16px;
  z-index:2501;
  min-width:240px;
}

.settings-title{
  font-weight:900;
  font-size:1.1rem;
  margin-bottom:12px;
  color:var(--text);
}

.settings-row{
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* Toggle switch */
.toggle{
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  user-select:none;
}

.toggle input{
  display:none;
}

.toggle .track{
  position:relative;
  width:48px;
  height:26px;
  background:#cbd5e1;
  border-radius:999px;
  transition:background .2s;
}

.toggle input:checked + .track{
  background:#3b82f6;
}

.toggle .thumb{
  position:absolute;
  top:3px;
  left:3px;
  width:20px;
  height:20px;
  background:#fff;
  border-radius:50%;
  transition:transform .2s;
  box-shadow:0 2px 4px rgba(0,0,0,.2);
}

.toggle input:checked + .track .thumb{
  transform:translateX(22px);
}

/* RZA Modal */
.rza-modal-backdrop{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:6000;
  backdrop-filter:blur(3px);
}

.rza-modal-container{
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:0 25px 60px rgba(0,0,0,.5);
  padding:24px;
  z-index:6001;
  width:90%;
  max-width:400px;
}

.rza-modal-title{
  font-size:1.4rem;
  font-weight:900;
  margin-bottom:16px;
  color:var(--text);
}

.rza-input{
  width:100%;
  text-align:center;
  font-size:1.8rem !important;
  font-weight:900 !important;
  letter-spacing:0.1em;
  height:60px !important;
}

.rza-help{
  color:#ef4444;
  font-size:0.85rem;
  margin-top:8px;
  text-align:center;
  font-weight:600;
}

.rza-buttons{
  display:flex;
  gap:10px;
  margin-top:16px;
}

/* Popup notification */
.popup-notif{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%) translateY(-100px);
  background:var(--card);
  color:var(--text);
  padding:14px 20px;
  border-radius:999px;
  box-shadow:0 8px 24px rgba(0,0,0,.25);
  z-index:9000;
  font-weight:900;
  font-size:0.95rem;
  opacity:0;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events:none;
}

.popup-notif.show{
  transform:translateX(-50%) translateY(0);
  opacity:1;
}

/* Responsive mobile optimizations */
@media (max-width: 599px){
  .flight-main-title{
    font-size: 1.2rem;
  }
  
  .flight-edit-btn{
    padding: 0 12px !important;
    font-size: 0.8rem;
  }
  
  .fi-label{
    font-size: 0.65rem;
  }
  
  .fi-value{
    font-size: 0.88rem;
  }
  
  .horaire-card .card-header-title{
    font-size: 0.9rem;
    padding: 10px 12px;
  }
  
  .h-label{
    font-size: 0.7rem;
  }
  
  .h-value{
    font-size: 0.95rem;
  }
}
</style>
</head>
<body>

<!-- Popup notification -->
<div id="popupNotif" class="popup-notif"></div>

<!-- Fixed Header (‚úÖ CORRECT ID: fixedHeader) -->
<header id="fixedHeader" class="fixed-header">
  <div class="fixed-header-inner">
    
    <!-- Topbar -->
    <div class="topbar-inner">
      <button class="button is-link" type="button" onclick="createNewTab()">
        <strong>‚ûï Nouveau vol</strong>
      </button>

      <button class="button is-info" type="button" onclick="openAKPicker()">
        <strong>üì° Airport Keeper</strong>
      </button>
    </div>

    <!-- Tabs (‚úÖ CORRECT ID: tab-bar) -->
    <div class="tabs-row">
      <div id="tab-bar" class="tabs-chip"></div>
    </div>

    <!-- Timers (‚úÖ ALL 5 TIMERS with correct IDs) -->
    <div class="timer-row">
      <div class="timer-chip">
        <span class="k">H-40</span>
        <div id="timer-h40" class="v">--:--</div>
      </div>
      <div class="timer-chip">
        <span class="k">H-15</span>
        <div id="timer-h15" class="v">--:--</div>
      </div>
      <div class="timer-chip">
        <span class="k">H-8</span>
        <div id="timer-h8" class="v">--:--</div>
      </div>
      <div class="timer-chip">
        <span class="k">TOBT</span>
        <div id="timer-tobt" class="v">--:--</div>
      </div>
      <div class="timer-chip">
        <span class="k">COUNTDOWN</span>
        <div id="timer-cd" class="v">--:--</div>
      </div>
    </div>

  </div>
</header>

<!-- Main Content -->
<div class="app-wrap">

  <!-- ===== NOUVEAU : INFO VOL HEADER ===== -->
  <div class="flight-info-header">
    <div class="flight-info-top">
      <div class="flight-main-title" id="flightMainTitle">‚Äî</div>
      <button class="button is-link is-small flight-edit-btn" onclick="openFlightEditModal()">
        ‚úèÔ∏è Modifier
      </button>
    </div>
    
    <div class="flight-info-grid">
      <div class="fi-item">
        <div class="fi-label">Date</div>
        <div class="fi-value" id="display-date">‚Äî</div>
      </div>
      <div class="fi-item">
        <div class="fi-label">Route</div>
        <div class="fi-value" id="display-route">‚Äî</div>
      </div>
      <div class="fi-item">
        <div class="fi-label">Immatriculation</div>
        <div class="fi-value" id="display-immat">‚Äî</div>
      </div>
      <div class="fi-item">
        <div class="fi-label">Type Avion</div>
        <div class="fi-value" id="display-type">‚Äî</div>
      </div>
      <div class="fi-item">
        <div class="fi-label">RZA</div>
        <div class="fi-value" id="display-rza">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- ===== NOUVEAU : HORAIRES CARDS ===== -->
  <div class="horaires-container">
    
    <!-- Card ARRIV√âE -->
    <div class="horaire-card arr-card">
      <header class="card-header">
        <p class="card-header-title">
          <span class="card-header-icon">üõ¨</span>
          ARRIV√âE
        </p>
      </header>
      <div class="card-content">
        <div class="horaire-grid">
          <div class="horaire-item highlight">
            <span class="h-label">SIBT</span>
            <input type="time" id="SIBT" class="h-value" style="border:none; background:transparent; width:auto;" onchange="autoSave()">
          </div>
          <div class="horaire-item highlight">
            <span class="h-label">AIBT</span>
            <input type="time" id="AIBT" class="h-value" style="border:none; background:transparent; width:auto;" onchange="autoSave()">
          </div>
        </div>
      </div>
    </div>

    <!-- Card D√âPART -->
    <div class="horaire-card dep-card">
      <header class="card-header">
        <p class="card-header-title">
          <span class="card-header-icon">üõ´</span>
          D√âPART
        </p>
      </header>
      <div class="card-content">
        <div class="horaire-grid">
          <div class="horaire-item highlight">
            <span class="h-label">SOBT</span>
            <input type="time" id="SOBT" class="h-value" style="border:none; background:transparent; width:auto;" onchange="autoSave()">
          </div>
          <div class="horaire-item highlight">
            <span class="h-label">AOBT</span>
            <input type="time" id="AOBT" class="h-value" style="border:none; background:transparent; width:auto;" onchange="autoSave()">
          </div>
          <div class="horaire-item ctot-row">
            <span class="h-label">CTOT</span>
            <input type="time" id="CTOT" class="ctot-pill" onchange="autoSave()">
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ===== MODAL EDIT INFO VOL ===== -->
  <div class="modal-backdrop" id="flightEditBackdrop" onclick="closeFlightEditModal()"></div>
  <div class="modal-container" id="flightEditModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2 class="modal-title">‚úàÔ∏è Modifier les infos vol</h2>
        <button class="button is-light is-small modal-close-btn" onclick="closeFlightEditModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="grid-auto">
          <div class="span-12">
            <div class="field">
              <label class="label">Date</label>
              <div class="control">
                <input class="input" type="date" id="Date" onchange="updateFlightDisplay(); autoSave();">
              </div>
            </div>
          </div>

          <div class="span-6">
            <div class="field">
              <label class="label">Compagnie</label>
              <div class="control">
                <input class="input uppercase" type="text" id="Cie" placeholder="FR" maxlength="3" onchange="updateFlightDisplay(); autoSave();">
              </div>
            </div>
          </div>

          <div class="span-6">
            <div class="field">
              <label class="label">N¬∞ Vol</label>
              <div class="control">
                <input class="input" type="text" id="NVol" placeholder="1234" maxlength="6" onchange="updateFlightDisplay(); autoSave();">
              </div>
            </div>
          </div>

          <div class="span-6">
            <div class="field">
              <label class="label">De (FROM)</label>
              <div class="control">
                <input class="input uppercase" type="text" id="From" placeholder="BVA" maxlength="4" onchange="updateFlightDisplay(); autoSave();">
              </div>
            </div>
          </div>

          <div class="span-6">
            <div class="field">
              <label class="label">Vers (TO)</label>
              <div class="control">
                <input class="input uppercase" type="text" id="To" placeholder="OPO" maxlength="4" onchange="updateFlightDisplay(); autoSave();">
              </div>
            </div>
          </div>

          <div class="span-12">
            <div class="field">
              <label class="label">Immatriculation</label>
              <div class="control">
                <input class="input uppercase" type="text" id="Immat" placeholder="F-XXXX" onchange="updateFlightDisplay(); autoSave();">
              </div>
            </div>
          </div>

          <div class="span-12">
            <div class="field">
              <label class="label">Type Avion</label>
              <div class="control">
                <input class="input uppercase" type="text" id="TypeAvion" placeholder="B738" onchange="updateFlightDisplay(); autoSave();">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="button is-light" onclick="closeFlightEditModal()">Fermer</button>
        <button class="button is-link" onclick="closeFlightEditModal()">
          <strong>‚úì OK</strong>
        </button>
      </div>
    </div>
  </div>

  <!-- ===== RESTE DES SECTIONS (inchang√©es) ===== -->
  
  <!-- TIMINGS ARRIV√âE -->
  <div class="card section-card" style="margin-bottom:14px">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">‚è±Ô∏è TIMINGS ARRIV√âE</p>
    </header>
    <div class="card-content">
      <div class="grid-auto">
        <div class="span-6">
          <div class="field">
            <label class="label">Arriv√©e PNT</label>
            <div class="control">
              <input class="input" type="time" id="ArrPNT" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Arriv√©e PNC</label>
            <div class="control">
              <input class="input" type="time" id="ArrPNC" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Premier d√©barqu√©</label>
            <div class="control">
              <input class="input" type="time" id="PremierDebarque" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Dernier d√©barqu√©</label>
            <div class="control">
              <input class="input" type="time" id="DernierDebarque" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Arriv√©e INAD</label>
            <div class="control">
              <input class="input" type="time" id="ArriveeINAD" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Arriv√©e Lift</label>
            <div class="control">
              <input class="input" type="time" id="ArriveeLiftArr" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">D√©part Lift</label>
            <div class="control">
              <input class="input" type="time" id="DepartLiftArr" onchange="autoSave()">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TIMINGS D√âPART -->
  <div class="card section-card" style="margin-bottom:14px">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">‚è±Ô∏è TIMINGS D√âPART</p>
    </header>
    <div class="card-content">
      <div class="grid-auto">
        <div class="span-6">
          <div class="field">
            <label class="label">Premier embarqu√©</label>
            <div class="control">
              <input class="input" type="time" id="AvionPremierEmbarque" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Dernier embarqu√©</label>
            <div class="control">
              <input class="input" type="time" id="AvionDernierEmbarque" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Arriv√©e Fuel</label>
            <div class="control">
              <input class="input" type="time" id="ArriveeFuel" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">D√©part Fuel</label>
            <div class="control">
              <input class="input" type="time" id="DepartFuel" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Arriv√©e Lift</label>
            <div class="control">
              <input class="input" type="time" id="ArriveeLift" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">D√©part Lift</label>
            <div class="control">
              <input class="input" type="time" id="DepartLift" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Remise LID/LDS</label>
            <div class="control">
              <input class="input" type="time" id="RemiseLID" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Fermeture porte avion</label>
            <div class="control">
              <input class="input" type="time" id="FermeturePorteAvion" onchange="autoSave()">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOAD ARRIV√âE -->
  <div class="card section-card" style="margin-bottom:14px">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">üì¶ LOAD ARRIV√âE</p>
    </header>
    <div class="card-content">
      <div class="grid-auto">
        <div class="span-4">
          <div class="field">
            <label class="label">PAX</label>
            <div class="control">
              <input class="input" type="number" id="LoadPAX" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">BAGS</label>
            <div class="control">
              <input class="input" type="number" id="LoadBAGS" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">POIDS</label>
            <div class="control">
              <input class="input" type="number" id="LoadPOIDS" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H1</label>
            <div class="control">
              <input class="input" type="number" id="LoadH1" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H2</label>
            <div class="control">
              <input class="input" type="number" id="LoadH2" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H3</label>
            <div class="control">
              <input class="input" type="number" id="LoadH3" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H4</label>
            <div class="control">
              <input class="input" type="number" id="LoadH4" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-12">
          <div class="field">
            <label class="label">SI</label>
            <div class="control">
              <textarea class="textarea si-uppercase" id="LoadSI" rows="2" onchange="autoSave()"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOAD EXPEDI√â -->
  <div class="card section-card" style="margin-bottom:14px">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">üì§ LOAD EXPEDI√â</p>
    </header>
    <div class="card-content">
      <div class="grid-auto">
        <div class="span-4">
          <div class="field">
            <label class="label">PAX</label>
            <div class="control">
              <input class="input" type="number" id="ExpPAX" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">BAGS</label>
            <div class="control">
              <input class="input" type="number" id="ExpBAGS" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">POIDS</label>
            <div class="control">
              <input class="input" type="number" id="ExpPOIDS" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H1</label>
            <div class="control">
              <input class="input" type="number" id="ExpH1" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H2</label>
            <div class="control">
              <input class="input" type="number" id="ExpH2" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H3</label>
            <div class="control">
              <input class="input" type="number" id="ExpH3" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H4</label>
            <div class="control">
              <input class="input" type="number" id="ExpH4" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-12">
          <div class="field">
            <label class="label">SI</label>
            <div class="control">
              <textarea class="textarea si-uppercase" id="ExpSI" rows="2" onchange="autoSave()"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOAD FINAL -->
  <div class="card section-card" style="margin-bottom:14px">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">‚úÖ LOAD FINAL</p>
    </header>
    <div class="card-content">
      <div class="grid-auto">
        <!-- Passagers par genre -->
        <div class="span-6">
          <div class="field">
            <label class="label">MALE</label>
            <div class="control">
              <input class="input" type="number" id="FinalMALE" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">FEMALE</label>
            <div class="control">
              <input class="input" type="number" id="FinalFEMALE" onchange="autoSave()">
            </div>
          </div>
        </div>

        <!-- Passagers par cat√©gorie -->
        <div class="span-4">
          <div class="field">
            <label class="label">ADULT</label>
            <div class="control">
              <input class="input" type="number" id="FinalADULT" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">CHILD</label>
            <div class="control">
              <input class="input" type="number" id="FinalCHILD" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">INFANT</label>
            <div class="control">
              <input class="input" type="number" id="FinalINFANT" onchange="autoSave()">
            </div>
          </div>
        </div>

        <!-- TOB -->
        <div class="span-12">
          <div class="field">
            <label class="label">TOB</label>
            <div class="control">
              <input class="input" type="number" id="FinalTOB" onchange="autoSave()">
            </div>
          </div>
        </div>

        <!-- Zones -->
        <div class="span-3">
          <div class="field">
            <label class="label">OA</label>
            <div class="control">
              <input class="input" type="number" id="FinalOA" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">OB</label>
            <div class="control">
              <input class="input" type="number" id="FinalOB" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">OC</label>
            <div class="control">
              <input class="input" type="number" id="FinalOC" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">OD</label>
            <div class="control">
              <input class="input" type="number" id="FinalOD" onchange="autoSave()">
            </div>
          </div>
        </div>

        <!-- Bagages -->
        <div class="span-4">
          <div class="field">
            <label class="label">BAGS</label>
            <div class="control">
              <input class="input" type="number" id="FinalBAGS" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">POIDS</label>
            <div class="control">
              <input class="input" type="number" id="FinalPOIDS" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-4">
          <div class="field">
            <label class="label">GB</label>
            <div class="control">
              <input class="input" type="number" id="FinalGB" onchange="autoSave()">
            </div>
          </div>
        </div>

        <!-- Holds -->
        <div class="span-3">
          <div class="field">
            <label class="label">H1</label>
            <div class="control">
              <input class="input" type="number" id="FinalH1" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H2</label>
            <div class="control">
              <input class="input" type="number" id="FinalH2" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H3</label>
            <div class="control">
              <input class="input" type="number" id="FinalH3" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-3">
          <div class="field">
            <label class="label">H4</label>
            <div class="control">
              <input class="input" type="number" id="FinalH4" onchange="autoSave()">
            </div>
          </div>
        </div>

        <!-- SI -->
        <div class="span-12">
          <div class="field">
            <label class="label">SI</label>
            <div class="control">
              <textarea class="textarea si-uppercase" id="FinalSI" rows="3" onchange="autoSave()"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DL -->
  <div class="card section-card" style="margin-bottom:14px">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">‚ö†Ô∏è DL (Delay)</p>
    </header>
    <div class="card-content">
      <div class="grid-auto">
        <div class="span-6">
          <div class="field">
            <label class="label">DL Code 1</label>
            <div class="control">
              <input class="input" type="text" id="DLcode1" maxlength="2" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Dur√©e (min)</label>
            <div class="control">
              <input class="input" type="number" id="DLduree1" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">DL Code 2</label>
            <div class="control">
              <input class="input" type="text" id="DLcode2" maxlength="2" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Dur√©e (min)</label>
            <div class="control">
              <input class="input" type="number" id="DLduree2" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">DL Code 3</label>
            <div class="control">
              <input class="input" type="text" id="DLcode3" maxlength="2" onchange="autoSave()">
            </div>
          </div>
        </div>

        <div class="span-6">
          <div class="field">
            <label class="label">Dur√©e (min)</label>
            <div class="control">
              <input class="input" type="number" id="DLduree3" onchange="autoSave()">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FAITS SAILLANTS -->
  <div class="card section-card" style="margin-bottom:14px">
    <header class="card-header section-collapse" onclick="toggleCardBody(this)">
      <p class="card-header-title">üìù FAITS SAILLANTS</p>
    </header>
    <div class="card-content">
      <div class="field">
        <div class="control">
          <textarea class="textarea" id="FaitsSaillants" rows="4" placeholder="Notez ici les √©v√©nements importants..." onchange="autoSave()"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="btn-actions">
    <button class="button is-success" onclick="validateForm()">
      <strong>üìß Envoyer</strong>
    </button>
    <button class="button is-info" onclick="manualSave()">
      <strong>üíæ Sauvegarder</strong>
    </button>
    <button class="button is-danger" onclick="clearAutoSave()">
      <strong>üóëÔ∏è Effacer</strong>
    </button>
  </div>

</div>

<script>
// ===== NOUVELLES FONCTIONS POUR LE MODAL INFO VOL =====
function openFlightEditModal() {
  const backdrop = document.getElementById('flightEditBackdrop');
  const modal = document.getElementById('flightEditModal');
  
  if (backdrop) backdrop.style.display = 'block';
  if (modal) modal.style.display = 'flex';
}

function closeFlightEditModal() {
  const backdrop = document.getElementById('flightEditBackdrop');
  const modal = document.getElementById('flightEditModal');
  
  if (backdrop) backdrop.style.display = 'none';
  if (modal) modal.style.display = 'none';
}

function updateFlightDisplay() {
  // Mise √† jour du titre principal
  const cie = document.getElementById('Cie')?.value || '';
  const vol = document.getElementById('NVol')?.value || '';
  const titleEl = document.getElementById('flightMainTitle');
  if (titleEl) {
    titleEl.textContent = (cie && vol) ? `${cie}${vol}` : '‚Äî';
  }

  // Mise √† jour de la date
  const dateRaw = document.getElementById('Date')?.value || '';
  const displayDate = document.getElementById('display-date');
  if (displayDate && dateRaw) {
    const [yyyy, mm, dd] = dateRaw.split('-');
    displayDate.textContent = `${dd}/${mm}/${yyyy}`;
  } else if (displayDate) {
    displayDate.textContent = '‚Äî';
  }

  // Mise √† jour de la route
  const from = document.getElementById('From')?.value || '';
  const to = document.getElementById('To')?.value || '';
  const displayRoute = document.getElementById('display-route');
  if (displayRoute) {
    displayRoute.textContent = (from && to) ? `${from} ‚Üí ${to}` : '‚Äî';
  }

  // Mise √† jour immat
  const immat = document.getElementById('Immat')?.value || '';
  const displayImmat = document.getElementById('display-immat');
  if (displayImmat) {
    displayImmat.textContent = immat || '‚Äî';
  }

  // Mise √† jour type avion
  const type = document.getElementById('TypeAvion')?.value || '';
  const displayType = document.getElementById('display-type');
  if (displayType) {
    displayType.textContent = type || '‚Äî';
  }

  // Mise √† jour RZA (depuis le storage de l'onglet)
  let rza = '';
  try {
    if (currentTabId) {
      const data = JSON.parse(localStorage.getItem('tab-' + currentTabId) || '{}');
      rza = (data.RZA || '').toUpperCase().trim();
    }
  } catch (e) {}
  
  const displayRza = document.getElementById('display-rza');
  if (displayRza) {
    displayRza.textContent = rza || '‚Äî';
  }
}

// Fermeture du modal avec Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById('flightEditModal');
    if (modal && modal.style.display === 'flex') {
      closeFlightEditModal();
    }
  }
});

<script>
  
/* Collapse */
function toggleCardBody(headerEl){
  const card = headerEl.closest('.card');
  if(!card) return;
  const content = card.querySelector('.card-content');
  if(!content) return;
  const collapsed = content.classList.toggle('collapsed-body');
  const icon = headerEl.querySelector('.icon');
  if(icon) icon.textContent = collapsed ? '‚Ä∫' : '‚åÑ';
}

let _scrollY = 0;

function lockScroll(){
  _scrollY = window.scrollY || document.documentElement.scrollTop || 0;

  document.documentElement.classList.add('modal-open');
  document.body.classList.add('modal-open');

  // iOS-proof
  document.body.style.position = 'fixed';
  document.body.style.top = `-${_scrollY}px`;
  document.body.style.left = '0';
  document.body.style.right = '0';
  document.body.style.width = '100%';
}

function unlockScroll(){
  document.documentElement.classList.remove('modal-open');
  document.body.classList.remove('modal-open');

  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.left = '';
  document.body.style.right = '';
  document.body.style.width = '';

  window.scrollTo(0, _scrollY);
}

/* Header height */
function updateHeaderOffset(){
  const header = document.getElementById('fixedHeader');
  if(!header) return;
  const h = Math.ceil(header.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--fixed-header-h', h + 'px');
}

/* Vars */
let isUTC=false;
let manualSOBT=false;
let currentTabId=null;
let saveTimer=null;

let settingFromAK = false;

/* ===== AK managed fields helpers ===== */
function isEmptyVal(el){
  return !el || ((el.value || '').trim() === '');
}

function setValAK(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  settingFromAK = true;
  el.value = (typeof v === 'string') ? (v ?? '').toUpperCase() : (v ?? '');
  el.dataset.ak = '1';
  el.dispatchEvent(new Event('input',  { bubbles:true }));
  el.dispatchEvent(new Event('change', { bubbles:true }));
  settingFromAK = false;
}

function setTimeFromISOAK(id, iso){
  if(!iso) return;
  const d = new Date(iso);
  if(isNaN(d.getTime())) return;

  const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
  const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');

  setValAK(id, `${hh}:${mm}`);
}

function setTimeFromISOIfEmptyOrAK(id, iso){
  const el = document.getElementById(id);
  if(!el) return;
  if(isEmptyVal(el) || el.dataset.ak === '1'){
    setTimeFromISOAK(id, iso);
  }
}

function setIfEmptyOrAK(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  // si champ vide OU d√©j√† pilot√© AK -> on √©crase
  if(isEmptyVal(el) || el.dataset.ak === '1'){
    setValAK(id, (v ?? ''));
  }
}

/* Si l'utilisateur modifie un champ manuellement -> il n'est plus pilot√© AK */
document.addEventListener('input', (e)=>{
  const t = e.target;
  if(!t || !t.dataset) return;
  if(settingFromAK) return;
  if(t.dataset.ak === '1') delete t.dataset.ak;
}, true);

/* Timeline */
let timelineZoom = 1;
const TL_ZOOM_MIN = 0.5;
const TL_ZOOM_MAX = 8;
const TL_ZOOM_STEP = 0.25;
window._timelineCurrentRange = null;

/* TOBT brut + TOBT affich√© */
window._tobtRawMins = null;
window._tobtAdjMins = null;

/* DL */
let lastDLChanged = 1;

/* digits only */
function digitsOnly(el){ el.value = (el.value || '').replace(/[^0-9]/g,''); }

/* ===== H1‚ÄìH4 vs BAGS (ARR / EXP / FINAL) ===== */
function updateHBagsValidity(mode){
  if(mode !== 'final') return;

  const bagsEl = document.getElementById('FinalBAGS');
  if(!bagsEl) return;

  const bags = parseInt(bagsEl.value || '0', 10);
  const ids = ['FinalH1','FinalH2','FinalH3','FinalH4'];

  let sum = 0;
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) sum += parseInt(el.value || '0', 10);
  });

  bagsEl.classList.toggle('is-invalid', bags > 0 && sum !== bags);
}

function syncAdultGenderLocks(){
  const elM = document.getElementById('FinalMALE');
  const elF = document.getElementById('FinalFEMALE');
  const elA = document.getElementById('FinalADULT');
  if(!elM || !elF || !elA) return;

  const m = (elM.value || '').trim();
  const f = (elF.value || '').trim();
  const a = (elA.value || '').trim();

  const hasGender = (m !== '' || f !== '');
  const hasAdult  = (a !== '');

  // R√®gle 1 : si MALE ou FEMALE rempli -> ADULT verrouill√©
  if(hasGender){
    elA.value = '';                 // optionnel : vide ADULT pour √©viter incoh√©rence
    elA.readOnly = true;
    elA.classList.add('is-static'); // look "bloqu√©" (Bulma)
  }else{
    elA.readOnly = false;
    elA.classList.remove('is-static');
  }

  // R√®gle 2 : si ADULT rempli (et genders vides) -> MALE/FEMALE verrouill√©s
  if(!hasGender && hasAdult){
    elM.readOnly = true; elF.readOnly = true;
    elM.classList.add('is-static'); elF.classList.add('is-static');
  }else{
    elM.readOnly = false; elF.readOnly = false;
    elM.classList.remove('is-static'); elF.classList.remove('is-static');
  }
}


/* ===== POIDS auto FR / RK : (BAGS + GB) * 13 ===== */
function updateFinalWeightIfNeeded(){
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  if(cie !== 'FR' && cie !== 'RK') return;

  const bags = parseInt(document.getElementById('FinalBAGS')?.value || '0', 10);
  const gb   = parseInt(document.getElementById('FinalGB')?.value   || '0', 10);

  const poids = (bags + gb) * 13;
  const poidsEl = document.getElementById('FinalPOIDS');
  if(!poidsEl) return;

  if(
    (document.getElementById('FinalBAGS')?.value || '') === '' &&
    (document.getElementById('FinalGB')?.value || '') === ''
  ){
    poidsEl.value = '';
    return;
  }

  poidsEl.value = String(poids);
}

/* ===== POIDS auto FR / RK : ARR + EXP ===== */
function updateArrExpWeightIfNeeded(){
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  if(cie !== 'FR' && cie !== 'RK') return;

  // EXP uniquement (ARR d√©sactiv√©)
  const bagsExp = asInt('ExpBAGS');
  const poidsExpEl = document.getElementById('ExpPOIDS');
  if(bagsExp != null && poidsExpEl && poidsExpEl.value === ''){
    poidsExpEl.value = String(bagsExp * 13);
  }
}

/* ===== COUNTDOWN (CD) ===== */
let countdownTimer = null;

function getNowMinutes(){
  const now = new Date();
  const h = isUTC ? now.getUTCHours() : now.getHours();
  const m = isUTC ? now.getUTCMinutes() : now.getMinutes();
  const s = isUTC ? now.getUTCSeconds() : now.getSeconds();
  return { mins: h*60 + m, secs: s };
}

function fmtMMSSSigned(totalSeconds){
  const isOver = totalSeconds < 0;
  const abs = Math.abs(totalSeconds);

  const mm = Math.floor(abs / 60);
  const ss = abs % 60;

  return `${isOver ? '+' : ''}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}

function stopCountdown(resetDisplay=true){
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
  const el = document.getElementById('timer-cd');
  if(!el) return;
  if(resetDisplay){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
  }
}

function freezeCountdown(){
  // on coupe juste l'interval, on ne touche pas au texte affich√©
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
}

function updateCountdownOnce(){
  const el = document.getElementById('timer-cd');
  if(!el) return;

  const sibtTxt = document.getElementById('SIBT')?.value || '';
  const aibtTxt = document.getElementById('AIBT')?.value || '';
  const sobtTxt = document.getElementById('SOBT')?.value || '';
  const aobtTxt = document.getElementById('AOBT')?.value || '';

  if(!aibtTxt || !sobtTxt || !sibtTxt){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
    return;
  }

  const SIBT = parseHHMM(sibtTxt);
  const AIBT = parseHHMM(aibtTxt);
  const SOBT = parseHHMM(sobtTxt);
  if(SIBT == null || AIBT == null || SOBT == null){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
    return;
  }

  // cible = SOBT si retard AIBT<=SIBT, sinon TOBT adj
  let targetMin = null;
  if (AIBT <= SIBT) targetMin = SOBT;
  else {
    const tobt = window._tobtAdjMins;
    if(tobt == null){
      el.textContent = '--:--';
      el.classList.remove('cd-over');
      return;
    }
    targetMin = tobt;
  }

  // ===== CAS AOBT : on fige MAIS on recalcule selon AOBT =====
  if(aobtTxt){
    const AOBT = parseHHMM(aobtTxt);
    if(AOBT == null){
      el.textContent = '--:--';
      el.classList.remove('cd-over');
      return;
    }

    // diff = AOBT - cible (sign√©, g√®re minuit)
    let diffMin = AOBT - targetMin;
    if(diffMin > 720) diffMin -= 1440;
    if(diffMin < -720) diffMin += 1440;

    const totalSeconds = diffMin * 60;
    const sign = totalSeconds >= 0 ? '+' : '-';
    const abs = Math.abs(totalSeconds);
    const mm = Math.floor(abs / 60);
    const ss = abs % 60;

    el.textContent = `${sign}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;

    // rouge si + (retard)
    el.classList.toggle('cd-over', totalSeconds > 0);
    return;
  }

  // ===== CAS NORMAL : live avec NOW (d√©compte puis +) =====
  const now = getNowMinutes();

  let diffMin = targetMin - now.mins;
  if(diffMin < -720) diffMin += 1440;
  if(diffMin > 720) diffMin -= 1440;

  const remainingSeconds = diffMin * 60 - now.secs;

  const sign = remainingSeconds <= 0 ? '+' : ''; // quand on d√©passe => +
  const abs = Math.abs(remainingSeconds);
  const mm = Math.floor(abs / 60);
  const ss = abs % 60;

  el.textContent = `${sign}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  el.classList.toggle('cd-over', remainingSeconds < 0); // rouge quand on est pass√© √† +
}

function ensureCountdownRunning(){
  const sibtTxt = document.getElementById('SIBT')?.value || '';
  const aibtTxt = document.getElementById('AIBT')?.value || '';
  const sobtTxt = document.getElementById('SOBT')?.value || '';
  const aobtTxt = document.getElementById('AOBT')?.value || '';

  const baseOK = !!(sibtTxt && aibtTxt && sobtTxt);

  // Si AOBT est rempli : pas d'interval, mais on recalcule l'affichage (donc √ßa suit si tu modifies AOBT)
  if(baseOK && aobtTxt){
    freezeCountdown();
    updateCountdownOnce();
    return;
  }

  // Si base incompl√®te : on stop + reset
  if(!baseOK){
    stopCountdown(true);
    return;
  }

  // Live
  if(!countdownTimer){
    updateCountdownOnce();
    countdownTimer = setInterval(updateCountdownOnce, 1000);
  } else {
    updateCountdownOnce();
  }
}

/* Timeline zoom */
function timelineZoomIn(){ timelineSetZoom(timelineZoom + TL_ZOOM_STEP); }
function timelineZoomOut(){ timelineSetZoom(timelineZoom - TL_ZOOM_STEP); }
function timelineZoomReset(){ timelineSetZoom(1); }
function timelineSetZoom(z){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;
  const prevCenterRatio = (scroller.scrollLeft + scroller.clientWidth/2) / Math.max(1, scroller.scrollWidth);
  timelineZoom = Math.max(TL_ZOOM_MIN, Math.min(TL_ZOOM_MAX, z));
  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
  renderTimeline();
  scroller.scrollLeft = prevCenterRatio * scroller.scrollWidth - scroller.clientWidth/2;
}

/* ===== LOAD MODAL (single fullscreen) ===== */
function openLoadModal(mode='arr'){
  const b = document.getElementById('loadBackdrop');
  const m = document.getElementById('loadModal');
  if(b) b.style.display = '';
  if(m) m.style.display = 'flex';
  switchLoadPanel(mode);
}

function closeLoadModal(){
  const b = document.getElementById('loadBackdrop');
  const m = document.getElementById('loadModal');
  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}

function switchLoadPanel(mode){
  const pArr   = document.getElementById('lmPanelArr');
  const pExp   = document.getElementById('lmPanelExp');
  const pFinal = document.getElementById('lmPanelFinal');

  const tArr   = document.getElementById('lmTabArr');
  const tExp   = document.getElementById('lmTabExp');
  const tFinal = document.getElementById('lmTabFinal');

  if(pArr)   pArr.style.display   = (mode==='arr')   ? '' : 'none';
  if(pExp)   pExp.style.display   = (mode==='exp')   ? '' : 'none';
  if(pFinal) pFinal.style.display = (mode==='final') ? '' : 'none';

  if(tArr)   tArr.classList.toggle('is-active', mode==='arr');
  if(tExp)   tExp.classList.toggle('is-active', mode==='exp');
  if(tFinal) tFinal.classList.toggle('is-active', mode==='final');

  const hint = document.getElementById('lmHint');
  if(hint){
    if(mode==='arr') hint.textContent = 'ARRIV√âE';
    if(mode==='exp') hint.textContent = 'EXPLOITATION';
    if(mode==='final') hint.textContent = 'FINAL';
  }

  if(mode === 'final') updateFinalTOB();
  updateHeaderOffset();
}

/* ===== LDM modal ===== */

let _ldmMode = 'arr';

function openLDM(mode='arr'){
  const b = document.getElementById('ldmBackdrop');
  const m = document.getElementById('ldmModal');

  lockScroll();

  if(b) b.style.display = '';
  if(m) m.style.display = 'flex';

  ldmSwitch(mode);
  updateHeaderOffset();
}

function closeLDM(){
  const b = document.getElementById('ldmBackdrop');
  const m = document.getElementById('ldmModal');

  unlockScroll();

  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}

function ldmSwitch(mode){
  _ldmMode = mode;

  const sArr   = document.getElementById('ldmArr');
  const sFinal = document.getElementById('ldmFinal');

  const tArr   = document.getElementById('ldmTabArr');
  const tFinal = document.getElementById('ldmTabFinal');

  if(sArr)   sArr.style.display   = (mode==='arr')   ? '' : 'none';
  if(sFinal) sFinal.style.display = (mode==='final') ? '' : 'none';

  if(tArr)   tArr.classList.toggle('is-active', mode==='arr');
  if(tFinal) tFinal.classList.toggle('is-active', mode==='final');

  const hint = document.getElementById('ldmHint');
  if(hint){
    hint.textContent = (mode==='arr') ? 'LOAD' : 'FINAL';
  }

  if(mode==='final') updateFinalTOB();
  updateHeaderOffset();
}


/* compat anciens boutons (optionnel) */
function toggleLoadArr(){ openLDM('arr'); }
function toggleLoadExp(){ openLDM('exp'); }
function toggleLoadFinal(){ openLDM('final'); }

/* ===== FINAL : calcul ADULT + TOB + contr√¥le OA/OB/OC/OD ===== */
function asInt(id){
  const v = (document.getElementById(id)?.value || '').trim();
  if(v === '') return null;
  const n = parseInt(v,10);
  return isNaN(n) ? null : n;
}
function syncAdultIfNeeded(){
  const m = asInt('FinalMALE');
  const f = asInt('FinalFEMALE');
  const adultEl = document.getElementById('FinalADULT');
  if(!adultEl) return;

  if(m != null && f != null){
    adultEl.value = String(m + f);
    adultEl.readOnly = true;
  }else{
    adultEl.readOnly = false;
  }
}
function setTOBValidity(isValid){
  const tobEl = document.getElementById('FinalTOB');
  if(!tobEl) return;
  tobEl.classList.toggle('is-invalid', !isValid);
  tobEl.classList.toggle('is-valid', isValid);
}
function updateFinalTOB(){
  const n = (id)=>{
    const v = (document.getElementById(id)?.value || '').trim();
    if(v === '') return null;
    const x = parseInt(v, 10);
    return Number.isFinite(x) ? x : null;
  };

  const male   = n('FinalMALE');
  const female = n('FinalFEMALE');
  const adult  = n('FinalADULT');
  const child  = n('FinalCHILD')  ?? 0;
  const infant = n('FinalINFANT') ?? 0;

  // MAIN = (MALE+FEMALE si au moins 1 rempli) sinon ADULT
  let adultsMain = null;
  if(male != null || female != null){
    adultsMain = (male ?? 0) + (female ?? 0);
  } else if(adult != null){
    adultsMain = adult;
  }

  // MAIN_TO B = adultsMain + child (SANS infant)
  let main = null;
  if(adultsMain != null) main = adultsMain + child;

  const tobEl = document.getElementById('FinalTOB');
  if(!tobEl) return;

  // Si pas assez d‚Äôinfo -> vide + pas d‚Äôerreur
  if(main == null){
    tobEl.value = '';
    tobEl.classList.remove('is-invalid','is-valid');
    return;
  }

  // Affichage "MAIN + INFANT"
  tobEl.value = `${main} + ${infant}`;

  // Validation OA..OD (doit matcher MAIN, pas infant)
  const oa = n('FinalOA') ?? 0;
  const ob = n('FinalOB') ?? 0;
  const oc = n('FinalOC') ?? 0;
  const od = n('FinalOD') ?? 0;
  const sumZones = oa + ob + oc + od;

  const ok = (sumZones === main);

  tobEl.classList.toggle('is-invalid', !ok);
  tobEl.classList.toggle('is-valid', ok);
}

function refreshUIForTabs(){
  const tabsLS = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  const hasTab = Array.isArray(tabsLS) && tabsLS.length > 0;

  document.body.classList.toggle('has-tab', hasTab);
  document.body.classList.toggle('no-tab', !hasTab);

  if(!hasTab){
    currentTabId = null;
    closeAKPicker();
    stopCountdown(true);
  }
}

/* INIT */
function initForm(){
  // 1) Cr√©er d‚Äôabord tout le DOM dynamique (sinon loadTabData() ne peut pas restaurer)
  generateTimingFields();

  // 2) UI tabs
  renderTabs();
  refreshUIForTabs();

  // 3) Autosave + unload
  attachAutoSave();
  window.addEventListener('beforeunload', saveCurrentTabData);

  // 4) Listeners (inchang√©)
  document.getElementById('Parking')?.addEventListener('change', updateTabLabelInstant);
  document.getElementById('Cie')?.addEventListener('change', ()=>{
    updateTabLabelInstant();
    updateAllCalculations();
  });
  document.getElementById('NVol')?.addEventListener('input', updateTabLabelInstant);
  document.getElementById('To')?.addEventListener('input', updateTabLabelInstant);

  setupUppercaseInputs(['NVol','From','To','Immat','BorderControl']);

  // 5) Modes persist√©s (inchang√©)
  const storedDark = (localStorage.getItem('modeDark')||'0') === '1';
  const storedUTC  = (localStorage.getItem('modeUTC')||'0') === '1';
  setDarkMode(storedDark, true);
  setTimeModeUTC(storedUTC, true);

  // 6) Listeners "input" globaux (inchang√©)
  [
    'AIBT','SOBT','SIBT','AOBT','CTOT','ArrPNT','ArrPNC','TypeAvion',

    // LOAD (ARR+EXP fusionn√©)
    'LoadPAX_MAIN','LoadPAX_INF','LoadBAGS','LoadPOIDS',

    // FINAL
    'FinalMALE','FinalFEMALE','FinalADULT','FinalCHILD','FinalINFANT',
    'FinalOA','FinalOB','FinalOC','FinalOD',
    'FinalBAGS','FinalPOIDS','FinalGB'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', ()=>{
      updateAllCalculations();
      updateFinalTOB();
    });
  });

  [
    // H-bags seulement pour FINAL
    'FinalBAGS','FinalH1','FinalH2','FinalH3','FinalH4',
    'FinalGB'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', updateAllCalculations);
  });

  // ‚úÖ LOCKS MALE/FEMALE/ADULT (HORS DU if(scroller) !)
  ['FinalMALE','FinalFEMALE','FinalADULT'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', ()=>{
      syncAdultGenderLocks();
      updateFinalTOB();
    });
  });

  // √©tat initial (locks)
  syncAdultGenderLocks();

  // 7) Drag scroll timeline (inchang√©)
  const scroller = document.getElementById('timelineScroll');
  if(scroller){
    let isDown=false, startX=0, startLeft=0;

    scroller.addEventListener('mousedown', e=>{
      isDown=true; startX=e.clientX; startLeft=scroller.scrollLeft;
    });
    scroller.addEventListener('mouseleave', ()=>{ isDown=false; });
    scroller.addEventListener('mouseup', ()=>{ isDown=false; });
    scroller.addEventListener('mousemove', e=>{
      if(!isDown) return;
      const dx = e.clientX - startX;
      scroller.scrollLeft = startLeft - dx;
      e.preventDefault();
    });

    ['wheel','mousedown','touchstart','keydown','scroll'].forEach(ev=>{
      scroller.addEventListener(ev, ()=>{ timelineUserScrolled = true; }, {passive:true});
    });
  }

  // 8) S√©lection onglet APR√àS que le DOM soit pr√™t
  const lastTab = String(localStorage.getItem('lastTabId') || '');
  const tabsLS  = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  const tabs = Array.isArray(tabsLS) ? tabsLS.map(String) : [];

  if(tabs.length > 0){
    if(lastTab && tabs.includes(lastTab)){
      switchTab(lastTab);
    }else{
      switchTab(tabs[0]);
    }
  }else{
    currentTabId = null;
    stopCountdown();
  }

  // 9) Final init (inchang√©)
  setDefaultDateToTodayIfEmpty();

  updateHeaderOffset();
  window.addEventListener('resize', ()=>{
    updateHeaderOffset();
    renderTimeline();
  });

  renderTimeline();
  refreshUIForTabs();
  updateFinalTOB();
}

function updateInfoStrip(){
  const v = id => (document.getElementById(id)?.value || '').toUpperCase().trim();
  const set = (id, txt, def='----') => {
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (txt && String(txt).trim()) ? String(txt).trim() : def;
  };

  // ----- vols ARR/DEP + BC depuis akMeta (prioritaire) -----
  let arrFF = '';
  let depFF = '';
  let bcMeta = '';

  try{
    if(currentTabId){
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      arrFF  = (data?.akMeta?.arrFF || '').toUpperCase().trim();
      depFF  = (data?.akMeta?.depFF || '').toUpperCase().trim();
      bcMeta = (data?.akMeta?.bc    || '').toUpperCase().trim();
    }
  }catch(e){}

  // fallback manuel : DEP = CIE+N¬∞
  if(!depFF){
    const cie  = v('Cie');
    const nvol = v('NVol');
    if(cie || nvol) depFF = `${cie}${nvol}`.trim();
  }

  set('kvArrVol', arrFF || '‚Äî', '‚Äî');
  set('kvDepVol', depFF || '‚Äî', '‚Äî');

  set('kvFrom', v('From') || '---', '---');
  set('kvTo',   v('To')   || '---', '---');

  set('kvImmat', v('Immat') || '------', '------');
  set('kvType',  v('TypeAvion') || '----', '----');

  // Salle arriv√©e : plus de champ BorderControl -> on prend akMeta.bc
  set('kvBC', bcMeta || '--', '--');

  set('kvPark', v('Parking') || '--', '--');
}

/* date d√©faut */
function setDefaultDateToTodayIfEmpty(){
  const d = document.getElementById('Date');
  if(d && !d.value){ d.valueAsDate = new Date(); }
}

/* uppercase */
function setupUppercaseInputs(ids){
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const toUpper = ()=>{ el.value = (el.value||'').toUpperCase(); };
    el.addEventListener('input', toUpper);
    el.addEventListener('blur', toUpper);
  });
}

/* Autosave */
function attachAutoSave(){
  const handler=()=>{
    clearTimeout(saveTimer);
    saveTimer=setTimeout(()=>{
      saveCurrentTabData();
      renderTimeline();
      updateHeaderOffset();
    }, 300);
  };
  document.addEventListener('input', handler, true);
  document.addEventListener('change', handler, true);
}

/* Tabs */
function renderTabs(){
  const tabBar = document.getElementById('tab-bar');
  if(!tabBar) return;

  tabBar.innerHTML = `
    <button class="button is-success is-light" type="button" onclick="createNewTab()">
      + Ajouter vol
    </button>
    <button class="button is-link is-light" type="button"
            onclick="createNewTab(); openAKPicker();">
      + Liste vols
    </button>
  `;

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  tabs.forEach((id)=>{
    const data = JSON.parse(localStorage.getItem('tab-'+id) || '{}');

    const cie  = (data.Cie  || '').toUpperCase();
    const nvol = (data.NVol || '').toUpperCase();
    const to   = (data.To   || '').toUpperCase();

    let left = `${cie}${nvol}`.trim();
    let label =
      left || to
        ? (to ? `${left} | ${to}`.trim() : left)
        : 'VOL';

    const wrap = document.createElement('span');
    wrap.className = 'tab-wrap';

    // bouton onglet (switch)
    const btn = document.createElement('button');
    btn.className = `button ${id === currentTabId ? 'is-link' : 'is-light'}`;
    btn.textContent = label || 'VOL';
    btn.onclick = ()=> switchTab(id);
    btn.ondblclick = ()=> deleteTab(id);

    // bouton refresh ‚Üª (sans switch)
    const r = document.createElement('button');
    r.className = 'button is-light tab-refresh';
    r.type = 'button';
    r.title = 'Rafra√Æchir depuis AK';
    r.innerHTML = '‚Üª';
    r.onclick = async (e)=>{
      e.preventDefault();
      e.stopPropagation();

      r.classList.add('is-loading');
      try{
        await refreshAKTab(id);
      }finally{
        r.classList.remove('is-loading');
      }
    };

    // optionnel : griser si pas de akMeta
    if(!data.akMeta){
      r.disabled = true;
      r.title = "Pas de vol AK associ√©";
      r.style.opacity = '0.45';
      r.style.cursor = 'not-allowed';
    }

    wrap.appendChild(btn);
    wrap.appendChild(r);
    tabBar.appendChild(wrap);
  });

  updateHeaderOffset();
}

function createNewTab(){
  const id = String(Date.now());

  // ajoute l'onglet dans la liste
  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];
  if(!tabs.includes(id)) tabs.push(id);
  localStorage.setItem('flightTabs', JSON.stringify(tabs));

  currentTabId = id;
  localStorage.setItem('lastTabId', id);

  clearFormFields();            // reset champs
  
  // snapshot initial
  const data = {};
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;
    data[el.id] = (el.type === 'checkbox') ? (el.checked ? '1' : '0') : (el.value || '');
  });
  data.infovolOpen = '0';

  localStorage.setItem('tab-'+id, JSON.stringify(data));

  renderTabs();
  refreshUIForTabs();
  updateInfoStrip();
  renderTimeline();
}

function switchTab(id){
  stopCountdown();
  saveCurrentTabData();

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  id = String(id);
  if(!tabs.includes(id)) return;

  currentTabId = id;
  localStorage.setItem('lastTabId', id);

  loadTabData(id);

  renderTabs();
  refreshUIForTabs();
  renderTimeline();
}

function deleteTab(id){
  stopCountdown();
  if(!confirm('Supprimer cette fiche ?')) return;

  id = String(id);

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  const idx = tabs.indexOf(id);
  if(idx === -1) return;

  tabs.splice(idx, 1);
  localStorage.setItem('flightTabs', JSON.stringify(tabs));
  localStorage.removeItem('tab-' + id);

  if(tabs.length > 0){
    const nextId = tabs[Math.max(0, idx - 1)];
    currentTabId = nextId;
    localStorage.setItem('lastTabId', nextId);
    loadTabData(nextId);
  }else{
    localStorage.removeItem('lastTabId');
    currentTabId = null;
    clearFormFields();
    stopCountdown(true);
  }

  renderTabs();
  refreshUIForTabs();
  renderTimeline();
  updateInfoStrip();
}

function clearFormFields(){
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;

    if(el.type === 'checkbox'){
      el.checked = false;
    }else{
      el.value = '';
    }
  });

  // date du jour auto
  const d = document.getElementById('Date');
  if(d){
    const today = new Date().toISOString().slice(0,10);
    d.value = today;
  }

  updateAllCalculations();
  updateTabLabelInstant();
}
function saveCurrentTabData(){
  if(!currentTabId) return;

  // ‚úÖ on part des donn√©es existantes pour ne pas perdre akMeta
  let data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');

  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;
    if(el.type==='checkbox') data[el.id]=el.checked ? '1':'0';
    else data[el.id]=el.value;
  });

  data.modeDark=document.body.classList.contains('dark')?'1':'0';
  data.modeUTC=isUTC?'1':'0';

  data.timer_h40=document.getElementById('timer-h40')?.textContent || '--:--';
  data.timer_h15=document.getElementById('timer-h15')?.textContent || '--:--';
  data.timer_h8=document.getElementById('timer-h8')?.textContent || '--:--';
  data.timer_tobt=document.getElementById('timer-tobt')?.textContent || '--:--';
  data.timer_cd=document.getElementById('timer-cd')?.textContent || '--:--';

  data.timingPanel = localStorage.getItem('timingPanel') || 'dep';

  localStorage.setItem('tab-'+currentTabId,JSON.stringify(data));
  localStorage.setItem('lastTabId',currentTabId);
  renderTabs();
}

function loadTabData(id){
  currentTabId = String(id);

  const raw = localStorage.getItem('tab-'+currentTabId);
  if(!raw) return;

  const data = JSON.parse(raw);

  // recharge champs
  for(const k in data){
    const el = document.getElementById(k);
    if(!el) continue;

    if(el.type === 'checkbox'){
      el.checked = (data[k] === true || data[k] === '1');
    }else{
      el.value = data[k];
    }
  }

  updateAllCalculations();
  updateHeaderOffset();
  updateInfoStrip();
}

function updateTabLabelInstant(){ saveCurrentTabData(); renderTabs(); }

/* TIMING FIELDS ‚Äì ARR / DEP (responsive pro) */
function generateTimingFields(){
  const container = document.getElementById('timing-grid');
  if(!container) return;

  const fieldHTML = (id,label,full=false)=>`
    <div class="${full ? 'span-12' : 'span-6'}">
      <div class="field">
        <label class="label">${label}</label>
        <div class="control">
          <input class="input" type="time" id="${id}" onchange="updateAllCalculations()">
        </div>
        <div class="btn-actions">
          <button class="button is-dark is-light" type="button"
            onclick="adjustTime('${id}',-1);updateAllCalculations()">-1</button>
          <button class="button is-link" type="button"
            onclick="setNow('${id}');updateAllCalculations()">Now</button>
          <button class="button is-dark is-light" type="button"
            onclick="adjustTime('${id}',1);updateAllCalculations()">+1</button>
        </div>
      </div>
    </div>`;

  /* ===== ARRIV√âE ===== */
  const arrNoHeader = `
    <div class="card mb-4">
      <div class="card-content">
        <div class="grid-auto">
          ${fieldHTML('ArriveeFuel','Arriv√©e Avitair',true)}
          ${fieldHTML('PremierDebarque','Premier d√©barqu√©')}
          ${fieldHTML('DernierDebarque','Dernier d√©barqu√©')}
          ${fieldHTML('ArriveeLiftArr','Arriv√©e lift')}
          ${fieldHTML('DepartLiftArr','D√©part lift')}
        </div>
      </div>
    </div>`;

  /* ===== D√âPART ===== */
  const depNoHeader = `
    <div class="card">
      <div class="card-content">
        <div class="grid-auto">
          ${fieldHTML('ArrPNT','Arriv√©e PNT')}
          ${fieldHTML('ArrPNC','Arriv√©e PNC')}
          ${fieldHTML('AvionPremierEmbarque','Premier embarqu√©')}
          ${fieldHTML('AvionDernierEmbarque','Dernier embarqu√©')}
          ${fieldHTML('ArriveeLift','Arriv√©e lift')}
          ${fieldHTML('DepartLift','D√©part lift')}

          <!-- D√©part Avitair + Arriv√©e INAD sur la m√™me ligne -->
          <div class="span-12">
            <div class="grid-auto">
              <div class="span-6">
                ${fieldHTML('DepartFuel','D√©part Avitair')}
              </div>
              <div class="span-6">
                ${fieldHTML('ArriveeINAD','Arriv√©e INAD')}
              </div>
            </div>
          </div>

          ${fieldHTML('RemiseLID','Remise LID/LDS')}
          ${fieldHTML('FermeturePorteAvion','Fermeture porte avion')}
        </div>
      </div>
    </div>`;

  const toggle = `
    <div class="tabs is-toggle is-toggle-rounded is-centered mb-4">
      <ul>
        <li id="seg-arr-li"><a onclick="switchTimingPanel('arr')"><span>Arriv√©e</span></a></li>
        <li id="seg-dep-li"><a onclick="switchTimingPanel('dep')"><span>D√©part</span></a></li>
      </ul>
    </div>`;

  container.innerHTML =
    toggle +
    `<div id="panel-arr" style="display:none;">${arrNoHeader}</div>` +
    `<div id="panel-dep" style="display:none;">${depNoHeader}</div>`;

  const saved = localStorage.getItem('timingPanel') || 'dep';
  switchTimingPanel(saved);
}

function switchTimingPanel(mode){
  const arrPanel=document.getElementById('panel-arr');
  const depPanel=document.getElementById('panel-dep');
  const liArr=document.getElementById('seg-arr-li');
  const liDep=document.getElementById('seg-dep-li');

  if(arrPanel) arrPanel.style.display = (mode==='arr') ? '' : 'none';
  if(depPanel) depPanel.style.display = (mode==='dep') ? '' : 'none';

  if(liArr) liArr.classList.toggle('is-active', mode==='arr');
  if(liDep) liDep.classList.toggle('is-active', mode!=='arr');

  localStorage.setItem('timingPanel', mode);
}

/* LID visible FR/RK */
function updateLIDVisibility(){
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const lid = document.getElementById('lidBlock');
  if(!lid) return;
  lid.style.display = (cie === 'FR' || cie === 'RK') ? '' : 'none';
  updateHeaderOffset();
}

/* CALCULS */
function updateAllCalculations() {
  updateTimers();
  updateSOBTDefault();
  updateTOBT();
  updateDLCode();
  redistributeDL();
  updateLID();
  updateLIDVisibility();

  updateHBagsValidity('arr');
  updateHBagsValidity('final');

  updateArrExpWeightIfNeeded();
  updateFinalWeightIfNeeded();

  ensureCountdownRunning();
  renderTimeline();
  updateHeaderOffset();

  updateInfoStrip();
}

/* TIMERS HLE/H-15 */
function updateTimers() {
  const sobt = document.getElementById('SOBT')?.value || '';
  if (!sobt) {
    ['timer-h40', 'timer-h15', 'timer-h8'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.textContent = '--:--';
    });
    return;
  }
  const [hh, mm] = sobt.split(':').map(Number);
  const base = new Date(); base.setHours(hh, mm, 0, 0);
  const h40 = new Date(base.getTime() - 40 * 60000);
  const h15 = new Date(base.getTime() - 15 * 60000);
  document.getElementById('timer-h40').textContent = `${String(h40.getHours()).padStart(2, '0')}:${String(h40.getMinutes()).padStart(2, '0')}`;
  document.getElementById('timer-h15').textContent = `${String(h15.getHours()).padStart(2, '0')}:${String(h15.getMinutes()).padStart(2, '0')}`;
}

/* LID = TOBT - 8 */
function updateLID() {
  const tobtRawMins = window._tobtRawMins;
  const el = document.getElementById('timer-h8');
  if (!el) return;
  if (tobtRawMins == null) { el.textContent = "--:--"; return; }
  el.textContent = fmtHHMM(tobtRawMins - 8);
}

function updateSOBTDefault() {
  const sobtEl = document.getElementById('SOBT');
  if(!sobtEl) return;

  // Si SOBT d√©j√† remplie (ex : import Keeper), on ne touche pas
  if ((sobtEl.value || '').trim() !== '') return;

  const cie = (document.getElementById('Cie').value||'').toUpperCase();

  // FR / RK : SOBT vient de Keeper
  if(cie === "FR" || cie === "RK"){
    return;
  }

  const sibt = document.getElementById('SIBT')?.value || '';
  const arrPNT = document.getElementById('ArrPNT')?.value || '';
  const arrPNC = document.getElementById('ArrPNC')?.value || '';
  if (!sibt) return;
  if (!(cie === "W4" || cie === "W6")) return;

  let [sH, sM] = sibt.split(':').map(Number);
  const base = new Date(); base.setHours(sH, sM);

  const add = (document.getElementById('TypeAvion')?.value === 'A321') ? 35 : 30;
  const sobtCalc = new Date(base.getTime() + add * 60000);

  sobtEl.value =
    `${String(sobtCalc.getHours()).padStart(2,'0')}:${String(sobtCalc.getMinutes()).padStart(2,'0')}`;
}

/* TOBT + r√®gle CTOT */
/* TOBT + r√®gle CTOT (NOUVELLE LOGIQUE) */
/* TOBT + r√®gle CTOT (LOGIQUE FINALE) */
function updateTOBT() {
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  const sibttxt = document.getElementById('SIBT')?.value || '';
  const aibttxt = document.getElementById('AIBT')?.value || '';
  const sobttxt = document.getElementById('SOBT')?.value || '';
  const ctottxt = document.getElementById('CTOT')?.value || '';

  const outEl = document.getElementById('timer-tobt');

  if (!cie || !sibttxt || !sobttxt || !outEl) {
    if(outEl) outEl.textContent = '--:--';
    window._tobtRawMins = null;
    window._tobtAdjMins = null;
    return;
  }

  const SIBT = parseHHMM(sibttxt);
  const SOBT = parseHHMM(sobttxt);
  if (SIBT == null || SOBT == null) {
    outEl.textContent = '--:--';
    window._tobtRawMins = null;
    window._tobtAdjMins = null;
    return;
  }

  const AIBT = aibttxt ? parseHHMM(aibttxt) : SIBT;
  if (AIBT == null) {
    outEl.textContent = '--:--';
    window._tobtRawMins = null;
    window._tobtAdjMins = null;
    return;
  }

  // diff sign√© (minutes), robuste minuit : r√©sultat dans [-720..+720]
  const diffSigned = (t, ref) => {
    let d = t - ref;
    if (d > 720) d -= 1440;
    if (d < -720) d += 1440;
    return d;
  };

  // Temps "√©tendus" ancr√©s sur SIBT (comparaisons correctes m√™me au passage minuit)
  const SIBT_ext = SIBT;
  const AIBT_ext = SIBT_ext + diffSigned(AIBT, SIBT);
  const SOBT_ext = SIBT_ext + diffSigned(SOBT, SIBT);

  const crewChange = !!(
    (document.getElementById('ArrPNT')?.value || '').trim() ||
    (document.getElementById('ArrPNC')?.value || '').trim()
  );

  const isDelayed = (AIBT_ext > SIBT_ext);

  let TOBT_raw_ext = null;

  // ===== R√àGLE COMMUNE : si AIBT <= SIBT => TOBT = SOBT
  if (!isDelayed) {
    TOBT_raw_ext = SOBT_ext;
  } else {
    // ===== FR / RK : TOBT = max(SOBT, AIBT + turn)
    if (cie === 'FR' || cie === 'RK') {
      const turn = crewChange ? 35 : 25;
      const candidate = AIBT_ext + turn;
      TOBT_raw_ext = (candidate <= SOBT_ext) ? SOBT_ext : candidate;
    }

    // ===== W4 / W6 : TOBT = AIBT + 30/35 selon type
    else if (cie === 'W4' || cie === 'W6') {
      const type = (document.getElementById('TypeAvion')?.value || '').toUpperCase();
      const turn = (type === 'A321' || type === 'A21N' || type === 'A21NY') ? 35 : 30; // A320/A20N => 30, d√©faut => 30
      TOBT_raw_ext = AIBT_ext + turn;
    }

    // ===== H4 / U5 / H6 / AUTRE : TOBT = AIBT + (SOBT - SIBT)
    else {
      const rot = SOBT_ext - SIBT_ext; // sign√© (g√®re minuit / rotation invers√©e)
      TOBT_raw_ext = AIBT_ext + rot;
    }
  }

  // Raw minutes 0..1439
  let TOBT_raw = ((TOBT_raw_ext % 1440) + 1440) % 1440;
  window._tobtRawMins = TOBT_raw;

  // ===== R√àGLE CTOT : si CTOT > TOBT + 15 => TOBT = CTOT - 15
  let TOBT_adj_ext = TOBT_raw_ext;

  if (ctottxt) {
    const CTOT = parseHHMM(ctottxt);
    if (CTOT != null) {
      // CTOT √©tendu autour de TOBT (pour g√©rer minuit)
      const TOBT_ref = ((TOBT_raw_ext % 1440) + 1440) % 1440;
      const CTOT_ext = TOBT_raw_ext + diffSigned(CTOT, TOBT_ref);

      if (CTOT_ext > (TOBT_raw_ext + 15)) {
        TOBT_adj_ext = CTOT_ext - 15;
      }
    }
  }

  let TOBT_adj = ((TOBT_adj_ext % 1440) + 1440) % 1440;
  window._tobtAdjMins = TOBT_adj;

  outEl.textContent = fmtHHMM(TOBT_adj);
}

/* DL CODES */
function updateDLCode() {
  const cie = (document.getElementById('Cie').value||'').toUpperCase();
  const sibttxt = document.getElementById('SIBT')?.value || '';
  const aibttxt = document.getElementById('AIBT')?.value || '';
  if (!sibttxt || !aibttxt) return;

  const [sH, sM] = sibttxt.split(':').map(Number);
  const [aH, aM] = aibttxt.split(':').map(Number);
  const SIBT = new Date(); SIBT.setHours(sH, sM);
  const AIBT = new Date(); AIBT.setHours(aH, aM);

  if (AIBT > SIBT) {
    if (cie === 'FR' || cie === 'RK') document.getElementById('DLcode1').value = '93';
    else if (cie === 'W4' || cie === 'W6') document.getElementById('DLcode1').value = '93A';
    else document.getElementById('DLcode1').value = '';
    document.getElementById('DLduree1').value = Math.round((AIBT - SIBT) / 60000) || '';
  } else {
    document.getElementById('DLcode1').value = '';
    document.getElementById('DLduree1').value = '';
  }
}

/* DL redistribution */
function dldChanged(index){ lastDLChanged = index; redistributeDL(); }
function totalDelayMinutes(){
  const so = document.getElementById('SOBT')?.value || '';
  const ao = document.getElementById('AOBT')?.value || '';
  if(!so || !ao) return null;
  const s = parseHHMM(so);
  const a = parseHHMM(ao);
  if (s==null || a==null) return null;
  let total = a - s;
  if (total < 0) total += 1440;
  return total;
}
function redistributeDL(){
  const total = totalDelayMinutes();
  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  if(!f1 || !f2 || !f3) return;

  let d1 = parseInt(f1.value)||0;
  let d2 = parseInt(f2.value)||0;
  let d3 = parseInt(f3.value)||0;

  if(total==null){ clearDLBorders(); return; }

  d1 = Math.max(0, Math.min(d1, total));

  if(lastDLChanged === 1){
    let remain = total - d1;
    d2 = Math.min(remain, Math.max(0, d2));
    d2 = Math.min(remain, d2 + (remain - d2));
    remain = total - d1 - d2;
    d3 = Math.max(0, remain);
  } else if (lastDLChanged === 2){
    const maxD2 = Math.max(0, total - d1);
    d2 = Math.max(0, Math.min(d2, maxD2));
    d3 = Math.max(0, total - d1 - d2);
  } else {
    const maxD3 = Math.max(0, total - d1 - d2);
    d3 = Math.max(0, Math.min(d3, maxD3));
  }

  f1.value = d1 || '';
  f2.value = d2 || '';
  f3.value = d3 || '';

  const sum = d1 + d2 + d3;
  if (sum > total) markLastFilledDLError();
  else clearDLBorders();
}
function markLastFilledDLError(){
  clearDLBorders();
  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  const d1 = parseInt(f1.value)||0;
  const d2 = parseInt(f2.value)||0;
  const d3 = parseInt(f3.value)||0;
  if (d3 > 0) f3.classList.add('dl-error');
  else if (d2 > 0) f2.classList.add('dl-error');
  else if (d1 > 0) f1.classList.add('dl-error');
}
function clearDLBorders(){
  ['DLduree1','DLduree2','DLduree3'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove('dl-error');
  });
}

/* Utils time */
function setNow(fieldId) {
  const now = new Date();
  const hh = isUTC ? now.getUTCHours() : now.getHours();
  const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
  document.getElementById(fieldId).value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}
function adjustTime(fieldId, delta) {
  const input = document.getElementById(fieldId);
  if (!input || !input.value) return;
  let [hh, mm] = input.value.split(':').map(Number);
  let total = hh * 60 + mm + delta;
  if (total < 0) total += 1440;
  if (total >= 1440) total -= 1440;
  hh = Math.floor(total / 60);
  mm = total % 60;
  input.value = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
}

/* Switches */
function setDarkMode(enable, fromInit=false){
  const currentlyDark = document.body.classList.contains('dark');

  if (enable && !currentlyDark) document.body.classList.add('dark');
  if (!enable && currentlyDark) document.body.classList.remove('dark');

  // ‚úÖ applique aussi sur <html> pour les variables CSS
  document.documentElement.classList.toggle('dark', enable);

  const dt = document.getElementById('darkToggle');
  if(dt) dt.checked = enable;

  const darkLabel = document.getElementById('darkLabel');
  if(darkLabel) darkLabel.textContent = enable ? 'Sombre' : 'Clair';

  localStorage.setItem('modeDark', enable ? '1' : '0');

  updateHeaderOffset();
  renderTimeline();
}

function setTimeModeUTC(enable, fromInit=false){
  const offsetHours = -new Date().getTimezoneOffset() / 60;

  if (!fromInit && enable !== isUTC) {
    const inputs = document.querySelectorAll('input[type="time"]');
    inputs.forEach(input => {
      if (!input.value) return;
      let [hh, mm] = input.value.split(':').map(Number);
      let newH = enable ? hh - offsetHours : hh + offsetHours;
      let totalMin = Math.round(newH * 60 + mm);
      totalMin = ((totalMin % 1440) + 1440) % 1440;
      const outH = Math.floor(totalMin / 60);
      const outM = totalMin % 60;
      input.value = `${String(outH).padStart(2, '0')}:${String(outM).padStart(2, '0')}`;
    });
  }

  isUTC = enable;

  const ut = document.getElementById('utcToggle');
  if(ut) ut.checked = enable;

  const tzLabel = document.getElementById('tzLabel');
  if(tzLabel) tzLabel.textContent = enable ? 'UTC' : 'Locale';

  localStorage.setItem('modeUTC', enable ? '1' : '0');

  updateAllCalculations();

  // üîÅ refresh flight list AK si ouverte
  if(document.getElementById('akPopover')?.style.display !== 'none'){
    loadAKFlights();
  }
}

/* Popup */
function showPopup(message, color = "#2563eb", duration = 2000) {
  const popup = document.createElement('div');
  popup.id = "popup";
  popup.textContent = message;
  popup.style.background = color;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), duration);
}

/* Timeline helpers */
let showTimeLabels = true;
let timelineUserScrolled = false;

function parseHHMM(str){
  if(!str || !/^\d{2}:\d{2}$/.test(str)) return null;
  const [h,m] = str.split(':').map(Number);
  return h*60 + m;
}
function fmtHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  const h = Math.floor(mins/60), m = mins%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function toExtended(t, min, max){
  const wraps = (max > 1440);
  if (!wraps) return t;
  const startMod = ((min % 1440) + 1440) % 1440;
  return (t < startMod) ? t + 1440 : t;
}
function computeTimelineWindow(allTimes){
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));
  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');

  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM(document.getElementById('CTOT')?.value || '');

  const starts = [H40, SIBT, AIBT].filter(v => v != null);
  const ends   = [SOBT, AOBT, TOBT, CTOT].filter(v => v != null);

  if(starts.length && ends.length){
    let startRef = Math.min(...starts);
    let endRef   = Math.max(...ends);

    if(endRef <= startRef) endRef += 1440;

    let min = startRef - 5;
    let max = endRef + 5;

    if(max - min < 30){ min -= 10; max += 10; }

    return { min, max };
  }

  if(allTimes && allTimes.length){
    let min = Math.min(...allTimes) - 10;
    let max = Math.max(...allTimes) + 10;
    if(max <= min) max += 1440;
    if(max - min < 30){ min -= 10; max += 10; }
    return {min, max};
  }

  return {min:0, max:60};
}
function getPairWindow(idA,idB){
  const a = parseHHMM(document.getElementById(idA)?.value || '');
  const b = parseHHMM(document.getElementById(idB)?.value || '');
  if(a==null || b==null) return null;
  return [Math.min(a,b), Math.max(a,b)];
}
function collectTimelineData(){
  const fixedPoints = [];
  const addPoint = (label, t, cls='tl--std')=>{ if(t==null) return; fixedPoints.push({label, t, cls}); };

  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');
  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM(document.getElementById('CTOT')?.value || '');
  const H15  = parseHHMM((document.getElementById('timer-h15')?.textContent || '').replace('--:--',''));
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));

  addPoint('SIBT', SIBT, 'tl--std'); addPoint('AIBT', AIBT, 'tl--std');
  addPoint('SOBT', SOBT, 'tl--std'); addPoint('AOBT', AOBT, 'tl--std');
  addPoint('TOBT', TOBT, 'tl--tobt'); addPoint('CTOT', CTOT, 'tl--ctot');
  addPoint('HLE',  H40,  'tl--turn');
  addPoint('H-15', H15,  'tl--turn');

  const singles = [
    ['ArrPNT','Arriv√©e PNT'],
    ['ArrPNC','Arriv√©e PNC'],
    ['FermeturePorteAvion','Fermeture porte avion'],
  ];
  singles.forEach(([id,label])=>{
    const t = parseHHMM(document.getElementById(id)?.value || '');
    if(t!=null) fixedPoints.push({label, t, cls:'tl--std'});
  });

  const rows = [
    {label:'D√©barquement', pair:getPairWindow('PremierDebarque','DernierDebarque'), cls:'tl--turn', color:null},
    {label:'Embarquement', pair:getPairWindow('AvionPremierEmbarque','AvionDernierEmbarque'), cls:'tl--ops',  color:null},
    {label:'Avitair',      pair:getPairWindow('ArriveeFuel','DepartFuel'), cls:'tl--std', color:'#f59e0b'},
    {label:'Lift (Arr)',   pair:getPairWindow('ArriveeLiftArr','DepartLiftArr'), cls:'tl--std', color:'#a855f7'},
    {label:'Lift (Dep)',   pair:getPairWindow('ArriveeLift','DepartLift'), cls:'tl--std', color:'#16a34a'},
  ];

  const durations = rows
    .filter(r=>r.pair!=null)
    .map(r=>({label:r.label, a:r.pair[0], b:r.pair[1], cls:r.cls, color:r.color}));

  const allTimes = [ ...fixedPoints.map(p=>p.t), ...durations.flatMap(d=>[d.a,d.b]) ];
  const windowInfo = computeTimelineWindow(allTimes);

  return {fixedPoints, durations, windowInfo};
}
function renderTimeline(){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;

  canvas.innerHTML = '';

  const {fixedPoints, durations, windowInfo} = collectTimelineData();
  const {min, max} = windowInfo;
  if(min === undefined) return;

  window._timelineCurrentRange = {min, max};
  const total = Math.max(1, max - min);

  const viewport = scroller.clientWidth || 1200;
  const canvasPx = Math.max(viewport, Math.round(viewport * timelineZoom));
  canvas.style.width = canvasPx + 'px';

  const MIN_HEIGHT = 180;
  const PT_LANE_H  = 50;
  const DUR_LANE_H = 50;
  const TOP_PAD    = 40;
  const AFTER_POINTS = 28;
  const AFTER_TRACK  = 36;
  const BOTTOM_PAD   = 40;

  const lanesEndX = [];
  const pointEls = [];

  fixedPoints.sort((a,b)=>a.t-b.t).forEach(p=>{
    const tExt = toExtended(p.t, min, max);
    const leftPct = 6 + ((tExt-min)/total)*88;

    const el = document.createElement('div');
    el.className = `tl-event ${p.cls}`;
    el.style.left = `${leftPct}%`;
    el.style.top  = `0px`;
    el.style.visibility = 'hidden';

    const dot = document.createElement('div'); dot.className = 'tl-dot';
    const label = document.createElement('div'); label.className='tl-label';
    label.textContent = showTimeLabels ? `${p.label} : ${fmtHHMM(p.t)}` : p.label;
    el.appendChild(dot); el.appendChild(label);
    canvas.appendChild(el);

    const w = Math.max(label.offsetWidth, 12);
    const centerX = (leftPct/100) * canvasPx;
    const startX = centerX - (w/2) - 16;
    const endX   = centerX + (w/2) + 16;

    let lane = 0;
    while(lanesEndX[lane] !== undefined && startX <= lanesEndX[lane]) lane++;
    lanesEndX[lane] = endX;

    pointEls.push({el, lane});
  });

  const pointLaneCount = lanesEndX.length || 0;
  const trackY = TOP_PAD + pointLaneCount*PT_LANE_H + AFTER_POINTS;

  const durItems = durations.map(d=>{
    const aExt = toExtended(d.a, min, max);
    const bExt = toExtended(d.b, min, max);
    return { ...d, start: Math.min(aExt,bExt), end: Math.max(aExt,bExt) };
  }).sort((x,y)=> x.start - y.start);

  function packLanes(items, pad = 2){
    const lanes = [];
    return items.map(it => {
      let laneIdx = lanes.findIndex(nextFree => it.start >= nextFree);
      if (laneIdx === -1) {
        laneIdx = lanes.length;
        lanes.push(it.end + pad);
      } else {
        lanes[laneIdx] = it.end + pad;
      }
      return { ...it, lane: laneIdx };
    });
  }

  const durWithLane = packLanes(durItems);
  const durLaneCount = Math.max(0, ...durWithLane.map(d => d.lane)) + 1;

  const finalHeight = Math.max(
    MIN_HEIGHT,
    trackY + AFTER_TRACK + durLaneCount*DUR_LANE_H + BOTTOM_PAD
  );
  canvas.style.height = `${finalHeight}px`;

  for(let t = Math.ceil(min); t <= Math.floor(max); t++){
    const x = (t-min)/total;
    const leftPct = 6 + x*88;

    const vline = document.createElement('div');
    vline.className = 'timeline-tick';
    vline.style.left = `${leftPct}%`;
    vline.style.top = `${8}px`;
    vline.style.height = `${finalHeight - 36}px`;
    canvas.appendChild(vline);

    if(t % 5 === 0){
      const lbl = document.createElement('div');
      lbl.className = 'timeline-tick-label';
      lbl.textContent = fmtHHMM(t);
      lbl.style.left = `${leftPct}%`;
      lbl.style.top = `${finalHeight - 18}px`;
      canvas.appendChild(lbl);
    }
  }

  const track = document.createElement('div');
  track.className = 'timeline-track';
  track.style.top = `${trackY}px`;
  canvas.appendChild(track);

  pointEls.forEach(({el,lane})=>{
    el.style.top = `${TOP_PAD + lane*PT_LANE_H}px`;
    el.style.visibility = 'visible';
  });

  const downStart = trackY + AFTER_TRACK;
  durWithLane.forEach(d=>{
    const leftStartPct = 6 + ((d.start-min)/total)*88;
    const widthPct     = ((d.end-d.start)/total)*88;

    const bar = document.createElement('div');
    bar.className = `tl-range ${d.cls}`;
    if(d.color){ bar.style.setProperty('--c', d.color); }
    bar.style.left = `${leftStartPct}%`;
    bar.style.width = `${widthPct}%`;
    bar.style.top = `${downStart + d.lane*DUR_LANE_H}px`;
    bar.style.transform = 'translateX(-50%)';
    canvas.appendChild(bar);

    const lab = document.createElement('div');
    lab.className = 'tl-range-label';
    const durMin = Math.max(0, d.b - d.a);
    lab.textContent = showTimeLabels ? `${d.label} : ${durMin} min` : d.label;
    bar.appendChild(lab);
  });

  if(!timelineUserScrolled){
    const centerMin = (min + max) / 2;
    const midX = (centerMin - min) / total;
    const centerLeft = midX * scroller.scrollWidth - scroller.clientWidth / 2;
    scroller.scrollLeft = Math.max(0, centerLeft);
  }

  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
}
function setVal(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  // si string -> uppercase, sinon valeur brute
  el.value = (typeof v === 'string') ? v.toUpperCase() : (v ?? '');

  // d√©clenche les listeners
  el.dispatchEvent(new Event('input',  { bubbles:true }));
  el.dispatchEvent(new Event('change', { bubbles:true }));
}

function setTimeFromISO(id, iso){
  if(!iso) return;
  const d = new Date(iso);
  if(isNaN(d.getTime())) return;

  const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
  const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');

  setVal(id, `${hh}:${mm}`);
}

function setIfEmpty(id, v){
  const el = document.getElementById(id);
  if(!el) return;
  if((el.value || '').trim() !== '') return;
  setVal(id, v);
}

function setTimeFromISOIfEmpty(id, iso){
  const el = document.getElementById(id);
  if(!el) return;
  if((el.value || '').trim() !== '') return;
  setTimeFromISO(id, iso);
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function pickBestTimeForList(f, flow){
  const iso = (v)=> v ? new Date(v) : null;

  const toHHMM = (d)=>{
    if(!d || isNaN(d.getTime())) return '';
    const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
    const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  };

  if(flow === 'DEP'){
    return toHHMM(
      iso(f.aobt) || iso(f.sobt) || iso(f.eobt) || iso(f.atot) || iso(f.etot)
    );
  }

  return toHHMM(
    iso(f.aibt) || iso(f.sibt) || iso(f.eibt) || iso(f.aldt) || iso(f.eldt)
  );
}

  /* ===== SETTINGS MENU ===== */
function openSettingsMenu(){
  const b = document.getElementById('settingsBackdrop');
  const m = document.getElementById('settingsMenu');
  if(b) b.style.display = '';
  if(m) m.style.display = 'block';
}
function closeSettingsMenu(){
  const b = document.getElementById('settingsBackdrop');
  const m = document.getElementById('settingsMenu');
  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}
function toggleSettingsMenu(){
  const m = document.getElementById('settingsMenu');
  const isOpen = m && m.style.display !== 'none' && m.style.display !== '';
  if(isOpen) closeSettingsMenu();
  else openSettingsMenu();
}

// ESC ferme aussi le menu settings
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeSettingsMenu();
});

// ===== Airport Keeper (AK) =====
const AK_TOKEN = "Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJidmFfZXh0IiwidXNlcm5hbWUiOiJidmFfZXh0IiwiYWlycG9ydHMiOiJMRk9CIn0.PkSbBw_BF5dnX0bG3gbP7E7P7SHhW9egJ_in6OaWTnJm0OpirhJP4FZzbztH0r6lQxrA5JliEopo7__CyYvfIA";
const AK_BASE    = "https://api.app.airport-keeper.com/flights/v1/airport";
const AK_AIRPORT = "LFOB";
const HOME_IATA  = "BVA";

// Ouvrir/Fermer
function openAKPicker(){
  const b = document.getElementById('akBackdrop');
  const p = document.getElementById('akPopover');
  const flowSel = document.getElementById('akFlow');

  if(flowSel) flowSel.value = 'DEP';   // <-- reset ici

  if(b) b.style.display = '';
  if(p) p.style.display = 'flex';
  loadAKFlights();
}

function closeAKPicker(){
  const b = document.getElementById('akBackdrop');
  const p = document.getElementById('akPopover');
  if(p) p.style.display = 'none';
  if(b) b.style.display = 'none';
}

async function fetchAK(flow, from, to){
  const url = `${AK_BASE}?airport=${encodeURIComponent(AK_AIRPORT)}&flow=${encodeURIComponent(flow)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
  const res = await fetch(url, { headers: { Authorization: AK_TOKEN }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  return Array.isArray(data?.flights) ? data.flights : [];
}

// ===== Temps + linking (immat) =====
function arrTimeMs(f){
  return Date.parse(f?.aibt || f?.eibt || f?.sibt || f?.aldt || f?.eldt || f?.afat || f?.efat || '') || null;
}

// DEP : si pas d'AOBT, on privil√©gie EOBT/POBT/CTOT (r√©aliste) plut√¥t que SOBT (souvent "ancien plan")
function depTimeMs(f){
  return Date.parse(
    f?.aobt || f?.eobt || f?.pobt || f?.ctot || f?.etot || f?.sobt || ''
  ) || null;
}

// ===== Linking : priorit√© linkedId, sinon reg+temps =====
function findLinkedDepForArr(arr){
  if(!arr) return null;

  // 1) linkedId direct
  const lid = (arr?.linkedId || '').trim();
  if(lid){
    const dep = (window._akCache?.dep || []).find(d => String(d?.id) === lid);
    if(dep) return dep;
  }

  // 2) fallback reg + premier DEP apr√®s ARR
  const reg = (arr?.reg || '').toUpperCase().trim();
  if(!reg) return null;

  const arrT = arrTimeMs(arr);
  if(arrT == null) return null;

  const deps = window._akCache?.dep || [];
  let best = null;
  let bestT = Infinity;

  for(const d of deps){
    const r = (d?.reg || '').toUpperCase().trim();
    if(r !== reg) continue;

    const t = depTimeMs(d);
    if(t == null) continue;
    if(t < arrT) continue;

    if(t < bestT){ best = d; bestT = t; }
  }
  return best;
}

function findLinkedArrForDep(dep){
  if(!dep) return null;

  // 1) linkedId direct
  const lid = (dep?.linkedId || '').trim();
  if(lid){
    const arr = (window._akCache?.arr || []).find(a => String(a?.id) === lid);
    if(arr) return arr;
  }

  // 2) fallback reg + derni√®re ARR avant DEP
  const reg = (dep?.reg || '').toUpperCase().trim();
  if(!reg) return null;

  const depT = depTimeMs(dep);
  if(depT == null) return null;

  const arrs = window._akCache?.arr || [];
  let best = null;
  let bestT = -Infinity;

  for(const a of arrs){
    const r = (a?.reg || '').toUpperCase().trim();
    if(r !== reg) continue;

    const t = arrTimeMs(a);
    if(t == null) continue;
    if(t > depT) continue;

    if(t > bestT){ best = a; bestT = t; }
  }
  return best;
}

function depAobtTooOld(dep, minutes = 15){
  const aobt = dep?.aobt;
  if(!aobt) return false;
  const t = Date.parse(aobt);
  if(!t) return false;
  return (Date.now() - t) > minutes*60*1000;
}

function depAtotTooOld(dep, minutes = 15){
  // ATOT = info Keeper uniquement (non affich√©e)
  const iso = dep?.atot || dep?.aobt; // fallback s√©curit√©
  if(!iso) return false;

  const t = Date.parse(iso);
  if(!t) return false;

  return (Date.now() - t) > minutes * 60 * 1000;
}

// ===== Chargement liste (vols du jour) + TRI + SUPPRESSION ATOT+15 =====
async function loadAKFlights(){
  const flow = document.getElementById('akFlow')?.value || 'DEP';
  const st   = document.getElementById('akStatus');
  const list = document.getElementById('akList');

  if(st) st.textContent = 'Chargement‚Ä¶';
  if(list) list.innerHTML = '';

  const now = new Date();
  const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const endDay   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);

  // fen√™tre large pour le linking (hier soir -> demain matin)
  const linkFromDate = new Date(startDay.getTime() - 12*60*60*1000);
  const linkToDate   = new Date(endDay.getTime()   + 12*60*60*1000);

  const linkFrom = linkFromDate.toISOString().replace(/\.\d{3}Z$/, "Z");
  const linkTo   = linkToDate.toISOString().replace(/\.\d{3}Z$/, "Z");

  try{
    const [arrAll, depAll] = await Promise.all([
      fetchAK('ARR', linkFrom, linkTo),
      fetchAK('DEP', linkFrom, linkTo),
    ]);

    // cache pour applyAKFlight + linking
    window._akCache = { arr: arrAll, dep: depAll };

    const inToday = (f, flow) => {
      const t = Date.parse(
        flow === 'DEP'
          ? (f.sobt || f.eobt || f.aobt || f.atot || '')
          : (f.sibt || f.eibt || f.aibt || '')
      );
      return t && t >= startDay.getTime() && t <= endDay.getTime();
    };

    let flights = (flow === 'DEP' ? depAll : arrAll).filter(f => inToday(f, flow));

    // DEP : virer si ATOT > 15 min (fallback AOBT si pas d'ATOT)
    if(flow === 'DEP'){
      flights = flights.filter(d => !depAtotTooOld(d, 15));
    }

    // ARR : virer seulement si le DEP li√© (apr√®s ARR) est parti (ATOT) depuis > 15 min
    if(flow === 'ARR'){
      flights = flights.filter(arr => {
        const nextDep = findLinkedDepForArr(arr);
        if(!nextDep) return true;                 // repart demain / pas de rota -> on garde
        return !depAtotTooOld(nextDep, 15);       // on vire quand le DEP li√© est trop vieux
      });
    }

    // ===== TRI CHRONO =====
    flights.sort((a,b)=>{
      const ta = flow === 'DEP' ? depTimeMs(a) : arrTimeMs(a);
      const tb = flow === 'DEP' ? depTimeMs(b) : arrTimeMs(b);

      if(ta == null && tb == null) return 0;
      if(ta == null) return 1;
      if(tb == null) return -1;
      return ta - tb;
    });

    if(st) st.textContent = `${flights.length} vol(s)`;
    renderAKList(flights, flow);

  }catch(e){
    if(st) st.textContent = `Erreur (${String(e.message || e)})`;
  }
}

// ===== Rendu liste : ARR = provenance, DEP = destination =====
function renderAKList(flights, flow){
  const list = document.getElementById('akList');
  if(!list) return;

  function delayMinutes(f, flow){
    const parse = v => v ? Date.parse(v) : NaN;

    if(flow === 'ARR'){
      const s = parse(f?.sibt);
      const r = parse(f?.aibt || f?.eibt);
      if(!isFinite(s) || !isFinite(r)) return 0;
      const d = Math.round((r - s) / 60000);
      return d > 0 ? d : 0;
    }else{
      const s = parse(f?.sobt);
      const r = parse(f?.aobt || f?.eobt);
      if(!isFinite(s) || !isFinite(r)) return 0;
      const d = Math.round((r - s) / 60000);
      return d > 0 ? d : 0;
    }
  }

  const safeJsonForOnclick = obj =>
    JSON.stringify(obj)
      .replace(/</g,"\\u003c")
      .replace(/>/g,"\\u003e")
      .replace(/&/g,"\\u0026")
      .replace(/'/g,"\\u0027")
      .replace(/\u2028/g,"\\u2028")
      .replace(/\u2029/g,"\\u2029");

  const row = (f)=>{
    const ff    = (f.fullFlightNumber || f.callsign || '').trim();
    const reg   = (f.reg || '').trim();
    const stand = (f.pkg || '').toString().replace(/^P/i,'');
    const t     = pickBestTimeForList(f, flow);

    let statusRaw = (f.status || f.milestone || '').toString().toUpperCase();
    let status = statusRaw;

    if(statusRaw === 'SCHEDULED') status = 'PR√âVU';

    if(flow === 'DEP'){
      if(statusRaw === 'IN_FLIGHT') status = 'D√âCOLL√â';
    }else{
      // ARR
      if(statusRaw === 'TERMINATED') status = 'ARRIV√â';
      if(statusRaw === 'IN_FLIGHT')  status = 'EN VOL';

      // üî• ARR affich√© D√âCOLL√â si le DEP li√© a d√©coll√©
      const nextDep = findLinkedDepForArr(f);
      if(nextDep){
        const depStatusRaw = (nextDep.status || nextDep.milestone || '').toString().toUpperCase();
        const depIsOff = depStatusRaw === 'IN_FLIGHT' || !!nextDep.atot;
        if(depIsOff) status = 'D√âCOLL√â';
      }
    }

    const dly = delayMinutes(f, flow);
    const showDelay = dly >= 5;

    let bg = 'var(--card)';
    if(flow === 'ARR' && status === 'D√âCOLL√â'){
      bg = 'rgba(0,0,0,.04)';
    }else if(flow === 'ARR' && statusRaw === 'IN_FLIGHT'){
      bg = 'rgba(37,99,235,0.12)';
    }else if(flow === 'DEP' && statusRaw === 'IN_FLIGHT'){
      bg = 'rgba(0,0,0,.04)';
    }else if(showDelay){
      bg = (dly <= 15)
        ? 'rgba(245,158,11,0.18)'
        : 'rgba(239,68,68,0.16)';
    }

    const mainIata = (flow === 'ARR')
      ? (f.adepIata || f.adepIcao || '')
      : (f.adesIata || f.adesIcao || '');

    const delayBadge = showDelay
      ? `<span class="tag" style="font-weight:900; margin-left:6px;
           background:${dly<=15 ? 'rgba(245,158,11,0.20)' : 'rgba(239,68,68,0.18)'};">
           RETARD +${dly}
         </span>`
      : '';

    const json = safeJsonForOnclick(f);

    return `
      <div class="card mb-2"
        style="box-shadow:none;border:1px solid rgba(0,0,0,.08);background:${bg};">
        <div class="card-content" style="padding:10px 12px;">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
            <div style="min-width:220px;">
              <div style="font-weight:900;font-size:1.05rem;display:flex;gap:6px;flex-wrap:wrap;">
                <span>${escapeHtml(mainIata || '---')}</span>
                ${delayBadge}
              </div>

              <div style="color:var(--muted);font-weight:800;font-size:.95rem;">
                ${escapeHtml(ff || '(sans num√©ro)')}
                ¬∑ Stand ${escapeHtml(stand || '‚Äî')}
                ¬∑ ${escapeHtml(reg || '‚Äî')}
              </div>

              <div style="color:var(--muted);font-weight:800;font-size:.9rem;">
                ${escapeHtml(t || '‚Äî')}
                ${status ? '¬∑ ' + escapeHtml(status) : ''}
              </div>
            </div>

            <button class="button is-small is-link" type="button"
              onclick='applyAKFlight(${json}, "${flow}")'>
              Utiliser
            </button>
          </div>
        </div>
      </div>
    `;
  };

  list.innerHTML = flights.length
    ? flights.map(row).join('')
    : `<p class="has-text-grey">Aucun vol.</p>`;
}

 // ===== Import : r√®gles BVA =====
function akBuildSI(f, allowDL = true){
  const parts = [];

  const rmk = (f?.remarks || '').trim();
  if(rmk) parts.push(rmk);

  if(allowDL){
    const tb = f?.dlCodes?.typeb;
    if(Array.isArray(tb) && tb.length){
      parts.push(`DL: ${tb.map(x=>`${x.code} +${x.delay}`).join(' / ')}`);
    }
  }

  return parts.join('\n').trim();
}

function storeAKMetaForTab(meta){
  if(!currentTabId) return;

  const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');

  data.akMeta = {
    flow: meta.flow || null,
    reg:  (meta.reg  || '').toUpperCase().trim(),
    arrFF:(meta.arrFF|| '').toUpperCase().trim(),
    depFF:(meta.depFF|| '').toUpperCase().trim(),
    pkg:  (meta.pkg  || '') + '',
    bc:   (meta.bc   || '').toUpperCase().trim(),   // ‚úÖ AJOUT
    ts: Date.now()
  };

  localStorage.setItem('tab-'+currentTabId, JSON.stringify(data));
}

function parseIsoMs(iso){
  const t = Date.parse(iso || '');
  return Number.isFinite(t) ? t : null;
}

function findBestAKMatch(list, meta, flow){
  if(!Array.isArray(list) || !meta?.reg) return null;

  const wantReg = meta.reg;
  const wantFF  = meta.ff;

  const wantT = parseIsoMs(flow === 'DEP' ? meta.sobt : meta.sibt) ?? parseIsoMs(meta.sibt) ?? parseIsoMs(meta.sobt);

  let best = null;
  let bestScore = Infinity;

  for(const f of list){
    const reg = ((f?.reg || '') + '').toUpperCase().trim();
    if(reg !== wantReg) continue;

    const ff = ((f?.fullFlightNumber || f?.callsign || '') + '').toUpperCase().trim();
    if(wantFF && ff && wantFF !== ff) continue;

    const candT = parseIsoMs(
      flow === 'DEP'
        ? (f?.sobt || f?.eobt || f?.aobt || f?.atot || null)
        : (f?.sibt || f?.eibt || f?.aibt || f?.aldt || null)
    );

    // score : diff temps si possible, sinon favorise match simple
    let score = 999999999;
    if(wantT != null && candT != null) score = Math.abs(candT - wantT);
    else score = 60 * 60 * 1000; // 1h arbitraire

    if(score < bestScore){
      best = f;
      bestScore = score;
    }
  }

  // garde-fou : si on a une comparaison temps, refuse au-del√† de 12h
  if(best && wantT != null){
    if(bestScore > 12 * 60 * 60 * 1000) return null;
  }

  return best;
}

async function refreshAKTab(tabId){
  const data = JSON.parse(localStorage.getItem('tab-'+tabId) || '{}');
  const meta = data.akMeta;
  if(!meta){
    showPopup("Pas de donn√©es AK √† rafra√Æchir", "#ef4444", 1600);
    return;
  }

  const now = new Date();
  const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const endDay   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);
  const linkFrom = new Date(startDay.getTime() - 12*60*60*1000).toISOString().replace(/\.\d{3}Z$/, "Z");
  const linkTo   = new Date(endDay.getTime()   + 12*60*60*1000).toISOString().replace(/\.\d{3}Z$/, "Z");

  try{
    const [arrAll, depAll] = await Promise.all([
      fetchAK('ARR', linkFrom, linkTo),
      fetchAK('DEP', linkFrom, linkTo),
    ]);

    window._akCache = { arr: arrAll, dep: depAll };

    const flow = meta.flow || 'DEP';
    const list = flow === 'DEP' ? depAll : arrAll;
    const match = findBestAKMatch(list, meta, flow);

    if(!match){
      showPopup("Vol AK introuvable", "#ef4444", 1800);
      return;
    }

    if(currentTabId !== tabId) switchTab(tabId);

    applyAKFlight(match, flow, { refresh: true });
    saveCurrentTabData();

    showPopup("AK rafra√Æchi", "#16a34a", 1400);

  }catch(e){
    showPopup(`Erreur AK (${String(e.message || e)})`, "#ef4444", 2000);
  }
}

function applyAKFlight(f, flow, opts = {}){
  const isRefresh = !!opts.refresh;

  /* ===== champs communs ===== */
  setValAK('Immat', (f.reg || ''));

  const stand = (f.pkg || '').toString().replace(/^P/i,'').trim();
  if(stand) setValAK('Parking', stand);

  const ac = (f.acTypeIcao || f.acTypeIata || '').toUpperCase().trim();
  if(ac) setValAK('TypeAvion', ac);

  const ff = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();
  if(ff){
    const m = ff.match(/^([A-Z0-9]{2})([0-9]{1,6})$/);
    if(m){
      const cie  = m[1];
      const nvol = m[2];
      const cieSel = document.getElementById('Cie');
      if(cieSel){
        const ok = Array.from(cieSel.options).some(o => o.value === cie);
        setValAK('Cie', ok ? cie : 'Autre');
      }
      setValAK('NVol', nvol);
    }else{
      setValAK('NVol', ff);
    }
  }

  /* =========================================================
     ‚úÖ R√àGLES IMPORT LOAD
     - PAX ARR -> ArrPAX_MAIN
     - NE PLUS importer BAGS / POIDS (ni ARR, ni PREVI, ni FINAL)
     - SI ARR -> ArrSI
     - SI DEP -> PreviSI + FinalSI
     ========================================================= */

  /* ===== DEP ===== */
  if(flow === 'DEP'){
    setValAK('To', (f.adesIata || '') || HOME_IATA);

    setTimeFromISOAK('SOBT', f.sobt || f.eobt);
    setTimeFromISOAK('AOBT', f.aobt);
    setTimeFromISOIfEmptyOrAK('CTOT', f.ctot);

    setTimeFromISOIfEmptyOrAK('AvionPremierEmbarque', f?.boardingDetails?.startTime);
    setTimeFromISOIfEmptyOrAK('AvionDernierEmbarque', f?.boardingDetails?.endTime);

    // ‚úÖ SI DEP -> PREVI + FINAL
    const siDep = akBuildSI(f, true);
    setIfEmptyOrAK('PreviSI', siDep);
    setIfEmptyOrAK('FinalSI', siDep);

    const prevArr = findLinkedArrForDep(f);

    if(prevArr){
      setValAK('From', (prevArr.adepIata || '') || HOME_IATA);

      setTimeFromISOIfEmptyOrAK('SIBT', prevArr.sibt || prevArr.eibt);
      setTimeFromISOIfEmptyOrAK('AIBT', prevArr.aibt);

      // ‚úÖ PAX ARR -> LOAD ARR (PAX)
      if(prevArr?.paxNb != null) setIfEmptyOrAK('ArrPAX_MAIN', String(prevArr.paxNb));

      // ‚ùå PLUS D‚ÄôIMPORT BAGS/POIDS

      // ‚úÖ SI ARR -> LOAD ARR SI
      const siArr = akBuildSI(prevArr, false);
      setIfEmptyOrAK('ArrSI', siArr);

    }else{
      setValAK('From', HOME_IATA);
    }

  /* ===== ARR ===== */
  }else{
    setValAK('From', (f.adepIata || '') || HOME_IATA);

    setTimeFromISOAK('SIBT', f.sibt || f.eibt);
    setTimeFromISOAK('AIBT', f.aibt);

    // ‚úÖ PAX ARR -> LOAD ARR (PAX)
    if(f?.paxNb != null) setIfEmptyOrAK('ArrPAX_MAIN', String(f.paxNb));

    // ‚ùå PLUS D‚ÄôIMPORT BAGS/POIDS

    // ‚úÖ SI ARR -> LOAD ARR SI
    const siArr = akBuildSI(f, false);
    setIfEmptyOrAK('ArrSI', siArr);

    const nextDep = findLinkedDepForArr(f);
    if(nextDep){
      setValAK('To', (nextDep.adesIata || '') || HOME_IATA);

      setTimeFromISOIfEmptyOrAK('SOBT', nextDep.sobt || nextDep.eobt);
      setTimeFromISOIfEmptyOrAK('AOBT', nextDep.aobt);
      setTimeFromISOIfEmptyOrAK('CTOT', nextDep.ctot);

      // ‚úÖ SI DEP -> PREVI + FINAL
      const siDep = akBuildSI(nextDep, true);
      setIfEmptyOrAK('PreviSI', siDep);
      setIfEmptyOrAK('FinalSI', siDep);

    }else{
      setValAK('To', HOME_IATA);
    }
  }

  /* ===== m√©morise ARR + DEP fullFlightNumber + BC pour le bandeau ===== */
  let arrFF = '';
  let depFF = '';
  let bcForStrip = '';

  if(flow === 'ARR'){
    arrFF = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();
    bcForStrip = (f.borderControl || '').toUpperCase().trim();

    const nextDep = findLinkedDepForArr(f);
    if(nextDep){
      depFF = (nextDep.fullFlightNumber || nextDep.callsign || '').toUpperCase().trim();
    }
  }else{
    depFF = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();

    const prevArr = findLinkedArrForDep(f);
    if(prevArr){
      arrFF = (prevArr.fullFlightNumber || prevArr.callsign || '').toUpperCase().trim();
      bcForStrip = (prevArr.borderControl || '').toUpperCase().trim();
    }
  }

  storeAKMetaForTab({
    flow,
    reg: f.reg || '',
    pkg: f.pkg || '',
    arrFF,
    depFF,
    bc: bcForStrip
  });

  updateAllCalculations();
  updateTabLabelInstant();

  /* ‚úÖ fermeture auto quand s√©lection utilisateur */
  if(!isRefresh){
    closeAKPicker();

    // ‚úÖ reset DEP par d√©faut pour la prochaine ouverture
    const flowSel = document.getElementById('akFlow');
    if(flowSel) flowSel.value = 'DEP';

    showPopup("Vol import√©", "#16a34a", 1600);
  }
}

function openRZAModal(){
  const back  = document.getElementById('rzaBackdrop');
  const modal = document.getElementById('rzaModal');
  const inp   = document.getElementById('rzaModalInput');

  if(back) back.style.display = '';
  if(modal) modal.style.display = 'flex';

  // RZA vient du storage de l‚Äôonglet (plus de champ #RZA dans INFO VOL)
  let current = '';
  try{
    if(currentTabId){
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      current = (data.RZA || '').toUpperCase().trim();
    }
  }catch(e){}

  if(inp){
    inp.value = current;
    inp.focus();
    inp.select();

    // MAJUSCULE + lettres uniquement + max 3
    inp.oninput = ()=>{
      inp.value = (inp.value || '')
        .toUpperCase()
        .replace(/[^A-Z]/g,'')
        .slice(0,3);
      const ok = inp.value.length >= 2;
      const help = document.getElementById('rzaHelp');
      if(help) help.style.display = ok ? 'none' : '';
    };
    inp.oninput();
  }
}

function closeRZAModal(validate){
  const back = document.getElementById('rzaBackdrop');
  const modal = document.getElementById('rzaModal');
  if(modal) modal.style.display = 'none';
  if(back) back.style.display = 'none';

  if(validate) validateForm();
}

function submitRZAModal(){
  const inp = document.getElementById('rzaModalInput');
  const v = (inp?.value || '').toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);

  if(v.length < 2){
    const h = document.getElementById('rzaHelp');
    if(h) h.style.display = '';
    if(inp) inp.focus();
    return;
  }

  // Stocke RZA dans l'onglet courant
  if(currentTabId){
    const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
    data.RZA = v;
    localStorage.setItem('tab-'+currentTabId, JSON.stringify(data));
  }

  closeRZAModal(true);
}

// Enter/Escape
document.addEventListener('keydown', (e)=>{
  const modal = document.getElementById('rzaModal');
  if(!modal || modal.style.display === 'none') return;

  if(e.key === 'Escape') closeRZAModal(false);
  if(e.key === 'Enter') submitRZAModal();
});

/* validateForm */
function validateForm() {
  const val = id => (document.getElementById(id)?.value || "");

  const dateRaw = val("Date");
  const [yyyy, mm, dd] = (dateRaw || "").split("-");
  const dateTitre = (yyyy && mm && dd) ? `${dd}-${mm}-${yyyy}` : "";

  const cie = val("Cie");
  const vol = val("NVol");
  const from = val("From");
  const to = val("To");
  const immat = val("Immat");
  const typeAvion = val("TypeAvion");

  // ‚úÖ RZA : plus dans INFO VOL -> on le prend du storage de l'onglet
  let rza = '';
  try{
    if(currentTabId){
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      rza = (data.RZA || '').toUpperCase().trim();
    }
  }catch(e){}

  // si pas de RZA -> on ouvre le popup et on stoppe l'envoi
  if(!rza){
    openRZAModal();
    return;
  }

  const titre = `[TIMING] ${dateTitre} / ${cie}${vol} ${from}-${to} / ${immat} / ${rza}`;

  const liftArrivee = `${val("ArriveeLiftArr")} - ${val("DepartLiftArr")}`;
  const liftDepart  = `${val("ArriveeLift")} - ${val("DepartLift")}`;

  // DL block
  const dlLines = [];
  if (val("DLcode1")) dlLines.push(`DL (${val("DLcode1")}) : ${val("DLduree1")} min`);
  if (val("DLcode2")) dlLines.push(`DL (${val("DLcode2")}) : ${val("DLduree2")} min`);
  if (val("DLcode3")) dlLines.push(`DL (${val("DLcode3")}) : ${val("DLduree3")} min`);
  const dlBlock = dlLines.length ? `\n== DL ==\n\n${dlLines.join("\n")}\n` : "";

  // Faits saillants
  const faitsTxt = (val("FaitsSaillants") || "").trim();
  const faitsBlock = faitsTxt ? `\n== FAITS SAILLANTS ==\n\n${faitsTxt}\n` : "";

  // LOAD blocks (POIDS + H1..H4 + SI)
  const loadArrBlock =
`== LOAD ARR ==
PAX : ${val("LoadPAX")}
BAGS : ${val("LoadBAGS")}
POIDS : ${val("LoadPOIDS")}
H1 : ${val("LoadH1")} / H2 : ${val("LoadH2")} / H3 : ${val("LoadH3")} / H4 : ${val("LoadH4")}
SI : ${val("LoadSI")}`;

  const loadExpBlock =
`== LOAD EXP ==
PAX : ${val("ExpPAX")}
BAGS : ${val("ExpBAGS")}
POIDS : ${val("ExpPOIDS")}
H1 : ${val("ExpH1")} / H2 : ${val("ExpH2")} / H3 : ${val("ExpH3")} / H4 : ${val("ExpH4")}
SI : ${val("ExpSI")}`;

  // FINAL : passagers + zones + bagages/poids + H1..H4 + SI
  const loadFinalBlock =
`== LOAD FINAL ==
MALE : ${val("FinalMALE")}
FEMALE : ${val("FinalFEMALE")}
ADULT : ${val("FinalADULT")}
CHILD : ${val("FinalCHILD")}
INFANT : ${val("FinalINFANT")}
TOB : ${val("FinalTOB")}
OA : ${val("FinalOA")} / OB : ${val("FinalOB")} / OC : ${val("FinalOC")} / OD : ${val("FinalOD")}
BAGS : ${val("FinalBAGS")} / POIDS : ${val("FinalPOIDS")} / GB : ${val("FinalGB")}
H1 : ${val("FinalH1")} / H2 : ${val("FinalH2")} / H3 : ${val("FinalH3")} / H4 : ${val("FinalH4")}
SI : ${val("FinalSI")}`;

  const body =
`Vol : ${cie}${vol}
Date : ${dateTitre}
Rotation : ${from} - ${to}
Immat : ${immat}
Type avion : ${typeAvion}
RZA : ${rza}

== HORAIRES ==

SIBT : ${val("SIBT")}
AIBT : ${val("AIBT")}
-
SOBT : ${val("SOBT")}
AOBT : ${val("AOBT")}
CTOT : ${val("CTOT")}

== TIMINGS ==

Arriv√©e PNT : ${val("ArrPNT")}
Arriv√©e PNC : ${val("ArrPNC")}

Premier d√©barqu√© : ${val("PremierDebarque")}
Dernier d√©barqu√© : ${val("DernierDebarque")}

Premier embarqu√© : ${val("AvionPremierEmbarque")}
Dernier embarqu√© : ${val("AvionDernierEmbarque")}

Arriv√©e fuel : ${val("ArriveeFuel")}
D√©part fuel : ${val("DepartFuel")}

Arriv√©e INAD : ${val("ArriveeINAD")}

Lift arriv√©e : ${liftArrivee}
Lift d√©part  : ${liftDepart}

Remise LID/LDS : ${val("RemiseLID")}
Fermeture porte avion : ${val("FermeturePorteAvion")}

${loadArrBlock}

${loadExpBlock}

${loadFinalBlock}

${[dlBlock, faitsBlock].filter(Boolean).join("\n")}`;

  window.location.href =
    `mailto:trafic@aeroportbeauvais.com?subject=${encodeURIComponent(titre)}&body=${encodeURIComponent(body)}`;
}

function manualSave() {
  saveCurrentTabData();
  showPopup("Enregistrement r√©ussi", "#2563eb", 2000);
}

function clearAutoSave() {
  if (confirm("Tout r√©initialiser ?")) {
    localStorage.clear();
    location.reload();
  }
}
</script>

<!-- ===== Airport Keeper Picker ===== -->
<div id="akBackdrop" onclick="closeAKPicker()"></div>

<div id="akPopover">
  <div class="ak-header" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
    <div class="select">
      <select id="akFlow" onchange="loadAKFlights()">
        <option value="DEP" selected>DEP</option>
        <option value="ARR">ARR</option>
      </select>
    </div>

    <button class="button is-small is-link" type="button" onclick="loadAKFlights()">
      Rafra√Æchir
    </button>

    <span class="tag is-light" id="akStatus">‚Äî</span>

    <button class="button is-small is-light" type="button"
            style="margin-left:auto"
            onclick="closeAKPicker()">
      Fermer
    </button>
  </div>

  <div id="akList"></div>
</div>

<!-- ===== SETTINGS MENU (bottom gear) ===== -->
<div id="settingsBackdrop" onclick="closeSettingsMenu()"></div>

<button id="settingsFab" class="button is-link" type="button" onclick="toggleSettingsMenu()" aria-label="Param√®tres">
  ‚öôÔ∏è
</button>

<div id="settingsMenu" role="dialog" aria-modal="true">
  <div class="settings-title">Param√®tres</div>

  <div class="settings-row">
    <label class="toggle" style="justify-content:space-between;">
      <span id="darkLabel">Clair</span>
      <input id="darkToggle" type="checkbox" onchange="setDarkMode(this.checked)">
      <span class="track"><span class="thumb"></span></span>
    </label>

    <label class="toggle" style="justify-content:space-between;">
      <span id="tzLabel">Locale</span>
      <input id="utcToggle" type="checkbox" onchange="setTimeModeUTC(this.checked)">
      <span class="track"><span class="thumb"></span></span>
    </label>

    <button class="button is-small is-light" type="button" onclick="closeSettingsMenu()">Fermer</button>
  </div>
</div>


</body>
</html>
