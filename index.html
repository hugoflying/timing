<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SUIVI VOL</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">

<style>
* { box-sizing: border-box; }

:root {
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;

  --accent-blue: #3b82f6;
  --accent-green: #10b981;
  --accent-red: #ef4444;
  --accent-orange: #f59e0b;
  --accent-purple: #8b5cf6;

  --border-light: #e2e8f0;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);

  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;

  --space-xs: 8px;
  --space-sm: 12px;
  --space-md: 16px;
  --space-lg: 24px;

  --tabsbar-height: 48px;
  --header-height: 240px;
}

html.dark {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #64748b;
  --border-light: #334155;
}

body {
  margin: 0;
  padding: 0;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  -webkit-font-smoothing: antialiased;
  font-size: 15px;
  line-height: 1.5;
}

/* ===============================================
   TABS SYSTEM
   =============================================== */
.tabs-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--tabsbar-height);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-light);
  z-index: 102;
  overflow-x: auto;
  scrollbar-width: none;
}
.tabs-bar::-webkit-scrollbar { display: none; }

.tabs-container {
  height: 100%;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  min-width: min-content;
}

.tab-item {
  flex: 0 0 auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  padding: 8px 14px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  user-select: none;
}

.tab-item.active {
  background: var(--accent-blue);
  color: white;
  border-color: var(--accent-blue);
}

.tab-close {
  background: none;
  border: none;
  color: currentColor;
  font-size: 16px;
  cursor: pointer;
  padding: 0;
  opacity: 0.65;
  transition: opacity 0.15s;
  line-height: 1;
}
.tab-close:hover { opacity: 1; }

.tab-add {
  flex: 0 0 auto;
  background: var(--accent-green);
  border: none;
  border-radius: var(--radius-sm);
  padding: 8px 14px;
  font-size: 13px;
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.tab-add:hover { background: #059669; transform: translateY(-1px); }

/* ===============================================
   FIXED HEADER
   =============================================== */
.fixed-header {
  position: fixed;
  top: var(--tabsbar-height);
  left: 0;
  right: 0;
  background: var(--bg-secondary);
  border-bottom: 2px solid var(--border-light);
  z-index: 101;
  box-shadow: var(--shadow-md);
}

.header-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 10px 14px;
  cursor: pointer;
}
.header-container:hover { background: rgba(59, 130, 246, 0.02); }

.flight-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--accent-blue);
  color: white;
  padding: 4px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 11px;
  letter-spacing: 0.3px;
  margin-bottom: 8px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 10px;
  letter-spacing: 0.3px;
  text-transform: uppercase;
  margin-bottom: 6px;
}
.status-badge.ontime { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
.status-badge.delayed { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

.countdown-display {
  font-size: 10px;
  font-weight: 800;
  color: var(--text-secondary);
  letter-spacing: 0.3px;
  margin-bottom: 3px;
}
.countdown-display #countdownValue {
  font-size: 12px;
  font-weight: 900;
  color: var(--accent-blue);
  font-variant-numeric: tabular-nums;
}

.route-container {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: var(--space-sm);
  align-items: start;
  margin-bottom: var(--space-sm);
}

.route-side { display: flex; flex-direction: column; gap: 2px; }
.route-side.left { align-items: flex-start; }
.route-side.right { align-items: flex-end; }

.airport-code {
  font-size: 24px;
  font-weight: 900;
  letter-spacing: -0.5px;
  color: var(--text-primary);
  line-height: 1;
  margin-bottom: 4px;
}

.flight-time {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  line-height: 1.2;
}

.flight-time .label {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  font-weight: 800;
  min-width: 38px;
  text-align: left;
}

.flight-time .value {
  font-size: 14px;
  font-weight: 900;
  font-variant-numeric: tabular-nums;
  color: var(--accent-blue);
}

.route-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding-top: 4px;
}

.route-arrow { color: var(--text-muted); font-size: 20px; font-weight: 300; }

.header-meta {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  padding-top: 10px;
  border-top: 1px solid var(--border-light);
}

.meta-item { display: flex; flex-direction: column; gap: 2px; }
.meta-label {
  font-size: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  font-weight: 800;
  line-height: 1;
}
.meta-value {
  font-size: 11px;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1.2;
}

.flight-time .editable-time {
  color: var(--accent-purple);
  cursor: pointer;
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  transition: background 0.15s;
}
.flight-time .editable-time:hover { background: rgba(139, 92, 246, 0.1); }

.edit-hint {
  font-size: 9px;
  color: var(--text-muted);
  text-align: center;
  margin-top: 6px;
  opacity: 0;
  transition: opacity 0.2s;
}
.header-container:hover .edit-hint { opacity: 1; }

/* ===============================================
   MAIN CONTENT
   =============================================== */
.app-container {
  max-width: 600px;
  margin: 0 auto;
  padding: var(--space-md);
  padding-top: calc(var(--header-height) + var(--tabsbar-height) + var(--space-md));
  padding-bottom: 88px;
}

.section-title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  font-weight: 900;
  margin-bottom: var(--space-md);
}

/* ===============================================
   STATUS CARDS
   =============================================== */
.status-section,
.timing-section,
.form-section {
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  padding: var(--space-md);
  margin-bottom: var(--space-md);
  box-shadow: var(--shadow-sm);
}

/* ‚úÖ fix responsive: 3 colonnes -> 2 -> 1 */
.status-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space-sm);
}
@media (max-width: 520px) {
  .status-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 360px) {
  .status-grid { grid-template-columns: 1fr; }
}

.status-card {
  background: var(--bg-primary);
  border: 2px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: var(--space-sm);
  display: flex;
  flex-direction: column;
  gap: 6px;
  transition: all 0.2s;
}

.status-card.active {
  border-color: var(--accent-green);
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
}

.status-card.warning {
  border-color: var(--accent-orange);
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
}

.status-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  font-weight: 900;
}

.status-time {
  font-size: 18px;
  font-weight: 900;
  font-variant-numeric: tabular-nums;
  letter-spacing: -0.5px;
  color: var(--text-primary);
}

.status-card.active .status-time { color: var(--accent-green); }
.status-card.warning .status-time { color: var(--accent-orange); }

/* ===============================================
   TIMING
   =============================================== */
.tabs.is-toggle {
  display: flex;
  justify-content: center;
  margin-bottom: var(--space-md);
}

.tabs.is-toggle ul {
  display: flex;
  gap: 6px;
  list-style: none;
  margin: 0;
  padding: 6px;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
}

.tabs.is-toggle li { flex: 1; }

.tabs.is-toggle li a {
  display: block;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 900;
  color: var(--text-secondary);
  text-decoration: none;
  transition: all 0.15s;
  text-align: center;
  cursor: pointer;
}

.tabs.is-toggle li.is-active a {
  background: var(--accent-blue);
  color: white;
}

.grid-auto {
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: var(--space-md);
}

.span-12 { grid-column: span 12; }
.span-6 { grid-column: span 6; }

@media (max-width: 600px) {
  .span-6 { grid-column: span 12; }
}

/* Timing fields */
.field { display: flex; flex-direction: column; gap: 6px; margin: 0; }
.field .label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  font-weight: 900;
  margin: 0;
}
.field .control { position: relative; }
.field .input {
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: 12px 14px;
  font-size: 16px;
  font-weight: 900;
  font-variant-numeric: tabular-nums;
  color: var(--text-primary);
  text-align: center;
  outline: none;
  transition: all 0.2s;
  width: 100%;
}
.field .input:focus {
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-actions {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 6px;
  margin-top: 6px;
}
.btn-actions .button {
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  padding: 8px;
  font-size: 13px;
  font-weight: 900;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}
.btn-actions .button:hover {
  background: var(--accent-blue);
  color: white;
  border-color: var(--accent-blue);
  transform: translateY(-1px);
}
.btn-actions .button.is-link {
  background: var(--accent-blue);
  color: white;
  border-color: var(--accent-blue);
}
.btn-actions .button.is-link:hover {
  background: #2563eb;
  border-color: #2563eb;
}

/* Cards */
.card { background: var(--bg-primary); border-radius: var(--radius-md); margin-bottom: var(--space-md); }
.card:last-child { margin-bottom: 0; }
.card-content { padding: var(--space-md); }
.mb-4 { margin-bottom: var(--space-md); }

/* ===============================================
   FORM SECTION
   =============================================== */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-md);
}
.form-grid.single { grid-template-columns: 1fr; }

.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.full { grid-column: 1 / -1; }

.form-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  font-weight: 900;
}

.form-input,
.form-select {
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: 12px 14px;
  font-size: 15px;
  font-weight: 800;
  color: var(--text-primary);
  outline: none;
  transition: all 0.2s;
}

.form-input:focus,
.form-select:focus {
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input.uppercase,
.form-textarea.uppercase { text-transform: uppercase; }

.form-textarea {
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: 12px 14px;
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
  outline: none;
  min-height: 100px;
  resize: vertical;
  font-family: inherit;
  transition: all 0.2s;
}
.form-textarea:focus {
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* ===============================================
   LOAD BUTTON
   =============================================== */
.load-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: var(--radius-md);
  padding: 16px;
  color: white;
  font-size: 15px;
  font-weight: 900;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: var(--shadow-md);
  width: 100%;
}
.load-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

/* ===============================================
   ACTION BUTTONS
   =============================================== */
.actions-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-light);
  padding: var(--space-sm);
  box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
  z-index: 99;
}

.actions-grid {
  max-width: 600px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: var(--space-xs);
}

.action-btn {
  border: none;
  border-radius: var(--radius-md);
  padding: 14px 12px;
  font-size: 13px;
  font-weight: 900;
  letter-spacing: 0.3px;
  cursor: pointer;
  transition: all 0.15s;
  text-transform: uppercase;
}
.action-btn.validate { background: var(--accent-green); color: white; }
.action-btn.save { background: var(--accent-blue); color: white; }
.action-btn.reset { background: var(--bg-primary); color: var(--accent-red); border: 1px solid var(--border-light); }
.action-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

/* ===============================================
   MODALS
   =============================================== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  z-index: 200;
  display: none;
}
.modal-backdrop.active { display: block; }

.modal {
  position: fixed;
  inset: 0;
  z-index: 201;
  display: none;
  overflow-y: auto;
  padding: var(--space-md);
}
.modal.active { display: block; }

/* ‚úÖ fix iOS/Android: centrer propre + √©viter le ‚Äúscroll derri√®re‚Äù */
.modal-content {
  max-width: 600px;
  margin: var(--space-lg) auto;
  background: var(--bg-primary);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  overflow: hidden; /* √©vite les d√©bordements sur header/tabs arrondis */
}

.modal-header {
  padding: var(--space-md);
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-sm);
}
.modal-title { font-size: 18px; font-weight: 900; color: var(--text-primary); }

.modal-close {
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 800;
  color: var(--text-secondary);
  cursor: pointer;
}

.modal-tabs {
  display: flex;
  gap: var(--space-xs);
  padding: var(--space-sm);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-light);
}
.modal-tab {
  flex: 1;
  background: transparent;
  border: none;
  border-radius: var(--radius-md);
  padding: 10px;
  font-size: 13px;
  font-weight: 900;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}
.modal-tab.active { background: var(--accent-blue); color: white; }

.modal-body {
  padding: var(--space-md);
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}

.modal-section {
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  margin-bottom: var(--space-md);
}
.modal-section-title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  font-weight: 900;
  margin-bottom: var(--space-md);
}

.pax-input-group { display: flex; align-items: center; gap: var(--space-sm); }
.pax-plus { font-size: 18px; font-weight: 900; color: var(--text-muted); }

.modal-grid-4 {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-sm);
}
@media (max-width: 600px) {
  .modal-grid-4 { grid-template-columns: repeat(2, 1fr); }
}

/* ===============================================
   COLLAPSIBLE
   =============================================== */
.collapsible-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-md);
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-md);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s;
}
.collapsible-header:hover { box-shadow: var(--shadow-md); }

.collapsible-title {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-primary);
  font-weight: 900;
}

.collapsible-icon {
  font-size: 20px;
  color: var(--text-muted);
  transition: transform 0.2s;
}
.collapsible-header.collapsed .collapsible-icon { transform: rotate(-90deg); }

.collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
.collapsible-content.expanded { max-height: 2200px; }

/* ===============================================
   RESPONSIVE
   =============================================== */
@media (max-width: 480px) {
  :root { --header-height: 260px; }
  .airport-code { font-size: 20px; }
  .flight-time .value { font-size: 12px; }
  .status-time { font-size: 16px; }
  .header-meta { gap: 6px; }
  .meta-value { font-size: 10px; }
}

/* ===============================================
   DARK MODE
   =============================================== */
html.dark .modal-content { background: var(--bg-secondary); }
html.dark .status-card,
html.dark .form-input,
html.dark .form-select,
html.dark .form-textarea,
html.dark .field .input,
html.dark .btn-actions .button,
html.dark .card { background: var(--bg-primary); }
html.dark .action-btn.reset { background: var(--bg-primary); }
</style>
</head>

<body>

<!-- ===============================================
     TABS BAR
     =============================================== -->
<div class="tabs-bar" id="tabsBar">
  <div class="tabs-container" id="tabsContainer">
    <div class="tab-item active" data-tab="1">
      <span>FR 4521 ‚Üí 4522</span>
      <button class="tab-close" type="button" data-close-tab="1" aria-label="Fermer l‚Äôonglet">√ó</button>
    </div>
    <div class="tab-item" data-tab="2">
      <span>W6 3145 ‚Üí 3146</span>
      <button class="tab-close" type="button" data-close-tab="2" aria-label="Fermer l‚Äôonglet">√ó</button>
    </div>
    <button class="tab-add" type="button" id="tabAddBtn">+ Nouveau vol</button>
  </div>
</div>

<!-- ===============================================
     FIXED HEADER
     =============================================== -->
<div class="fixed-header" id="fixedHeader">
  <div class="header-container" id="headerClickArea" role="button" tabindex="0">
    <div class="flight-badge">
      <span id="headerCie">FR</span>
      <span id="headerNum">4521 ‚Üí 4522</span>
    </div>

    <div class="route-container">
      <div class="route-side left">
        <div class="airport-code" id="headerFrom">ORY</div>
        <div class="flight-time"><span class="label">SIBT</span><span class="value" id="headerSIBT">14:15</span></div>
        <div class="flight-time"><span class="label">AIBT</span><span class="value" id="headerAIBT">14:18</span></div>
      </div>

      <div class="route-center">
        <div class="status-badge ontime" id="statusBadge">‚óè √Ä l'heure</div>
        <div class="countdown-display" id="countdownDisplay">CD: <span id="countdownValue">--:--</span></div>
        <div class="route-arrow">‚Üí</div>
      </div>

      <div class="route-side right">
        <div class="airport-code" id="headerTo">PMI</div>
        <div class="flight-time"><span class="label">SOBT</span><span class="value" id="headerSOBT">15:30</span></div>
        <div class="flight-time"><span class="label">AOBT</span><span class="value" id="headerAOBT">15:33</span></div>
        <div class="flight-time"><span class="label">TOBT</span><span class="value" id="headerTOBT">15:30</span></div>
        <div class="flight-time"><span class="label">CTOT</span><span class="value editable-time" id="headerCTOT">15:45</span></div>
      </div>
    </div>

    <div class="header-meta">
      <div class="meta-item"><div class="meta-label">Immat</div><div class="meta-value" id="headerImmat">F-HBXL</div></div>
      <div class="meta-item"><div class="meta-label">Type</div><div class="meta-value" id="headerType">B738</div></div>
      <div class="meta-item"><div class="meta-label">Parking</div><div class="meta-value" id="headerParking">5</div></div>
      <div class="meta-item"><div class="meta-label">Salle Arr</div><div class="meta-value" id="headerSalle">A12</div></div>
      <div class="meta-item"><div class="meta-label">Date</div><div class="meta-value" id="headerDate">24 JAN</div></div>
    </div>

    <div class="edit-hint">‚úèÔ∏è Cliquer pour √©diter</div>
  </div>
</div>

<!-- ===============================================
     MAIN CONTENT
     =============================================== -->
<div class="app-container">

  <div class="status-section">
    <div class="section-title">√âtapes cl√©s</div>
    <div class="status-grid">
      <div class="status-card">
        <div class="status-label">HLE</div>
        <div class="status-time" id="statusHLE">14:30</div>
      </div>
      <div class="status-card">
        <div class="status-label">H-15</div>
        <div class="status-time" id="statusH15">15:15</div>
      </div>
      <div class="status-card warning">
        <div class="status-label">LID</div>
        <div class="status-time" id="statusLID">15:22</div>
      </div>
    </div>
  </div>

  <div class="timing-section">
    <div class="section-title">Timing</div>
    <div id="timing-grid"></div>
  </div>

  <div class="form-section">
    <button class="load-button" type="button" id="openLoadBtn">üìã Ouvrir LOAD</button>
  </div>

  <div class="collapsible-header collapsed" data-collapsible="retards">
    <div class="collapsible-title">Retards</div>
    <div class="collapsible-icon">‚åÑ</div>
  </div>
  <div class="collapsible-content" data-collapsible-content="retards">
    <div class="form-section" style="margin-top: calc(var(--space-md) * -1);">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">DL Code 1</label><input type="text" class="form-input" id="DLcode1" placeholder="32"></div>
        <div class="form-group"><label class="form-label">Dur√©e 1 (min)</label><input type="number" class="form-input" id="DLduree1" min="0" placeholder="15"></div>
        <div class="form-group"><label class="form-label">DL Code 2</label><input type="text" class="form-input" id="DLcode2"></div>
        <div class="form-group"><label class="form-label">Dur√©e 2 (min)</label><input type="number" class="form-input" id="DLduree2" min="0"></div>
        <div class="form-group"><label class="form-label">DL Code 3</label><input type="text" class="form-input" id="DLcode3"></div>
        <div class="form-group"><label class="form-label">Dur√©e 3 (min)</label><input type="number" class="form-input" id="DLduree3" min="0"></div>
      </div>
    </div>
  </div>

  <div class="collapsible-header collapsed" data-collapsible="faits">
    <div class="collapsible-title">Faits saillants</div>
    <div class="collapsible-icon">‚åÑ</div>
  </div>
  <div class="collapsible-content" data-collapsible-content="faits">
    <div class="form-section" style="margin-top: calc(var(--space-md) * -1);">
      <div class="form-grid single">
        <div class="form-group">
          <textarea class="form-textarea uppercase" id="FaitsSaillants" placeholder="Notez ici les faits saillants du vol..."></textarea>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ===============================================
     MODAL EDIT HEADER
     =============================================== -->
<div class="modal-backdrop" id="modalEditBackdrop"></div>
<div class="modal" id="modalEditHeader" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Modifier les informations vol</div>
      <button class="modal-close" type="button" id="closeEditBtn">Fermer</button>
    </div>

    <div class="modal-body">
      <div class="modal-section">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" id="EditDate" value="2026-01-24">
          </div>

          <div class="form-group">
            <label class="form-label">Compagnie</label>
            <select class="form-select" id="EditCie">
              <option selected>FR</option><option>RK</option><option>W4</option><option>W6</option>
              <option>H4</option><option>H6</option><option>U5</option><option>U7</option>
            </select>
          </div>

          <div class="form-group full">
            <label class="form-label">N¬∞ Vol</label>
            <input type="text" class="form-input uppercase" id="EditNVol" value="4521 ‚Üí 4522">
          </div>

          <div class="form-group">
            <label class="form-label">From</label>
            <input type="text" class="form-input uppercase" id="EditFrom" maxlength="3" value="ORY">
          </div>

          <div class="form-group">
            <label class="form-label">To</label>
            <input type="text" class="form-input uppercase" id="EditTo" maxlength="3" value="PMI">
          </div>

          <div class="form-group"><label class="form-label">SIBT</label><input type="time" class="form-input" id="EditSIBT" value="14:15"></div>
          <div class="form-group"><label class="form-label">AIBT</label><input type="time" class="form-input" id="EditAIBT" value="14:18"></div>
          <div class="form-group"><label class="form-label">SOBT</label><input type="time" class="form-input" id="EditSOBT" value="15:30"></div>
          <div class="form-group"><label class="form-label">AOBT</label><input type="time" class="form-input" id="EditAOBT" value="15:33"></div>

          <div class="form-group"><label class="form-label">Immat</label><input type="text" class="form-input uppercase" id="EditImmat" maxlength="6" value="F-HBXL"></div>

          <div class="form-group">
            <label class="form-label">Type</label>
            <select class="form-select" id="EditType">
              <option>A319</option><option>A320</option><option>A321</option>
              <option>A20N</option><option>A21N</option><option>A21NY</option>
              <option>B734</option><option>B737</option><option selected>B738</option>
              <option>B38M</option><option>BCS3</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Parking</label>
            <select class="form-select" id="EditParking">
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option selected>5</option><option>6</option><option>7</option><option>8</option>
              <option>9</option><option>10</option><option>11</option><option>12</option>
            </select>
          </div>

          <div class="form-group"><label class="form-label">Salle Arr</label><input type="text" class="form-input uppercase" id="EditSalle" value="A12"></div>
          <div class="form-group"><label class="form-label">TOBT</label><input type="time" class="form-input" id="EditTOBT" value="15:30"></div>
          <div class="form-group"><label class="form-label">CTOT</label><input type="time" class="form-input" id="EditCTOT" value="15:45"></div>

          <div class="form-group full">
            <button class="load-button" type="button" id="saveEditBtn">üíæ Enregistrer</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===============================================
     MODAL LOAD
     =============================================== -->
<div class="modal-backdrop" id="modalLoadBackdrop"></div>
<div class="modal" id="modalLoad" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">LOAD</div>
      <button class="modal-close" type="button" id="closeLoadBtn">Fermer</button>
    </div>

    <div class="modal-tabs">
      <button class="modal-tab active" type="button" id="tabArr" data-load-tab="arr">ARR</button>
      <button class="modal-tab" type="button" id="tabFinal" data-load-tab="final">FINAL</button>
    </div>

    <div class="modal-body">
      <div id="contentArr">
        <div class="modal-section">
          <div class="modal-section-title">Arriv√©e</div>
          <div class="form-grid">
            <div class="form-group full">
              <label class="form-label">PAX (Adultes + Enfants)</label>
              <div class="pax-input-group">
                <input type="text" class="form-input has-text-centered" id="ArrPAX_MAIN" maxlength="4" placeholder="150">
                <span class="pax-plus">+</span>
                <input type="text" class="form-input has-text-centered" id="ArrPAX_INF" maxlength="3" placeholder="5">
              </div>
            </div>
            <div class="form-group"><label class="form-label">BAGS</label><input type="text" class="form-input has-text-centered" id="ArrBAGS" maxlength="4" placeholder="120"></div>
            <div class="form-group"><label class="form-label">POIDS (kg)</label><input type="text" class="form-input has-text-centered" id="ArrPOIDS" maxlength="4" placeholder="2400"></div>
            <div class="form-group full"><label class="form-label">SI</label><textarea class="form-textarea uppercase" id="ArrSI" placeholder="Informations sp√©ciales..."></textarea></div>
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Pr√©visionnel</div>
          <div class="form-grid">
            <div class="form-group full">
              <label class="form-label">PAX (Adultes + Enfants)</label>
              <div class="pax-input-group">
                <input type="text" class="form-input has-text-centered" id="PreviPAX_MAIN" maxlength="4" placeholder="155">
                <span class="pax-plus">+</span>
                <input type="text" class="form-input has-text-centered" id="PreviPAX_INF" maxlength="3" placeholder="6">
              </div>
            </div>
            <div class="form-group"><label class="form-label">BAGS</label><input type="text" class="form-input has-text-centered" id="PreviBAGS" maxlength="4" placeholder="130"></div>
            <div class="form-group"><label class="form-label">POIDS (kg)</label><input type="text" class="form-input has-text-centered" id="PreviPOIDS" maxlength="4" placeholder="2600"></div>
            <div class="form-group full"><label class="form-label">SI</label><textarea class="form-textarea uppercase" id="PreviSI" placeholder="Informations sp√©ciales..."></textarea></div>
          </div>
        </div>
      </div>

      <div id="contentFinal" style="display:none;">
        <div class="modal-section">
          <div class="modal-section-title">Load Final</div>
          <div class="form-grid">
            <div class="form-group"><label class="form-label">MALE</label><input type="text" class="form-input has-text-centered" id="FinalMALE" maxlength="4" placeholder="75"></div>
            <div class="form-group"><label class="form-label">FEMALE</label><input type="text" class="form-input has-text-centered" id="FinalFEMALE" maxlength="4" placeholder="80"></div>
            <div class="form-group"><label class="form-label">ADULT</label><input type="text" class="form-input has-text-centered" id="FinalADULT" maxlength="4" placeholder="150"></div>
            <div class="form-group"><label class="form-label">CHILD</label><input type="text" class="form-input has-text-centered" id="FinalCHILD" maxlength="4" placeholder="5"></div>
            <div class="form-group"><label class="form-label">INFANT</label><input type="text" class="form-input has-text-centered" id="FinalINFANT" maxlength="4" placeholder="3"></div>
            <div class="form-group"><label class="form-label">TOB</label><input type="text" class="form-input has-text-centered" id="FinalTOB" readonly placeholder="158"></div>

            <div class="form-group full">
              <label class="form-label">OVERCOST</label>
              <div class="modal-grid-4">
                <input type="text" class="form-input has-text-centered" id="FinalOA" maxlength="4" placeholder="OA">
                <input type="text" class="form-input has-text-centered" id="FinalOB" maxlength="4" placeholder="OB">
                <input type="text" class="form-input has-text-centered" id="FinalOC" maxlength="4" placeholder="OC">
                <input type="text" class="form-input has-text-centered" id="FinalOD" maxlength="4" placeholder="OD">
              </div>
            </div>

            <div class="form-group"><label class="form-label">BAGS</label><input type="text" class="form-input has-text-centered" id="FinalBAGS" maxlength="4" placeholder="135"></div>
            <div class="form-group"><label class="form-label">POIDS (kg)</label><input type="text" class="form-input has-text-centered" id="FinalPOIDS" readonly placeholder="2700"></div>

            <div class="form-group full"><label class="form-label">GB / ITG</label><input type="text" class="form-input has-text-centered" id="FinalGB" maxlength="4" placeholder="50"></div>

            <div class="form-group full">
              <label class="form-label">HOLD BAGS</label>
              <div class="modal-grid-4">
                <input type="text" class="form-input has-text-centered" id="FinalH1" maxlength="4" placeholder="H1">
                <input type="text" class="form-input has-text-centered" id="FinalH2" maxlength="4" placeholder="H2">
                <input type="text" class="form-input has-text-centered" id="FinalH3" maxlength="4" placeholder="H3">
                <input type="text" class="form-input has-text-centered" id="FinalH4" maxlength="4" placeholder="H4">
              </div>
            </div>

            <div class="form-group full"><label class="form-label">SI</label><textarea class="form-textarea uppercase" id="FinalSI" placeholder="Informations sp√©ciales..."></textarea></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ===============================================
     ACTIONS BAR
     =============================================== -->
<div class="actions-bar">
  <div class="actions-grid">
    <button class="action-btn validate" type="button">‚úì Valider</button>
    <button class="action-btn save" type="button">üíæ Sauver</button>
    <button class="action-btn reset" type="button">üîÑ Reset</button>
  </div>
</div>

<script>
  
/* Collapse */
function toggleCardBody(headerEl){
  const card = headerEl.closest('.card');
  if(!card) return;
  const content = card.querySelector('.card-content');
  if(!content) return;
  const collapsed = content.classList.toggle('collapsed-body');
  const icon = headerEl.querySelector('.icon');
  if(icon) icon.textContent = collapsed ? '‚Ä∫' : '‚åÑ';
}

let _scrollY = 0;

function lockScroll(){
  _scrollY = window.scrollY || document.documentElement.scrollTop || 0;

  document.documentElement.classList.add('modal-open');
  document.body.classList.add('modal-open');

  // iOS-proof
  document.body.style.position = 'fixed';
  document.body.style.top = `-${_scrollY}px`;
  document.body.style.left = '0';
  document.body.style.right = '0';
  document.body.style.width = '100%';
}

function unlockScroll(){
  document.documentElement.classList.remove('modal-open');
  document.body.classList.remove('modal-open');

  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.left = '';
  document.body.style.right = '';
  document.body.style.width = '';

  window.scrollTo(0, _scrollY);
}

/* Header height */
function updateHeaderOffset(){
  const header = document.getElementById('fixedHeader');
  if(!header) return;
  const h = Math.ceil(header.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--fixed-header-h', h + 'px');
}

/* Vars */
let isUTC=false;
let manualSOBT=false;
let currentTabId=null;
let saveTimer=null;

let settingFromAK = false;

/* ===== AK managed fields helpers ===== */
function isEmptyVal(el){
  return !el || ((el.value || '').trim() === '');
}

function setValAK(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  settingFromAK = true;
  el.value = (typeof v === 'string') ? (v ?? '').toUpperCase() : (v ?? '');
  el.dataset.ak = '1';
  el.dispatchEvent(new Event('input',  { bubbles:true }));
  el.dispatchEvent(new Event('change', { bubbles:true }));
  settingFromAK = false;
}

function setTimeFromISOAK(id, iso){
  if(!iso) return;
  const d = new Date(iso);
  if(isNaN(d.getTime())) return;

  const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
  const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');

  setValAK(id, `${hh}:${mm}`);
}

function setTimeFromISOIfEmptyOrAK(id, iso){
  const el = document.getElementById(id);
  if(!el) return;
  if(isEmptyVal(el) || el.dataset.ak === '1'){
    setTimeFromISOAK(id, iso);
  }
}

function setIfEmptyOrAK(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  // si champ vide OU d√©j√† pilot√© AK -> on √©crase
  if(isEmptyVal(el) || el.dataset.ak === '1'){
    setValAK(id, (v ?? ''));
  }
}

/* Si l'utilisateur modifie un champ manuellement -> il n'est plus pilot√© AK */
document.addEventListener('input', (e)=>{
  const t = e.target;
  if(!t || !t.dataset) return;
  if(settingFromAK) return;
  if(t.dataset.ak === '1') delete t.dataset.ak;
}, true);

/* Timeline */
let timelineZoom = 1;
const TL_ZOOM_MIN = 0.5;
const TL_ZOOM_MAX = 8;
const TL_ZOOM_STEP = 0.25;
window._timelineCurrentRange = null;

/* TOBT brut + TOBT affich√© */
window._tobtRawMins = null;
window._tobtAdjMins = null;

/* DL */
let lastDLChanged = 1;

/* digits only */
function digitsOnly(el){ el.value = (el.value || '').replace(/[^0-9]/g,''); }

/* ===== H1‚ÄìH4 vs BAGS (ARR / EXP / FINAL) ===== */
function updateHBagsValidity(mode){
  if(mode !== 'final') return;

  const bagsEl = document.getElementById('FinalBAGS');
  if(!bagsEl) return;

  const bags = parseInt(bagsEl.value || '0', 10);
  const ids = ['FinalH1','FinalH2','FinalH3','FinalH4'];

  let sum = 0;
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) sum += parseInt(el.value || '0', 10);
  });

  bagsEl.classList.toggle('is-invalid', bags > 0 && sum !== bags);
}

/* ===== POIDS auto FR / RK : (BAGS + GB) * 13 ===== */
function updateFinalWeightIfNeeded(){
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  if(cie !== 'FR' && cie !== 'RK') return;

  const bags = parseInt(document.getElementById('FinalBAGS')?.value || '0', 10);
  const gb   = parseInt(document.getElementById('FinalGB')?.value   || '0', 10);

  const poids = (bags + gb) * 13;
  const poidsEl = document.getElementById('FinalPOIDS');
  if(!poidsEl) return;

  if(
    (document.getElementById('FinalBAGS')?.value || '') === '' &&
    (document.getElementById('FinalGB')?.value || '') === ''
  ){
    poidsEl.value = '';
    return;
  }

  poidsEl.value = String(poids);
}

/* ===== POIDS auto FR / RK : ARR + EXP ===== */
function updateArrExpWeightIfNeeded(){
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  if(cie !== 'FR' && cie !== 'RK') return;

  // EXP uniquement (ARR d√©sactiv√©)
  const bagsExp = asInt('ExpBAGS');
  const poidsExpEl = document.getElementById('ExpPOIDS');
  if(bagsExp != null && poidsExpEl && poidsExpEl.value === ''){
    poidsExpEl.value = String(bagsExp * 13);
  }
}

/* ===== COUNTDOWN (CD) ===== */
let countdownTimer = null;

function getNowMinutes(){
  const now = new Date();
  const h = isUTC ? now.getUTCHours() : now.getHours();
  const m = isUTC ? now.getUTCMinutes() : now.getMinutes();
  const s = isUTC ? now.getUTCSeconds() : now.getSeconds();
  return { mins: h*60 + m, secs: s };
}

function fmtMMSSSigned(totalSeconds){
  const isOver = totalSeconds < 0;
  const abs = Math.abs(totalSeconds);

  const mm = Math.floor(abs / 60);
  const ss = abs % 60;

  return `${isOver ? '+' : ''}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}

function stopCountdown(resetDisplay=true){
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
  const el = document.getElementById('timer-cd');
  if(!el) return;
  if(resetDisplay){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
  }
}

function freezeCountdown(){
  // on coupe juste l'interval, on ne touche pas au texte affich√©
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
}

function updateCountdownOnce(){
  const el = document.getElementById('timer-cd');
  if(!el) return;

  const sibtTxt = document.getElementById('SIBT')?.value || '';
  const aibtTxt = document.getElementById('AIBT')?.value || '';
  const sobtTxt = document.getElementById('SOBT')?.value || '';
  const aobtTxt = document.getElementById('AOBT')?.value || '';

  if(!aibtTxt || !sobtTxt || !sibtTxt){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
    return;
  }

  const SIBT = parseHHMM(sibtTxt);
  const AIBT = parseHHMM(aibtTxt);
  const SOBT = parseHHMM(sobtTxt);
  if(SIBT == null || AIBT == null || SOBT == null){
    el.textContent = '--:--';
    el.classList.remove('cd-over');
    return;
  }

  // cible = SOBT si retard AIBT<=SIBT, sinon TOBT adj
  let targetMin = null;
  if (AIBT <= SIBT) targetMin = SOBT;
  else {
    const tobt = window._tobtAdjMins;
    if(tobt == null){
      el.textContent = '--:--';
      el.classList.remove('cd-over');
      return;
    }
    targetMin = tobt;
  }

  // ===== CAS AOBT : on fige MAIS on recalcule selon AOBT =====
  if(aobtTxt){
    const AOBT = parseHHMM(aobtTxt);
    if(AOBT == null){
      el.textContent = '--:--';
      el.classList.remove('cd-over');
      return;
    }

    // diff = AOBT - cible (sign√©, g√®re minuit)
    let diffMin = AOBT - targetMin;
    if(diffMin > 720) diffMin -= 1440;
    if(diffMin < -720) diffMin += 1440;

    const totalSeconds = diffMin * 60;
    const sign = totalSeconds >= 0 ? '+' : '-';
    const abs = Math.abs(totalSeconds);
    const mm = Math.floor(abs / 60);
    const ss = abs % 60;

    el.textContent = `${sign}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;

    // rouge si + (retard)
    el.classList.toggle('cd-over', totalSeconds > 0);
    return;
  }

  // ===== CAS NORMAL : live avec NOW (d√©compte puis +) =====
  const now = getNowMinutes();

  let diffMin = targetMin - now.mins;
  if(diffMin < -720) diffMin += 1440;
  if(diffMin > 720) diffMin -= 1440;

  const remainingSeconds = diffMin * 60 - now.secs;

  const sign = remainingSeconds <= 0 ? '+' : ''; // quand on d√©passe => +
  const abs = Math.abs(remainingSeconds);
  const mm = Math.floor(abs / 60);
  const ss = abs % 60;

  el.textContent = `${sign}${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  el.classList.toggle('cd-over', remainingSeconds < 0); // rouge quand on est pass√© √† +
}

function ensureCountdownRunning(){
  const sibtTxt = document.getElementById('SIBT')?.value || '';
  const aibtTxt = document.getElementById('AIBT')?.value || '';
  const sobtTxt = document.getElementById('SOBT')?.value || '';
  const aobtTxt = document.getElementById('AOBT')?.value || '';

  const baseOK = !!(sibtTxt && aibtTxt && sobtTxt);

  // Si AOBT est rempli : pas d'interval, mais on recalcule l'affichage (donc √ßa suit si tu modifies AOBT)
  if(baseOK && aobtTxt){
    freezeCountdown();
    updateCountdownOnce();
    return;
  }

  // Si base incompl√®te : on stop + reset
  if(!baseOK){
    stopCountdown(true);
    return;
  }

  // Live
  if(!countdownTimer){
    updateCountdownOnce();
    countdownTimer = setInterval(updateCountdownOnce, 1000);
  } else {
    updateCountdownOnce();
  }
}

/* Timeline zoom */
function timelineZoomIn(){ timelineSetZoom(timelineZoom + TL_ZOOM_STEP); }
function timelineZoomOut(){ timelineSetZoom(timelineZoom - TL_ZOOM_STEP); }
function timelineZoomReset(){ timelineSetZoom(1); }
function timelineSetZoom(z){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;
  const prevCenterRatio = (scroller.scrollLeft + scroller.clientWidth/2) / Math.max(1, scroller.scrollWidth);
  timelineZoom = Math.max(TL_ZOOM_MIN, Math.min(TL_ZOOM_MAX, z));
  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
  renderTimeline();
  scroller.scrollLeft = prevCenterRatio * scroller.scrollWidth - scroller.clientWidth/2;
}

/* ===== LOAD MODAL (single fullscreen) ===== */
function openLoadModal(mode='arr'){
  const b = document.getElementById('loadBackdrop');
  const m = document.getElementById('loadModal');
  if(b) b.style.display = '';
  if(m) m.style.display = 'flex';
  switchLoadPanel(mode);
}

function closeLoadModal(){
  const b = document.getElementById('loadBackdrop');
  const m = document.getElementById('loadModal');
  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}

function switchLoadPanel(mode){
  const pArr   = document.getElementById('lmPanelArr');
  const pExp   = document.getElementById('lmPanelExp');
  const pFinal = document.getElementById('lmPanelFinal');

  const tArr   = document.getElementById('lmTabArr');
  const tExp   = document.getElementById('lmTabExp');
  const tFinal = document.getElementById('lmTabFinal');

  if(pArr)   pArr.style.display   = (mode==='arr')   ? '' : 'none';
  if(pExp)   pExp.style.display   = (mode==='exp')   ? '' : 'none';
  if(pFinal) pFinal.style.display = (mode==='final') ? '' : 'none';

  if(tArr)   tArr.classList.toggle('is-active', mode==='arr');
  if(tExp)   tExp.classList.toggle('is-active', mode==='exp');
  if(tFinal) tFinal.classList.toggle('is-active', mode==='final');

  const hint = document.getElementById('lmHint');
  if(hint){
    if(mode==='arr') hint.textContent = 'ARRIV√âE';
    if(mode==='exp') hint.textContent = 'EXPLOITATION';
    if(mode==='final') hint.textContent = 'FINAL';
  }

  if(mode === 'final') updateFinalTOB();
  updateHeaderOffset();
}

/* ===== LDM modal ===== */

let _ldmMode = 'arr';

function openLDM(mode='arr'){
  const b = document.getElementById('ldmBackdrop');
  const m = document.getElementById('ldmModal');

  lockScroll();

  if(b) b.style.display = '';
  if(m) m.style.display = 'flex';

  ldmSwitch(mode);
  updateHeaderOffset();
}

function closeLDM(){
  const b = document.getElementById('ldmBackdrop');
  const m = document.getElementById('ldmModal');

  unlockScroll();

  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}

function ldmSwitch(mode){
  _ldmMode = mode;

  const sArr   = document.getElementById('ldmArr');
  const sFinal = document.getElementById('ldmFinal');

  const tArr   = document.getElementById('ldmTabArr');
  const tFinal = document.getElementById('ldmTabFinal');

  if(sArr)   sArr.style.display   = (mode==='arr')   ? '' : 'none';
  if(sFinal) sFinal.style.display = (mode==='final') ? '' : 'none';

  if(tArr)   tArr.classList.toggle('is-active', mode==='arr');
  if(tFinal) tFinal.classList.toggle('is-active', mode==='final');

  const hint = document.getElementById('ldmHint');
  if(hint){
    hint.textContent = (mode==='arr') ? 'LOAD' : 'FINAL';
  }

  if(mode==='final') updateFinalTOB();
  updateHeaderOffset();
}


/* compat anciens boutons (optionnel) */
function toggleLoadArr(){ openLDM('arr'); }
function toggleLoadExp(){ openLDM('exp'); }
function toggleLoadFinal(){ openLDM('final'); }

/* ===== FINAL : calcul ADULT + TOB + contr√¥le OA/OB/OC/OD ===== */
function asInt(id){
  const v = (document.getElementById(id)?.value || '').trim();
  if(v === '') return null;
  const n = parseInt(v,10);
  return isNaN(n) ? null : n;
}
function syncAdultIfNeeded(){
  const m = asInt('FinalMALE');
  const f = asInt('FinalFEMALE');
  const adultEl = document.getElementById('FinalADULT');
  if(!adultEl) return;

  if(m != null && f != null){
    adultEl.value = String(m + f);
    adultEl.readOnly = true;
  }else{
    adultEl.readOnly = false;
  }
}
function setTOBValidity(isValid){
  const tobEl = document.getElementById('FinalTOB');
  if(!tobEl) return;
  tobEl.classList.toggle('is-invalid', !isValid);
  tobEl.classList.toggle('is-valid', isValid);
}
function updateFinalTOB(){
  syncAdultIfNeeded();

  const m = asInt('FinalMALE');
  const f = asInt('FinalFEMALE');
  const a = asInt('FinalADULT');
  const c = asInt('FinalCHILD')  ?? 0;
  const i = asInt('FinalINFANT') ?? 0;

  let main = null; // TOB sans infant
  if(m != null && f != null) main = (m + f) + c;
  else if(a != null) main = a + c;

  const tobEl = document.getElementById('FinalTOB');
  if(!tobEl) return;

  if(main == null){
    tobEl.value = '';
    setTOBValidity(true);
    return;
  }

  tobEl.value = `${main} + ${i}`;

  const oa = asInt('FinalOA') ?? 0;
  const ob = asInt('FinalOB') ?? 0;
  const oc = asInt('FinalOC') ?? 0;
  const od = asInt('FinalOD') ?? 0;
  const sum = oa + ob + oc + od;

  setTOBValidity(sum === main);
}

function refreshUIForTabs(){
  const tabsLS = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  const hasTab = Array.isArray(tabsLS) && tabsLS.length > 0;

  document.body.classList.toggle('has-tab', hasTab);
  document.body.classList.toggle('no-tab', !hasTab);

  if(!hasTab){
    currentTabId = null;
    closeAKPicker();
    stopCountdown(true);
  }
}

/* INIT */
function initForm(){
  // 1) Cr√©er d‚Äôabord tout le DOM dynamique (sinon loadTabData() ne peut pas restaurer)
  generateTimingFields();

  // 2) UI tabs
  renderTabs();
  refreshUIForTabs();

  // 3) Autosave + unload
  attachAutoSave();
  window.addEventListener('beforeunload', saveCurrentTabData);

  // 4) Listeners (inchang√©)
  document.getElementById('Parking')?.addEventListener('change', updateTabLabelInstant);
  document.getElementById('Cie')?.addEventListener('change', ()=>{
    updateTabLabelInstant();
    updateAllCalculations();
  });
  document.getElementById('NVol')?.addEventListener('input', updateTabLabelInstant);
  document.getElementById('To')?.addEventListener('input', updateTabLabelInstant);

  setupUppercaseInputs(['NVol','From','To','Immat','BorderControl']);

  // 5) Modes persist√©s (inchang√©)
  const storedDark = (localStorage.getItem('modeDark')||'0') === '1';
  const storedUTC  = (localStorage.getItem('modeUTC')||'0') === '1';
  setDarkMode(storedDark, true);
  setTimeModeUTC(storedUTC, true);

  // 6) Listeners "input" globaux (inchang√©)
  [
    'AIBT','SOBT','SIBT','AOBT','CTOT','ArrPNT','ArrPNC','TypeAvion',

    // LOAD (ARR+EXP fusionn√©)
    'LoadPAX_MAIN','LoadPAX_INF','LoadBAGS','LoadPOIDS',

    // FINAL
    'FinalMALE','FinalFEMALE','FinalADULT','FinalCHILD','FinalINFANT',
    'FinalOA','FinalOB','FinalOC','FinalOD',
    'FinalBAGS','FinalPOIDS','FinalGB'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', ()=>{
      updateAllCalculations();
      updateFinalTOB();
    });
  });

  [
    // H-bags seulement pour FINAL
    'FinalBAGS','FinalH1','FinalH2','FinalH3','FinalH4',
    'FinalGB'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', updateAllCalculations);
  });

  // 7) Drag scroll timeline (inchang√©)
  const scroller = document.getElementById('timelineScroll');
  if(scroller){
    let isDown=false, startX=0, startLeft=0;
    scroller.addEventListener('mousedown', e=>{
      isDown=true; startX=e.clientX; startLeft=scroller.scrollLeft;
    });
    scroller.addEventListener('mouseleave', ()=>{ isDown=false; });
    scroller.addEventListener('mouseup', ()=>{ isDown=false; });
    scroller.addEventListener('mousemove', e=>{
      if(!isDown) return;
      const dx = e.clientX - startX;
      scroller.scrollLeft = startLeft - dx;
      e.preventDefault();
    });
    ['wheel','mousedown','touchstart','keydown','scroll'].forEach(ev=>{
      scroller.addEventListener(ev, ()=>{ timelineUserScrolled = true; }, {passive:true});
    });
  }

  // 8) S√©lection onglet APR√àS que le DOM soit pr√™t
  const lastTab = String(localStorage.getItem('lastTabId') || '');
  const tabsLS  = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  const tabs = Array.isArray(tabsLS) ? tabsLS.map(String) : [];

  if(tabs.length > 0){
    if(lastTab && tabs.includes(lastTab)){
      switchTab(lastTab);
    }else{
      switchTab(tabs[0]);
    }
  }else{
    currentTabId = null;
    stopCountdown();
  }

  // 9) Final init (inchang√©)
  setDefaultDateToTodayIfEmpty();

  updateHeaderOffset();
  window.addEventListener('resize', ()=>{
    updateHeaderOffset();
    renderTimeline();
  });

  renderTimeline();
  refreshUIForTabs();
  updateFinalTOB();
}

function updateInfoStrip(){
  const v = (id) => (document.getElementById(id)?.value || '').toUpperCase().trim();
  const set = (id, txt, def='‚Äî') => {
    const el = document.getElementById(id);
    if(!el) return;
    const t = (txt ?? '').toString().trim();
    el.textContent = t ? t : def;
  };

  // --- r√©cup tab data (akMeta + champs) depuis le nouveau syst√®me ---
  let data = {};
  try{
    if(currentTabId){
      data = JSON.parse(localStorage.getItem('tab-'+String(currentTabId)) || '{}') || {};
    }
  }catch(e){ data = {}; }

  const ak = (data.akMeta || {});

  // ----- vols ARR/DEP + BC depuis akMeta (prioritaire) -----
  let arrFF  = (ak.arrFF || '').toUpperCase().trim();
  let depFF  = (ak.depFF || '').toUpperCase().trim();
  let bcMeta = (ak.bc    || '').toUpperCase().trim();

  // fallback DEP : CIE + N¬∞
  if(!depFF){
    const cie  = v('Cie');
    const nvol = v('NVol').replace(/\s+/g,''); // √©vite espaces (ex "4521 ‚Üí 4522")
    if(cie || nvol) depFF = `${cie}${nvol}`.trim();
  }

  // Fallback ARR si pas fourni : on affiche "‚Äî"
  set('kvArrVol', arrFF, '‚Äî');
  set('kvDepVol', depFF, '‚Äî');

  set('kvFrom',  v('From')  || '---', '---');
  set('kvTo',    v('To')    || '---', '---');

  set('kvImmat', v('Immat')     || '------', '------');
  set('kvType',  v('TypeAvion') || '----',   '----');

  // BC : plus de champ BorderControl -> akMeta.bc uniquement
  set('kvBC', bcMeta || '--', '--');

  set('kvPark', v('Parking') || '--', '--');
}

/* date d√©faut */
function setDefaultDateToTodayIfEmpty(){
  const d = document.getElementById('Date');
  if(d && !d.value){
    d.value = new Date().toISOString().slice(0,10);
  }
}

/* uppercase */
function setupUppercaseInputs(ids){
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const toUpper = ()=>{ el.value = (el.value||'').toUpperCase(); };
    el.addEventListener('input', toUpper);
    el.addEventListener('blur', toUpper);
  });
}

/* Autosave */
function attachAutoSave(){
  const handler=()=>{
    clearTimeout(saveTimer);
    saveTimer=setTimeout(()=>{
      saveCurrentTabData();
      renderTimeline();
      updateHeaderOffset();
      updateInfoStrip();   // ‚úÖ strip toujours √† jour
    }, 300);
  };
  document.addEventListener('input', handler, true);
  document.addEventListener('change', handler, true);
}

/* Tabs (NOUVELLE UI: tabs-bar / tabsContainer) */
function renderTabs(){
  const container = document.getElementById('tabsContainer');
  if(!container) return;

  // garde le bouton + s'il existe
  const addBtn = document.getElementById('tabAddBtn');

  // purge tous les onglets (sauf bouton +)
  Array.from(container.querySelectorAll('.tab-item')).forEach(n=>n.remove());
  // on r√©-attache le bouton + √† la fin
  if(addBtn) container.appendChild(addBtn);

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  tabs.forEach((id)=>{
    const data = JSON.parse(localStorage.getItem('tab-'+id) || '{}');

    const cie  = (data.Cie  || '').toUpperCase().trim();
    const nvol = (data.NVol || '').toUpperCase().trim();
    const to   = (data.To   || '').toUpperCase().trim();

    const left = `${cie}${nvol}`.trim();
    const label =
      (left || to) ? (to ? `${left} ‚Üí ${to}`.trim() : left) : 'VOL';

    const tab = document.createElement('div');
    tab.className = `tab-item ${String(id) === String(currentTabId) ? 'active' : ''}`;
    tab.dataset.tab = String(id);

    const span = document.createElement('span');
    span.textContent = label || 'VOL';

    const close = document.createElement('button');
    close.className = 'tab-close';
    close.type = 'button';
    close.dataset.closeTab = String(id);
    close.setAttribute('aria-label', 'Fermer l‚Äôonglet');
    close.textContent = '√ó';

    tab.appendChild(span);
    tab.appendChild(close);

    // click onglet
    tab.addEventListener('click', (e)=>{
      // si click sur la croix -> delete
      if(e.target === close) return;
      switchTab(String(id));
    });

    // delete via croix
    close.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      deleteTab(String(id));
    });

    // insertion avant le bouton +
    if(addBtn) container.insertBefore(tab, addBtn);
    else container.appendChild(tab);
  });

  updateHeaderOffset();
}

function createNewTab(){
  const id = String(Date.now());

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];
  if(!tabs.includes(id)) tabs.push(id);
  localStorage.setItem('flightTabs', JSON.stringify(tabs));

  currentTabId = id;
  localStorage.setItem('lastTabId', id);

  clearFormFields();

  // snapshot initial (ne touche pas aux modals si elles ont des ids)
  const data = JSON.parse(localStorage.getItem('tab-'+id) || '{}') || {};
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;
    data[el.id] = (el.type === 'checkbox') ? (el.checked ? '1' : '0') : (el.value || '');
  });
  data.infovolOpen = '0';

  localStorage.setItem('tab-'+id, JSON.stringify(data));

  renderTabs();
  refreshUIForTabs();
  updateInfoStrip();
  renderTimeline();
}

function switchTab(id){
  stopCountdown();
  saveCurrentTabData();

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  id = String(id);
  if(!tabs.includes(id)) return;

  currentTabId = id;
  localStorage.setItem('lastTabId', id);

  loadTabData(id);

  renderTabs();
  refreshUIForTabs();
  renderTimeline();
  updateInfoStrip();
}

function deleteTab(id){
  stopCountdown();
  if(!confirm('Supprimer cette fiche ?')) return;

  id = String(id);

  let tabs = JSON.parse(localStorage.getItem('flightTabs') || '[]');
  if(!Array.isArray(tabs)) tabs = [];

  const idx = tabs.indexOf(id);
  if(idx === -1) return;

  tabs.splice(idx, 1);
  localStorage.setItem('flightTabs', JSON.stringify(tabs));
  localStorage.removeItem('tab-' + id);

  if(tabs.length > 0){
    const nextId = tabs[Math.max(0, idx - 1)];
    currentTabId = nextId;
    localStorage.setItem('lastTabId', nextId);
    loadTabData(nextId);
  }else{
    localStorage.removeItem('lastTabId');
    currentTabId = null;
    clearFormFields();
    stopCountdown(true);
  }

  renderTabs();
  refreshUIForTabs();
  renderTimeline();
  updateInfoStrip();
}

function clearFormFields(){
  // ‚úÖ √©vite de vider les champs des MODALS (EditDate, EditCie, etc.)
  const scope = document.querySelector('.app-container') || document;

  scope.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;

    if(el.type === 'checkbox'){
      el.checked = false;
    }else{
      el.value = '';
    }
  });

  // date du jour auto sur le champ principal "Date"
  const d = document.getElementById('Date');
  if(d){
    d.value = new Date().toISOString().slice(0,10);
  }

  updateAllCalculations();
  updateTabLabelInstant();
}

function saveCurrentTabData(){
  if(!currentTabId) return;

  // ‚úÖ on part des donn√©es existantes pour ne pas perdre akMeta
  let data = {};
  try{
    data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}') || {};
  }catch(e){ data = {}; }

  // ‚úÖ ne sauvegarde que les champs "principaux" (app) pour √©viter collisions avec modals
  const scope = document.querySelector('.app-container') || document;

  scope.querySelectorAll('input, select, textarea').forEach(el=>{
    if(!el.id) return;
    if(el.type==='checkbox') data[el.id] = el.checked ? '1':'0';
    else data[el.id] = el.value;
  });

  data.modeDark = document.documentElement.classList.contains('dark') ? '1' : '0';
  data.modeUTC  = isUTC ? '1' : '0';

  data.timer_h40  = document.getElementById('timer-h40')?.textContent || '--:--';
  data.timer_h15  = document.getElementById('timer-h15')?.textContent || '--:--';
  data.timer_h8   = document.getElementById('timer-h8')?.textContent  || '--:--';
  data.timer_tobt = document.getElementById('timer-tobt')?.textContent || '--:--';
  data.timer_cd   = document.getElementById('timer-cd')?.textContent || '--:--';

  data.timingPanel = localStorage.getItem('timingPanel') || 'dep';

  localStorage.setItem('tab-'+currentTabId, JSON.stringify(data));
  localStorage.setItem('lastTabId', currentTabId);
}

function loadTabData(id){
  currentTabId = String(id);

  const raw = localStorage.getItem('tab-'+currentTabId);
  if(!raw) return;

  const data = JSON.parse(raw);

  // recharge champs (dans l'app uniquement)
  const scope = document.querySelector('.app-container') || document;

  for(const k in data){
    const el = scope.querySelector('#'+CSS.escape(k));
    if(!el) continue;

    if(el.type === 'checkbox'){
      el.checked = (data[k] === true || data[k] === '1');
    }else{
      el.value = data[k];
    }
  }

  // restore panel timing
  if(data.timingPanel) localStorage.setItem('timingPanel', data.timingPanel);

  updateAllCalculations();
  updateHeaderOffset();
  updateInfoStrip();
}

function updateTabLabelInstant(){
  // √©vite boucle renderTabs -> save -> render
  saveCurrentTabData();
  renderTabs();
}

/* TIMING FIELDS ‚Äì ARR / DEP (responsive pro) */
function generateTimingFields(){
  const container = document.getElementById('timing-grid');
  if(!container) return;

  const fieldHTML = (id,label,full=false)=>`
    <div class="${full ? 'span-12' : 'span-6'}">
      <div class="field">
        <label class="label">${label}</label>
        <div class="control">
          <input class="input" type="time" id="${id}">
        </div>
        <div class="btn-actions">
          <button class="button is-dark is-light" type="button"
            onclick="adjustTime('${id}',-1);updateAllCalculations()">-1</button>
          <button class="button is-link" type="button"
            onclick="setNow('${id}');updateAllCalculations()">Now</button>
          <button class="button is-dark is-light" type="button"
            onclick="adjustTime('${id}',1);updateAllCalculations()">+1</button>
        </div>
      </div>
    </div>`;

  const arrNoHeader = `
    <div class="card mb-4">
      <div class="card-content">
        <div class="grid-auto">
          ${fieldHTML('ArriveeFuel','Arriv√©e Avitair',true)}
          ${fieldHTML('PremierDebarque','Premier d√©barqu√©')}
          ${fieldHTML('DernierDebarque','Dernier d√©barqu√©')}
          ${fieldHTML('ArriveeLiftArr','Arriv√©e lift')}
          ${fieldHTML('DepartLiftArr','D√©part lift')}
        </div>
      </div>
    </div>`;

  const depNoHeader = `
    <div class="card">
      <div class="card-content">
        <div class="grid-auto">
          ${fieldHTML('ArrPNT','Arriv√©e PNT')}
          ${fieldHTML('ArrPNC','Arriv√©e PNC')}
          ${fieldHTML('AvionPremierEmbarque','Premier embarqu√©')}
          ${fieldHTML('AvionDernierEmbarque','Dernier embarqu√©')}
          ${fieldHTML('ArriveeLift','Arriv√©e lift')}
          ${fieldHTML('DepartLift','D√©part lift')}

          <div class="span-12">
            <div class="grid-auto">
              <div class="span-6">
                ${fieldHTML('DepartFuel','D√©part Avitair')}
              </div>
              <div class="span-6">
                ${fieldHTML('ArriveeINAD','Arriv√©e INAD')}
              </div>
            </div>
          </div>

          ${fieldHTML('RemiseLID','Remise LID/LDS')}
          ${fieldHTML('FermeturePorteAvion','Fermeture porte avion')}
        </div>
      </div>
    </div>`;

  const toggle = `
    <div class="tabs is-toggle is-toggle-rounded is-centered mb-4">
      <ul>
        <li id="seg-arr-li"><a onclick="switchTimingPanel('arr')"><span>Arriv√©e</span></a></li>
        <li id="seg-dep-li"><a onclick="switchTimingPanel('dep')"><span>D√©part</span></a></li>
      </ul>
    </div>`;

  container.innerHTML =
    toggle +
    `<div id="panel-arr" style="display:none;">${arrNoHeader}</div>` +
    `<div id="panel-dep" style="display:none;">${depNoHeader}</div>`;

  const saved = localStorage.getItem('timingPanel') || 'dep';
  switchTimingPanel(saved);

  // ‚úÖ listeners (au lieu du onchange inline)
  container.querySelectorAll('input[type="time"]').forEach(inp=>{
    inp.addEventListener('input', updateAllCalculations);
    inp.addEventListener('change', updateAllCalculations);
  });
}

function switchTimingPanel(mode){
  const arrPanel=document.getElementById('panel-arr');
  const depPanel=document.getElementById('panel-dep');
  const liArr=document.getElementById('seg-arr-li');
  const liDep=document.getElementById('seg-dep-li');

  if(arrPanel) arrPanel.style.display = (mode==='arr') ? '' : 'none';
  if(depPanel) depPanel.style.display = (mode==='dep') ? '' : 'none';

  if(liArr) liArr.classList.toggle('is-active', mode==='arr');
  if(liDep) liDep.classList.toggle('is-active', mode!=='arr');

  localStorage.setItem('timingPanel', mode);
}

/* LID visible FR/RK */
function updateLIDVisibility(){
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  const lid = document.getElementById('lidBlock');
  if(!lid) return;
  lid.style.display = (cie === 'FR' || cie === 'RK') ? '' : 'none';
  updateHeaderOffset();
}

/* CALCULS */
function updateAllCalculations() {
  updateTimers();
  updateSOBTDefault();
  updateTOBT();
  updateDLCode();
  redistributeDL();
  updateLID();
  updateLIDVisibility();

  updateHBagsValidity('final');

  updateArrExpWeightIfNeeded();
  updateFinalWeightIfNeeded();

  ensureCountdownRunning();
  renderTimeline();
  updateHeaderOffset();
  updateInfoStrip();
}

/* TIMERS HLE/H-15 */
function updateTimers() {
  const sobt = document.getElementById('SOBT')?.value || '';
  const h40El = document.getElementById('timer-h40');
  const h15El = document.getElementById('timer-h15');

  if (!sobt || !h40El || !h15El) {
    if(h40El) h40El.textContent = '--:--';
    if(h15El) h15El.textContent = '--:--';
    return;
  }

  const [hh, mm] = sobt.split(':').map(Number);
  if(Number.isNaN(hh) || Number.isNaN(mm)){
    h40El.textContent = '--:--';
    h15El.textContent = '--:--';
    return;
  }

  const base = new Date();
  base.setHours(hh, mm, 0, 0);

  const h40 = new Date(base.getTime() - 40 * 60000);
  const h15 = new Date(base.getTime() - 15 * 60000);

  h40El.textContent = `${String(h40.getHours()).padStart(2,'0')}:${String(h40.getMinutes()).padStart(2,'0')}`;
  h15El.textContent = `${String(h15.getHours()).padStart(2,'0')}:${String(h15.getMinutes()).padStart(2,'0')}`;
}

/* LID = TOBT - 8 */
function updateLID() {
  const tobtRawMins = window._tobtRawMins;
  const el = document.getElementById('timer-h8');
  if (!el) return;
  if (tobtRawMins == null) { el.textContent = "--:--"; return; }
  el.textContent = fmtHHMM(tobtRawMins - 8);
}

function updateSOBTDefault() {
  const sobtEl = document.getElementById('SOBT');
  if(!sobtEl) return;

  if ((sobtEl.value || '').trim() !== '') return;

  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  if(cie === "FR" || cie === "RK") return;

  const sibt = document.getElementById('SIBT')?.value || '';
  if (!sibt) return;
  if (!(cie === "W4" || cie === "W6")) return;

  const [sH, sM] = sibt.split(':').map(Number);
  if(Number.isNaN(sH) || Number.isNaN(sM)) return;

  const base = new Date();
  base.setHours(sH, sM, 0, 0);

  const type = (document.getElementById('TypeAvion')?.value || '').toUpperCase();
  const add = (type === 'A321' || type === 'A21N' || type === 'A21NY') ? 35 : 30;

  const sobtCalc = new Date(base.getTime() + add * 60000);
  sobtEl.value = `${String(sobtCalc.getHours()).padStart(2,'0')}:${String(sobtCalc.getMinutes()).padStart(2,'0')}`;
}

/* TOBT + r√®gle CTOT (LOGIQUE FINALE ‚Äì robuste minuit) */
function updateTOBT() {
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  const sibttxt = document.getElementById('SIBT')?.value || '';
  const aibttxt = document.getElementById('AIBT')?.value || '';
  const sobttxt = document.getElementById('SOBT')?.value || '';
  const ctottxt = document.getElementById('CTOT')?.value || '';

  const outEl = document.getElementById('timer-tobt');

  if (!cie || !sibttxt || !sobttxt || !outEl) {
    if(outEl) outEl.textContent = '--:--';
    window._tobtRawMins = null;
    window._tobtAdjMins = null;
    return;
  }

  const SIBT = parseHHMM(sibttxt);
  const SOBT = parseHHMM(sobttxt);
  if (SIBT == null || SOBT == null) {
    outEl.textContent = '--:--';
    window._tobtRawMins = null;
    window._tobtAdjMins = null;
    return;
  }

  const AIBT = aibttxt ? parseHHMM(aibttxt) : SIBT;
  if (AIBT == null) {
    outEl.textContent = '--:--';
    window._tobtRawMins = null;
    window._tobtAdjMins = null;
    return;
  }

  // diff sign√© (minutes), robuste minuit : r√©sultat dans [-720..+720]
  const diffSigned = (t, ref) => {
    let d = t - ref;
    if (d > 720) d -= 1440;
    if (d < -720) d += 1440;
    return d;
  };

  // Temps "√©tendus" ancr√©s sur SIBT (comparaisons correctes m√™me au passage minuit)
  const SIBT_ext = SIBT;
  const AIBT_ext = SIBT_ext + diffSigned(AIBT, SIBT);
  const SOBT_ext = SIBT_ext + diffSigned(SOBT, SIBT);

  const crewChange = !!(
    (document.getElementById('ArrPNT')?.value || '').trim() ||
    (document.getElementById('ArrPNC')?.value || '').trim()
  );

  const isDelayed = (AIBT_ext > SIBT_ext);

  let TOBT_raw_ext = null;

  // ===== R√àGLE COMMUNE : si AIBT <= SIBT => TOBT = SOBT
  if (!isDelayed) {
    TOBT_raw_ext = SOBT_ext;
  } else {
    // ===== FR / RK : TOBT = max(SOBT, AIBT + turn)
    if (cie === 'FR' || cie === 'RK') {
      const turn = crewChange ? 35 : 25;
      const candidate = AIBT_ext + turn;
      TOBT_raw_ext = (candidate <= SOBT_ext) ? SOBT_ext : candidate;
    }

    // ===== W4 / W6 : TOBT = AIBT + 30/35 selon type
    else if (cie === 'W4' || cie === 'W6') {
      const type = (document.getElementById('TypeAvion')?.value || '').toUpperCase();
      const turn = (type === 'A321' || type === 'A21N' || type === 'A21NY') ? 35 : 30;
      TOBT_raw_ext = AIBT_ext + turn;
    }

    // ===== H4 / U5 / H6 / AUTRE : TOBT = AIBT + (SOBT - SIBT)
    else {
      const rot = SOBT_ext - SIBT_ext; // sign√© (g√®re minuit / rotation invers√©e)
      TOBT_raw_ext = AIBT_ext + rot;
    }
  }

  // Raw minutes 0..1439 (utile LID + affichage)
  window._tobtRawMins = ((TOBT_raw_ext % 1440) + 1440) % 1440;

  // ===== R√àGLE CTOT : si CTOT > TOBT + 15 => TOBT = CTOT - 15
  let TOBT_adj_ext = TOBT_raw_ext;

  if (ctottxt) {
    const CTOT = parseHHMM(ctottxt);
    if (CTOT != null) {
      // CTOT √©tendu autour de TOBT (pour g√©rer minuit)
      const TOBT_ref = ((TOBT_raw_ext % 1440) + 1440) % 1440;
      const CTOT_ext = TOBT_raw_ext + diffSigned(CTOT, TOBT_ref);

      if (CTOT_ext > (TOBT_raw_ext + 15)) {
        TOBT_adj_ext = CTOT_ext - 15;
      }
    }
  }

  window._tobtAdjMins = ((TOBT_adj_ext % 1440) + 1440) % 1440;
  outEl.textContent = fmtHHMM(window._tobtAdjMins);
}

/* DL CODES (robuste minuit + safe null) */
function updateDLCode() {
  const cie = (document.getElementById('Cie')?.value || '').toUpperCase();
  const sibttxt = document.getElementById('SIBT')?.value || '';
  const aibttxt = document.getElementById('AIBT')?.value || '';

  const codeEl = document.getElementById('DLcode1');
  const durEl  = document.getElementById('DLduree1');
  if(!codeEl || !durEl) return;

  const SIBT = parseHHMM(sibttxt);
  const AIBT = parseHHMM(aibttxt);
  if(SIBT == null || AIBT == null){
    codeEl.value = '';
    durEl.value  = '';
    return;
  }

  // diff robuste minuit (AIBT - SIBT) ramen√© dans [-720..+720]
  let diff = AIBT - SIBT;
  if(diff > 720) diff -= 1440;
  if(diff < -720) diff += 1440;

  if (diff > 0) {
    if (cie === 'FR' || cie === 'RK') codeEl.value = '93';
    else if (cie === 'W4' || cie === 'W6') codeEl.value = '93A';
    else codeEl.value = '';

    durEl.value = String(Math.round(diff));
  } else {
    codeEl.value = '';
    durEl.value  = '';
  }
}

/* DL redistribution */
function dldChanged(index){ lastDLChanged = index; redistributeDL(); }

function totalDelayMinutes(){
  const so = document.getElementById('SOBT')?.value || '';
  const ao = document.getElementById('AOBT')?.value || '';
  if(!so || !ao) return null;

  const s = parseHHMM(so);
  const a = parseHHMM(ao);
  if (s==null || a==null) return null;

  // total dans [0..1439] (g√®re minuit)
  let total = a - s;
  if (total < 0) total += 1440;
  return total;
}

function redistributeDL(){
  const total = totalDelayMinutes();

  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  if(!f1 || !f2 || !f3) return;

  let d1 = parseInt(f1.value,10); d1 = isNaN(d1) ? 0 : d1;
  let d2 = parseInt(f2.value,10); d2 = isNaN(d2) ? 0 : d2;
  let d3 = parseInt(f3.value,10); d3 = isNaN(d3) ? 0 : d3;

  if(total == null){
    clearDLBorders();
    return;
  }

  d1 = Math.max(0, Math.min(d1, total));

  if(lastDLChanged === 1){
    const remain = Math.max(0, total - d1);
    d2 = Math.max(0, Math.min(d2, remain));
    d3 = Math.max(0, total - d1 - d2);
  } else if (lastDLChanged === 2){
    const maxD2 = Math.max(0, total - d1);
    d2 = Math.max(0, Math.min(d2, maxD2));
    d3 = Math.max(0, total - d1 - d2);
  } else {
    const maxD3 = Math.max(0, total - d1 - d2);
    d3 = Math.max(0, Math.min(d3, maxD3));
  }

  f1.value = d1 ? String(d1) : '';
  f2.value = d2 ? String(d2) : '';
  f3.value = d3 ? String(d3) : '';

  const sum = d1 + d2 + d3;
  if (sum > total) markLastFilledDLError();
  else clearDLBorders();
}

function markLastFilledDLError(){
  clearDLBorders();
  const f1 = document.getElementById('DLduree1');
  const f2 = document.getElementById('DLduree2');
  const f3 = document.getElementById('DLduree3');
  if(!f1 || !f2 || !f3) return;

  const d1 = parseInt(f1.value,10) || 0;
  const d2 = parseInt(f2.value,10) || 0;
  const d3 = parseInt(f3.value,10) || 0;

  if (d3 > 0) f3.classList.add('dl-error');
  else if (d2 > 0) f2.classList.add('dl-error');
  else if (d1 > 0) f1.classList.add('dl-error');
}

function clearDLBorders(){
  ['DLduree1','DLduree2','DLduree3'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove('dl-error');
  });
}

/* Utils time */
function setNow(fieldId) {
  const el = document.getElementById(fieldId);
  if(!el) return;
  const now = new Date();
  const hh = isUTC ? now.getUTCHours() : now.getHours();
  const mm = isUTC ? now.getUTCMinutes() : now.getMinutes();
  el.value = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
}

function adjustTime(fieldId, delta) {
  const input = document.getElementById(fieldId);
  if (!input || !input.value) return;
  const t = parseHHMM(input.value);
  if(t == null) return;
  input.value = fmtHHMM(t + delta);
}

/* Switches */
function setDarkMode(enable, fromInit=false){
  const currentlyDark = document.body.classList.contains('dark');

  if (enable && !currentlyDark) document.body.classList.add('dark');
  if (!enable && currentlyDark) document.body.classList.remove('dark');

  // ‚úÖ applique aussi sur <html> pour les variables CSS
  document.documentElement.classList.toggle('dark', enable);

  const dt = document.getElementById('darkToggle');
  if(dt) dt.checked = enable;

  const darkLabel = document.getElementById('darkLabel');
  if(darkLabel) darkLabel.textContent = enable ? 'Sombre' : 'Clair';

  localStorage.setItem('modeDark', enable ? '1' : '0');

  updateHeaderOffset();
  renderTimeline();
}

function setTimeModeUTC(enable, fromInit=false){
  const offsetHours = -new Date().getTimezoneOffset() / 60;

  if (!fromInit && enable !== isUTC) {
    const inputs = document.querySelectorAll('input[type="time"]');
    inputs.forEach(input => {
      if (!input.value) return;
      let [hh, mm] = input.value.split(':').map(Number);
      let newH = enable ? hh - offsetHours : hh + offsetHours;
      let totalMin = Math.round(newH * 60 + mm);
      totalMin = ((totalMin % 1440) + 1440) % 1440;
      const outH = Math.floor(totalMin / 60);
      const outM = totalMin % 60;
      input.value = `${String(outH).padStart(2, '0')}:${String(outM).padStart(2, '0')}`;
    });
  }

  isUTC = enable;

  const ut = document.getElementById('utcToggle');
  if(ut) ut.checked = enable;

  const tzLabel = document.getElementById('tzLabel');
  if(tzLabel) tzLabel.textContent = enable ? 'UTC' : 'Locale';

  localStorage.setItem('modeUTC', enable ? '1' : '0');

  updateAllCalculations();

  // üîÅ refresh flight list AK si ouverte
  if(document.getElementById('akPopover')?.style.display !== 'none'){
    loadAKFlights();
  }
}

/* Popup */
function showPopup(message, color = "#2563eb", duration = 2000) {
  const popup = document.createElement('div');
  popup.id = "popup";
  popup.textContent = message;
  popup.style.background = color;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), duration);
}

/* Timeline helpers */
let showTimeLabels = true;
let timelineUserScrolled = false;

function parseHHMM(str){
  if(!str || !/^\d{2}:\d{2}$/.test(str)) return null;
  const [h,m] = str.split(':').map(Number);
  return h*60 + m;
}
function fmtHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  const h = Math.floor(mins/60), m = mins%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function toExtended(t, min, max){
  const wraps = (max > 1440);
  if (!wraps) return t;
  const startMod = ((min % 1440) + 1440) % 1440;
  return (t < startMod) ? t + 1440 : t;
}
function computeTimelineWindow(allTimes){
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));
  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');

  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM(document.getElementById('CTOT')?.value || '');

  const starts = [H40, SIBT, AIBT].filter(v => v != null);
  const ends   = [SOBT, AOBT, TOBT, CTOT].filter(v => v != null);

  if(starts.length && ends.length){
    let startRef = Math.min(...starts);
    let endRef   = Math.max(...ends);

    if(endRef <= startRef) endRef += 1440;

    let min = startRef - 5;
    let max = endRef + 5;

    if(max - min < 30){ min -= 10; max += 10; }

    return { min, max };
  }

  if(allTimes && allTimes.length){
    let min = Math.min(...allTimes) - 10;
    let max = Math.max(...allTimes) + 10;
    if(max <= min) max += 1440;
    if(max - min < 30){ min -= 10; max += 10; }
    return {min, max};
  }

  return {min:0, max:60};
}
function getPairWindow(idA,idB){
  const a = parseHHMM(document.getElementById(idA)?.value || '');
  const b = parseHHMM(document.getElementById(idB)?.value || '');
  if(a==null || b==null) return null;
  return [Math.min(a,b), Math.max(a,b)];
}
function collectTimelineData(){
  const fixedPoints = [];
  const addPoint = (label, t, cls='tl--std')=>{ if(t==null) return; fixedPoints.push({label, t, cls}); };

  const SIBT = parseHHMM(document.getElementById('SIBT')?.value || '');
  const AIBT = parseHHMM(document.getElementById('AIBT')?.value || '');
  const SOBT = parseHHMM(document.getElementById('SOBT')?.value || '');
  const AOBT = parseHHMM(document.getElementById('AOBT')?.value || '');
  const TOBT = parseHHMM((document.getElementById('timer-tobt')?.textContent || '').replace('--:--',''));
  const CTOT = parseHHMM(document.getElementById('CTOT')?.value || '');
  const H15  = parseHHMM((document.getElementById('timer-h15')?.textContent || '').replace('--:--',''));
  const H40  = parseHHMM((document.getElementById('timer-h40')?.textContent || '').replace('--:--',''));

  addPoint('SIBT', SIBT, 'tl--std'); addPoint('AIBT', AIBT, 'tl--std');
  addPoint('SOBT', SOBT, 'tl--std'); addPoint('AOBT', AOBT, 'tl--std');
  addPoint('TOBT', TOBT, 'tl--tobt'); addPoint('CTOT', CTOT, 'tl--ctot');
  addPoint('HLE',  H40,  'tl--turn');
  addPoint('H-15', H15,  'tl--turn');

  const singles = [
    ['ArrPNT','Arriv√©e PNT'],
    ['ArrPNC','Arriv√©e PNC'],
    ['FermeturePorteAvion','Fermeture porte avion'],
  ];
  singles.forEach(([id,label])=>{
    const t = parseHHMM(document.getElementById(id)?.value || '');
    if(t!=null) fixedPoints.push({label, t, cls:'tl--std'});
  });

  const rows = [
    {label:'D√©barquement', pair:getPairWindow('PremierDebarque','DernierDebarque'), cls:'tl--turn', color:null},
    {label:'Embarquement', pair:getPairWindow('AvionPremierEmbarque','AvionDernierEmbarque'), cls:'tl--ops',  color:null},
    {label:'Avitair',      pair:getPairWindow('ArriveeFuel','DepartFuel'), cls:'tl--std', color:'#f59e0b'},
    {label:'Lift (Arr)',   pair:getPairWindow('ArriveeLiftArr','DepartLiftArr'), cls:'tl--std', color:'#a855f7'},
    {label:'Lift (Dep)',   pair:getPairWindow('ArriveeLift','DepartLift'), cls:'tl--std', color:'#16a34a'},
  ];

  const durations = rows
    .filter(r=>r.pair!=null)
    .map(r=>({label:r.label, a:r.pair[0], b:r.pair[1], cls:r.cls, color:r.color}));

  const allTimes = [ ...fixedPoints.map(p=>p.t), ...durations.flatMap(d=>[d.a,d.b]) ];
  const windowInfo = computeTimelineWindow(allTimes);

  return {fixedPoints, durations, windowInfo};
}
function renderTimeline(){
  const scroller = document.getElementById('timelineScroll');
  const canvas   = document.getElementById('timelineCanvas');
  if(!scroller || !canvas) return;

  canvas.innerHTML = '';

  const {fixedPoints, durations, windowInfo} = collectTimelineData();
  const {min, max} = windowInfo;
  if(min === undefined) return;

  window._timelineCurrentRange = {min, max};
  const total = Math.max(1, max - min);

  const viewport = scroller.clientWidth || 1200;
  const canvasPx = Math.max(viewport, Math.round(viewport * timelineZoom));
  canvas.style.width = canvasPx + 'px';

  const MIN_HEIGHT = 180;
  const PT_LANE_H  = 50;
  const DUR_LANE_H = 50;
  const TOP_PAD    = 40;
  const AFTER_POINTS = 28;
  const AFTER_TRACK  = 36;
  const BOTTOM_PAD   = 40;

  const lanesEndX = [];
  const pointEls = [];

  fixedPoints.sort((a,b)=>a.t-b.t).forEach(p=>{
    const tExt = toExtended(p.t, min, max);
    const leftPct = 6 + ((tExt-min)/total)*88;

    const el = document.createElement('div');
    el.className = `tl-event ${p.cls}`;
    el.style.left = `${leftPct}%`;
    el.style.top  = `0px`;
    el.style.visibility = 'hidden';

    const dot = document.createElement('div'); dot.className = 'tl-dot';
    const label = document.createElement('div'); label.className='tl-label';
    label.textContent = showTimeLabels ? `${p.label} : ${fmtHHMM(p.t)}` : p.label;
    el.appendChild(dot); el.appendChild(label);
    canvas.appendChild(el);

    const w = Math.max(label.offsetWidth, 12);
    const centerX = (leftPct/100) * canvasPx;
    const startX = centerX - (w/2) - 16;
    const endX   = centerX + (w/2) + 16;

    let lane = 0;
    while(lanesEndX[lane] !== undefined && startX <= lanesEndX[lane]) lane++;
    lanesEndX[lane] = endX;

    pointEls.push({el, lane});
  });

  const pointLaneCount = lanesEndX.length || 0;
  const trackY = TOP_PAD + pointLaneCount*PT_LANE_H + AFTER_POINTS;

  const durItems = durations.map(d=>{
    const aExt = toExtended(d.a, min, max);
    const bExt = toExtended(d.b, min, max);
    return { ...d, start: Math.min(aExt,bExt), end: Math.max(aExt,bExt) };
  }).sort((x,y)=> x.start - y.start);

  function packLanes(items, pad = 2){
    const lanes = [];
    return items.map(it => {
      let laneIdx = lanes.findIndex(nextFree => it.start >= nextFree);
      if (laneIdx === -1) {
        laneIdx = lanes.length;
        lanes.push(it.end + pad);
      } else {
        lanes[laneIdx] = it.end + pad;
      }
      return { ...it, lane: laneIdx };
    });
  }

  const durWithLane = packLanes(durItems);
  const durLaneCount = Math.max(0, ...durWithLane.map(d => d.lane)) + 1;

  const finalHeight = Math.max(
    MIN_HEIGHT,
    trackY + AFTER_TRACK + durLaneCount*DUR_LANE_H + BOTTOM_PAD
  );
  canvas.style.height = `${finalHeight}px`;

  for(let t = Math.ceil(min); t <= Math.floor(max); t++){
    const x = (t-min)/total;
    const leftPct = 6 + x*88;

    const vline = document.createElement('div');
    vline.className = 'timeline-tick';
    vline.style.left = `${leftPct}%`;
    vline.style.top = `${8}px`;
    vline.style.height = `${finalHeight - 36}px`;
    canvas.appendChild(vline);

    if(t % 5 === 0){
      const lbl = document.createElement('div');
      lbl.className = 'timeline-tick-label';
      lbl.textContent = fmtHHMM(t);
      lbl.style.left = `${leftPct}%`;
      lbl.style.top = `${finalHeight - 18}px`;
      canvas.appendChild(lbl);
    }
  }

  const track = document.createElement('div');
  track.className = 'timeline-track';
  track.style.top = `${trackY}px`;
  canvas.appendChild(track);

  pointEls.forEach(({el,lane})=>{
    el.style.top = `${TOP_PAD + lane*PT_LANE_H}px`;
    el.style.visibility = 'visible';
  });

  const downStart = trackY + AFTER_TRACK;
  durWithLane.forEach(d=>{
    const leftStartPct = 6 + ((d.start-min)/total)*88;
    const widthPct     = ((d.end-d.start)/total)*88;

    const bar = document.createElement('div');
    bar.className = `tl-range ${d.cls}`;
    if(d.color){ bar.style.setProperty('--c', d.color); }
    bar.style.left = `${leftStartPct}%`;
    bar.style.width = `${widthPct}%`;
    bar.style.top = `${downStart + d.lane*DUR_LANE_H}px`;
    bar.style.transform = 'translateX(-50%)';
    canvas.appendChild(bar);

    const lab = document.createElement('div');
    lab.className = 'tl-range-label';
    const durMin = Math.max(0, d.b - d.a);
    lab.textContent = showTimeLabels ? `${d.label} : ${durMin} min` : d.label;
    bar.appendChild(lab);
  });

  if(!timelineUserScrolled){
    const centerMin = (min + max) / 2;
    const midX = (centerMin - min) / total;
    const centerLeft = midX * scroller.scrollWidth - scroller.clientWidth / 2;
    scroller.scrollLeft = Math.max(0, centerLeft);
  }

  const lbl = document.getElementById('timelineZoomLabel');
  if(lbl) lbl.textContent = `${Math.round(timelineZoom*100)}%`;
}
function setVal(id, v){
  const el = document.getElementById(id);
  if(!el) return;

  // si string -> uppercase, sinon valeur brute
  el.value = (typeof v === 'string') ? v.toUpperCase() : (v ?? '');

  // d√©clenche les listeners
  el.dispatchEvent(new Event('input',  { bubbles:true }));
  el.dispatchEvent(new Event('change', { bubbles:true }));
}

function setTimeFromISO(id, iso){
  if(!iso) return;
  const d = new Date(iso);
  if(isNaN(d.getTime())) return;

  const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
  const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');

  setVal(id, `${hh}:${mm}`);
}

function setIfEmpty(id, v){
  const el = document.getElementById(id);
  if(!el) return;
  if((el.value || '').trim() !== '') return;
  setVal(id, v);
}

function setTimeFromISOIfEmpty(id, iso){
  const el = document.getElementById(id);
  if(!el) return;
  if((el.value || '').trim() !== '') return;
  setTimeFromISO(id, iso);
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function pickBestTimeForList(f, flow){
  const iso = (v)=> v ? new Date(v) : null;

  const toHHMM = (d)=>{
    if(!d || isNaN(d.getTime())) return '';
    const hh = String(isUTC ? d.getUTCHours() : d.getHours()).padStart(2,'0');
    const mm = String(isUTC ? d.getUTCMinutes() : d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  };

  if(flow === 'DEP'){
    return toHHMM(
      iso(f.aobt) || iso(f.sobt) || iso(f.eobt) || iso(f.atot) || iso(f.etot)
    );
  }

  return toHHMM(
    iso(f.aibt) || iso(f.sibt) || iso(f.eibt) || iso(f.aldt) || iso(f.eldt)
  );
}

  /* ===== SETTINGS MENU ===== */
function openSettingsMenu(){
  const b = document.getElementById('settingsBackdrop');
  const m = document.getElementById('settingsMenu');
  if(b) b.style.display = '';
  if(m) m.style.display = 'block';
}
function closeSettingsMenu(){
  const b = document.getElementById('settingsBackdrop');
  const m = document.getElementById('settingsMenu');
  if(m) m.style.display = 'none';
  if(b) b.style.display = 'none';
}
function toggleSettingsMenu(){
  const m = document.getElementById('settingsMenu');
  const isOpen = m && m.style.display !== 'none' && m.style.display !== '';
  if(isOpen) closeSettingsMenu();
  else openSettingsMenu();
}

// ESC ferme aussi le menu settings
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeSettingsMenu();
});

// ===== Airport Keeper (AK) =====
const AK_TOKEN = "Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJidmFfZXh0IiwidXNlcm5hbWUiOiJidmFfZXh0IiwiYWlycG9ydHMiOiJMRk9CIn0.PkSbBw_BF5dnX0bG3gbP7E7P7SHhW9egJ_in6OaWTnJm0OpirhJP4FZzbztH0r6lQxrA5JliEopo7__CyYvfIA";
const AK_BASE    = "https://api.app.airport-keeper.com/flights/v1/airport";
const AK_AIRPORT = "LFOB";
const HOME_IATA  = "BVA";

// Ouvrir/Fermer
function openAKPicker(){
  const b = document.getElementById('akBackdrop');
  const p = document.getElementById('akPopover');
  const flowSel = document.getElementById('akFlow');

  if(flowSel) flowSel.value = 'DEP';   // <-- reset ici

  if(b) b.style.display = '';
  if(p) p.style.display = 'flex';
  loadAKFlights();
}

function closeAKPicker(){
  const b = document.getElementById('akBackdrop');
  const p = document.getElementById('akPopover');
  if(p) p.style.display = 'none';
  if(b) b.style.display = 'none';
}

async function fetchAK(flow, from, to){
  const url = `${AK_BASE}?airport=${encodeURIComponent(AK_AIRPORT)}&flow=${encodeURIComponent(flow)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
  const res = await fetch(url, { headers: { Authorization: AK_TOKEN }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  return Array.isArray(data?.flights) ? data.flights : [];
}

// ===== Temps + linking (immat) =====
function arrTimeMs(f){
  return Date.parse(f?.aibt || f?.eibt || f?.sibt || f?.aldt || f?.eldt || f?.afat || f?.efat || '') || null;
}

// DEP : si pas d'AOBT, on privil√©gie EOBT/POBT/CTOT (r√©aliste) plut√¥t que SOBT (souvent "ancien plan")
function depTimeMs(f){
  return Date.parse(
    f?.aobt || f?.eobt || f?.pobt || f?.ctot || f?.etot || f?.sobt || ''
  ) || null;
}

// ===== Linking : priorit√© linkedId, sinon reg+temps =====
function findLinkedDepForArr(arr){
  if(!arr) return null;

  // 1) linkedId direct
  const lid = (arr?.linkedId || '').trim();
  if(lid){
    const dep = (window._akCache?.dep || []).find(d => String(d?.id) === lid);
    if(dep) return dep;
  }

  // 2) fallback reg + premier DEP apr√®s ARR
  const reg = (arr?.reg || '').toUpperCase().trim();
  if(!reg) return null;

  const arrT = arrTimeMs(arr);
  if(arrT == null) return null;

  const deps = window._akCache?.dep || [];
  let best = null;
  let bestT = Infinity;

  for(const d of deps){
    const r = (d?.reg || '').toUpperCase().trim();
    if(r !== reg) continue;

    const t = depTimeMs(d);
    if(t == null) continue;
    if(t < arrT) continue;

    if(t < bestT){ best = d; bestT = t; }
  }
  return best;
}

function findLinkedArrForDep(dep){
  if(!dep) return null;

  // 1) linkedId direct
  const lid = (dep?.linkedId || '').trim();
  if(lid){
    const arr = (window._akCache?.arr || []).find(a => String(a?.id) === lid);
    if(arr) return arr;
  }

  // 2) fallback reg + derni√®re ARR avant DEP
  const reg = (dep?.reg || '').toUpperCase().trim();
  if(!reg) return null;

  const depT = depTimeMs(dep);
  if(depT == null) return null;

  const arrs = window._akCache?.arr || [];
  let best = null;
  let bestT = -Infinity;

  for(const a of arrs){
    const r = (a?.reg || '').toUpperCase().trim();
    if(r !== reg) continue;

    const t = arrTimeMs(a);
    if(t == null) continue;
    if(t > depT) continue;

    if(t > bestT){ best = a; bestT = t; }
  }
  return best;
}

function depAobtTooOld(dep, minutes = 15){
  const aobt = dep?.aobt;
  if(!aobt) return false;
  const t = Date.parse(aobt);
  if(!t) return false;
  return (Date.now() - t) > minutes*60*1000;
}

function depAtotTooOld(dep, minutes = 15){
  // ATOT = info Keeper uniquement (non affich√©e)
  const iso = dep?.atot || dep?.aobt; // fallback s√©curit√©
  if(!iso) return false;

  const t = Date.parse(iso);
  if(!t) return false;

  return (Date.now() - t) > minutes * 60 * 1000;
}

// ===== Chargement liste (vols du jour) + TRI + SUPPRESSION ATOT+15 =====
async function loadAKFlights(){
  const flow = document.getElementById('akFlow')?.value || 'DEP';
  const st   = document.getElementById('akStatus');
  const list = document.getElementById('akList');

  if(st) st.textContent = 'Chargement‚Ä¶';
  if(list) list.innerHTML = '';

  const now = new Date();
  const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const endDay   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);

  // fen√™tre large pour le linking (hier soir -> demain matin)
  const linkFromDate = new Date(startDay.getTime() - 12*60*60*1000);
  const linkToDate   = new Date(endDay.getTime()   + 12*60*60*1000);

  const linkFrom = linkFromDate.toISOString().replace(/\.\d{3}Z$/, "Z");
  const linkTo   = linkToDate.toISOString().replace(/\.\d{3}Z$/, "Z");

  try{
    const [arrAll, depAll] = await Promise.all([
      fetchAK('ARR', linkFrom, linkTo),
      fetchAK('DEP', linkFrom, linkTo),
    ]);

    // cache pour applyAKFlight + linking
    window._akCache = { arr: arrAll, dep: depAll };

    const inToday = (f, flow) => {
      const t = Date.parse(
        flow === 'DEP'
          ? (f.sobt || f.eobt || f.aobt || f.atot || '')
          : (f.sibt || f.eibt || f.aibt || '')
      );
      return t && t >= startDay.getTime() && t <= endDay.getTime();
    };

    let flights = (flow === 'DEP' ? depAll : arrAll).filter(f => inToday(f, flow));

    // DEP : virer si ATOT > 15 min (fallback AOBT si pas d'ATOT)
    if(flow === 'DEP'){
      flights = flights.filter(d => !depAtotTooOld(d, 15));
    }

    // ARR : virer seulement si le DEP li√© (apr√®s ARR) est parti (ATOT) depuis > 15 min
    if(flow === 'ARR'){
      flights = flights.filter(arr => {
        const nextDep = findLinkedDepForArr(arr);
        if(!nextDep) return true;                 // repart demain / pas de rota -> on garde
        return !depAtotTooOld(nextDep, 15);       // on vire quand le DEP li√© est trop vieux
      });
    }

    // ===== TRI CHRONO =====
    flights.sort((a,b)=>{
      const ta = flow === 'DEP' ? depTimeMs(a) : arrTimeMs(a);
      const tb = flow === 'DEP' ? depTimeMs(b) : arrTimeMs(b);

      if(ta == null && tb == null) return 0;
      if(ta == null) return 1;
      if(tb == null) return -1;
      return ta - tb;
    });

    if(st) st.textContent = `${flights.length} vol(s)`;
    renderAKList(flights, flow);

  }catch(e){
    if(st) st.textContent = `Erreur (${String(e.message || e)})`;
  }
}

// ===== Rendu liste : ARR = provenance, DEP = destination =====
function renderAKList(flights, flow){
  const list = document.getElementById('akList');
  if(!list) return;

  function delayMinutes(f, flow){
    const parse = v => v ? Date.parse(v) : NaN;

    if(flow === 'ARR'){
      const s = parse(f?.sibt);
      const r = parse(f?.aibt || f?.eibt);
      if(!isFinite(s) || !isFinite(r)) return 0;
      const d = Math.round((r - s) / 60000);
      return d > 0 ? d : 0;
    }else{
      const s = parse(f?.sobt);
      const r = parse(f?.aobt || f?.eobt);
      if(!isFinite(s) || !isFinite(r)) return 0;
      const d = Math.round((r - s) / 60000);
      return d > 0 ? d : 0;
    }
  }

  const safeJsonForOnclick = obj =>
    JSON.stringify(obj)
      .replace(/</g,"\\u003c")
      .replace(/>/g,"\\u003e")
      .replace(/&/g,"\\u0026")
      .replace(/'/g,"\\u0027")
      .replace(/\u2028/g,"\\u2028")
      .replace(/\u2029/g,"\\u2029");

  const row = (f)=>{
    const ff    = (f.fullFlightNumber || f.callsign || '').trim();
    const reg   = (f.reg || '').trim();
    const stand = (f.pkg || '').toString().replace(/^P/i,'');
    const t     = pickBestTimeForList(f, flow);

    let statusRaw = (f.status || f.milestone || '').toString().toUpperCase();
    let status = statusRaw;

    if(statusRaw === 'SCHEDULED') status = 'PR√âVU';

    if(flow === 'DEP'){
      if(statusRaw === 'IN_FLIGHT') status = 'D√âCOLL√â';
    }else{
      // ARR
      if(statusRaw === 'TERMINATED') status = 'ARRIV√â';
      if(statusRaw === 'IN_FLIGHT')  status = 'EN VOL';

      // üî• ARR affich√© D√âCOLL√â si le DEP li√© a d√©coll√©
      const nextDep = findLinkedDepForArr(f);
      if(nextDep){
        const depStatusRaw = (nextDep.status || nextDep.milestone || '').toString().toUpperCase();
        const depIsOff = depStatusRaw === 'IN_FLIGHT' || !!nextDep.atot;
        if(depIsOff) status = 'D√âCOLL√â';
      }
    }

    const dly = delayMinutes(f, flow);
    const showDelay = dly >= 5;

    let bg = 'var(--card)';
    if(flow === 'ARR' && status === 'D√âCOLL√â'){
      bg = 'rgba(0,0,0,.04)';
    }else if(flow === 'ARR' && statusRaw === 'IN_FLIGHT'){
      bg = 'rgba(37,99,235,0.12)';
    }else if(flow === 'DEP' && statusRaw === 'IN_FLIGHT'){
      bg = 'rgba(0,0,0,.04)';
    }else if(showDelay){
      bg = (dly <= 15)
        ? 'rgba(245,158,11,0.18)'
        : 'rgba(239,68,68,0.16)';
    }

    const mainIata = (flow === 'ARR')
      ? (f.adepIata || f.adepIcao || '')
      : (f.adesIata || f.adesIcao || '');

    const delayBadge = showDelay
      ? `<span class="tag" style="font-weight:900; margin-left:6px;
           background:${dly<=15 ? 'rgba(245,158,11,0.20)' : 'rgba(239,68,68,0.18)'};">
           RETARD +${dly}
         </span>`
      : '';

    const json = safeJsonForOnclick(f);

    return `
      <div class="card mb-2"
        style="box-shadow:none;border:1px solid rgba(0,0,0,.08);background:${bg};">
        <div class="card-content" style="padding:10px 12px;">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
            <div style="min-width:220px;">
              <div style="font-weight:900;font-size:1.05rem;display:flex;gap:6px;flex-wrap:wrap;">
                <span>${escapeHtml(mainIata || '---')}</span>
                ${delayBadge}
              </div>

              <div style="color:var(--muted);font-weight:800;font-size:.95rem;">
                ${escapeHtml(ff || '(sans num√©ro)')}
                ¬∑ Stand ${escapeHtml(stand || '‚Äî')}
                ¬∑ ${escapeHtml(reg || '‚Äî')}
              </div>

              <div style="color:var(--muted);font-weight:800;font-size:.9rem;">
                ${escapeHtml(t || '‚Äî')}
                ${status ? '¬∑ ' + escapeHtml(status) : ''}
              </div>
            </div>

            <button class="button is-small is-link" type="button"
              onclick='applyAKFlight(${json}, "${flow}")'>
              Utiliser
            </button>
          </div>
        </div>
      </div>
    `;
  };

  list.innerHTML = flights.length
    ? flights.map(row).join('')
    : `<p class="has-text-grey">Aucun vol.</p>`;
}

 // ===== Import : r√®gles BVA =====
function akBuildSI(f, allowDL = true){
  const parts = [];

  const rmk = (f?.remarks || '').trim();
  if(rmk) parts.push(rmk);

  if(allowDL){
    const tb = f?.dlCodes?.typeb;
    if(Array.isArray(tb) && tb.length){
      parts.push(`DL: ${tb.map(x=>`${x.code} +${x.delay}`).join(' / ')}`);
    }
  }

  return parts.join('\n').trim();
}

function storeAKMetaForTab(meta){
  if(!currentTabId) return;

  const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');

  data.akMeta = {
    flow: meta.flow || null,
    reg:  (meta.reg  || '').toUpperCase().trim(),
    arrFF:(meta.arrFF|| '').toUpperCase().trim(),
    depFF:(meta.depFF|| '').toUpperCase().trim(),
    pkg:  (meta.pkg  || '') + '',
    bc:   (meta.bc   || '').toUpperCase().trim(),   // ‚úÖ AJOUT
    ts: Date.now()
  };

  localStorage.setItem('tab-'+currentTabId, JSON.stringify(data));
}

function parseIsoMs(iso){
  const t = Date.parse(iso || '');
  return Number.isFinite(t) ? t : null;
}

function findBestAKMatch(list, meta, flow){
  if(!Array.isArray(list) || !meta?.reg) return null;

  const wantReg = meta.reg;
  const wantFF  = meta.ff;

  const wantT = parseIsoMs(flow === 'DEP' ? meta.sobt : meta.sibt) ?? parseIsoMs(meta.sibt) ?? parseIsoMs(meta.sobt);

  let best = null;
  let bestScore = Infinity;

  for(const f of list){
    const reg = ((f?.reg || '') + '').toUpperCase().trim();
    if(reg !== wantReg) continue;

    const ff = ((f?.fullFlightNumber || f?.callsign || '') + '').toUpperCase().trim();
    if(wantFF && ff && wantFF !== ff) continue;

    const candT = parseIsoMs(
      flow === 'DEP'
        ? (f?.sobt || f?.eobt || f?.aobt || f?.atot || null)
        : (f?.sibt || f?.eibt || f?.aibt || f?.aldt || null)
    );

    // score : diff temps si possible, sinon favorise match simple
    let score = 999999999;
    if(wantT != null && candT != null) score = Math.abs(candT - wantT);
    else score = 60 * 60 * 1000; // 1h arbitraire

    if(score < bestScore){
      best = f;
      bestScore = score;
    }
  }

  // garde-fou : si on a une comparaison temps, refuse au-del√† de 12h
  if(best && wantT != null){
    if(bestScore > 12 * 60 * 60 * 1000) return null;
  }

  return best;
}

async function refreshAKTab(tabId){
  const data = JSON.parse(localStorage.getItem('tab-'+tabId) || '{}');
  const meta = data.akMeta;
  if(!meta){
    showPopup("Pas de donn√©es AK √† rafra√Æchir", "#ef4444", 1600);
    return;
  }

  const now = new Date();
  const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const endDay   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);
  const linkFrom = new Date(startDay.getTime() - 12*60*60*1000).toISOString().replace(/\.\d{3}Z$/, "Z");
  const linkTo   = new Date(endDay.getTime()   + 12*60*60*1000).toISOString().replace(/\.\d{3}Z$/, "Z");

  try{
    const [arrAll, depAll] = await Promise.all([
      fetchAK('ARR', linkFrom, linkTo),
      fetchAK('DEP', linkFrom, linkTo),
    ]);

    window._akCache = { arr: arrAll, dep: depAll };

    const flow = meta.flow || 'DEP';
    const list = flow === 'DEP' ? depAll : arrAll;
    const match = findBestAKMatch(list, meta, flow);

    if(!match){
      showPopup("Vol AK introuvable", "#ef4444", 1800);
      return;
    }

    if(currentTabId !== tabId) switchTab(tabId);

    applyAKFlight(match, flow, { refresh: true });
    saveCurrentTabData();

    showPopup("AK rafra√Æchi", "#16a34a", 1400);

  }catch(e){
    showPopup(`Erreur AK (${String(e.message || e)})`, "#ef4444", 2000);
  }
}

function applyAKFlight(f, flow, opts = {}){
  const isRefresh = !!opts.refresh;

  /* ===== champs communs ===== */
  setValAK('Immat', (f.reg || ''));

  const stand = (f.pkg || '').toString().replace(/^P/i,'').trim();
  if(stand) setValAK('Parking', stand);

  const ac = (f.acTypeIcao || f.acTypeIata || '').toUpperCase().trim();
  if(ac) setValAK('TypeAvion', ac);

  const ff = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();
  if(ff){
    const m = ff.match(/^([A-Z0-9]{2})([0-9]{1,6})$/);
    if(m){
      const cie  = m[1];
      const nvol = m[2];
      const cieSel = document.getElementById('Cie');
      if(cieSel){
        const ok = Array.from(cieSel.options).some(o => o.value === cie);
        setValAK('Cie', ok ? cie : 'Autre');
      }
      setValAK('NVol', nvol);
    }else{
      setValAK('NVol', ff);
    }
  }

  /* ===== DEP ===== */
  if(flow === 'DEP'){
    setValAK('To', (f.adesIata || '') || HOME_IATA);

    setTimeFromISOAK('SOBT', f.sobt || f.eobt);
    setTimeFromISOAK('AOBT', f.aobt);
    setTimeFromISOIfEmptyOrAK('CTOT', f.ctot);

    setTimeFromISOIfEmptyOrAK('AvionPremierEmbarque', f?.boardingDetails?.startTime);
    setTimeFromISOIfEmptyOrAK('AvionDernierEmbarque', f?.boardingDetails?.endTime);

    const si = akBuildSI(f, true);
    setIfEmptyOrAK('FinalSI', si);

    const prevArr = findLinkedArrForDep(f);

    if(prevArr){
      setValAK('From', (prevArr.adepIata || '') || HOME_IATA);

      setTimeFromISOIfEmptyOrAK('SIBT', prevArr.sibt || prevArr.eibt);
      setTimeFromISOIfEmptyOrAK('AIBT', prevArr.aibt);

      if(prevArr?.bags  != null) setIfEmptyOrAK('LoadBAGS',     String(prevArr.bags));
      if(prevArr?.paxNb != null) setIfEmptyOrAK('LoadPAX_MAIN', String(prevArr.paxNb));

      setIfEmptyOrAK('LoadSI', akBuildSI(prevArr, false));
    }else{
      setValAK('From', HOME_IATA);
    }

  /* ===== ARR ===== */
  }else{
    setValAK('From', (f.adepIata || '') || HOME_IATA);

    setTimeFromISOAK('SIBT', f.sibt || f.eibt);
    setTimeFromISOAK('AIBT', f.aibt);

    if(f?.bags  != null) setIfEmptyOrAK('LoadBAGS',     String(f.bags));
    if(f?.paxNb != null) setIfEmptyOrAK('LoadPAX_MAIN', String(f.paxNb));

    setIfEmptyOrAK('LoadSI', akBuildSI(f, false));

    const nextDep = findLinkedDepForArr(f);
    if(nextDep){
      setValAK('To', (nextDep.adesIata || '') || HOME_IATA);

      setTimeFromISOIfEmptyOrAK('SOBT', nextDep.sobt || nextDep.eobt);
      setTimeFromISOIfEmptyOrAK('AOBT', nextDep.aobt);
      setTimeFromISOIfEmptyOrAK('CTOT', nextDep.ctot);

      const siDep = akBuildSI(nextDep, true);
      setIfEmptyOrAK('FinalSI', siDep);
    }else{
      setValAK('To', HOME_IATA);
    }
  }

  /* ===== m√©morise ARR + DEP fullFlightNumber + BC pour le bandeau ===== */
  let arrFF = '';
  let depFF = '';
  let bcForStrip = '';

  if(flow === 'ARR'){
    arrFF = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();
    bcForStrip = (f.borderControl || '').toUpperCase().trim();

    const nextDep = findLinkedDepForArr(f);
    if(nextDep){
      depFF = (nextDep.fullFlightNumber || nextDep.callsign || '').toUpperCase().trim();
    }
  }else{
    depFF = (f.fullFlightNumber || f.callsign || '').toUpperCase().trim();

    const prevArr = findLinkedArrForDep(f);
    if(prevArr){
      arrFF = (prevArr.fullFlightNumber || prevArr.callsign || '').toUpperCase().trim();
      bcForStrip = (prevArr.borderControl || '').toUpperCase().trim();
    }
  }

  storeAKMetaForTab({
    flow,
    reg: f.reg || '',
    pkg: f.pkg || '',
    arrFF,
    depFF,
    bc: bcForStrip
  });

  updateAllCalculations();
  updateTabLabelInstant();

  /* ‚úÖ fermeture auto quand s√©lection utilisateur */
  if(!isRefresh){
    closeAKPicker();

    // ‚úÖ reset DEP par d√©faut pour la prochaine ouverture
    const flowSel = document.getElementById('akFlow');
    if(flowSel) flowSel.value = 'DEP';

    showPopup("Vol import√©", "#16a34a", 1600);
  }
}

function openRZAModal(){
  const back  = document.getElementById('rzaBackdrop');
  const modal = document.getElementById('rzaModal');
  const inp   = document.getElementById('rzaModalInput');

  if(back) back.style.display = '';
  if(modal) modal.style.display = 'flex';

  // RZA vient du storage de l‚Äôonglet (plus de champ #RZA dans INFO VOL)
  let current = '';
  try{
    if(currentTabId){
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      current = (data.RZA || '').toUpperCase().trim();
    }
  }catch(e){}

  if(inp){
    inp.value = current;
    inp.focus();
    inp.select();

    // MAJUSCULE + lettres uniquement + max 3
    inp.oninput = ()=>{
      inp.value = (inp.value || '')
        .toUpperCase()
        .replace(/[^A-Z]/g,'')
        .slice(0,3);
      const ok = inp.value.length >= 2;
      const help = document.getElementById('rzaHelp');
      if(help) help.style.display = ok ? 'none' : '';
    };
    inp.oninput();
  }
}

function closeRZAModal(validate){
  const back = document.getElementById('rzaBackdrop');
  const modal = document.getElementById('rzaModal');
  if(modal) modal.style.display = 'none';
  if(back) back.style.display = 'none';

  if(validate) validateForm();
}

function submitRZAModal(){
  const inp = document.getElementById('rzaModalInput');
  const v = (inp?.value || '').toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);

  if(v.length < 2){
    const h = document.getElementById('rzaHelp');
    if(h) h.style.display = '';
    if(inp) inp.focus();
    return;
  }

  // Stocke RZA dans l'onglet courant
  if(currentTabId){
    const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
    data.RZA = v;
    localStorage.setItem('tab-'+currentTabId, JSON.stringify(data));
  }

  closeRZAModal(true);
}

// Enter/Escape
document.addEventListener('keydown', (e)=>{
  const modal = document.getElementById('rzaModal');
  if(!modal || modal.style.display === 'none') return;

  if(e.key === 'Escape') closeRZAModal(false);
  if(e.key === 'Enter') submitRZAModal();
});

/* validateForm */
function validateForm() {
  const val = id => (document.getElementById(id)?.value || "");

  const dateRaw = val("Date");
  const [yyyy, mm, dd] = (dateRaw || "").split("-");
  const dateTitre = (yyyy && mm && dd) ? `${dd}-${mm}-${yyyy}` : "";

  const cie = val("Cie");
  const vol = val("NVol");
  const from = val("From");
  const to = val("To");
  const immat = val("Immat");
  const typeAvion = val("TypeAvion");

  // ‚úÖ RZA : plus dans INFO VOL -> on le prend du storage de l'onglet
  let rza = '';
  try{
    if(currentTabId){
      const data = JSON.parse(localStorage.getItem('tab-'+currentTabId) || '{}');
      rza = (data.RZA || '').toUpperCase().trim();
    }
  }catch(e){}

  // si pas de RZA -> on ouvre le popup et on stoppe l'envoi
  if(!rza){
    openRZAModal();
    return;
  }

  const titre = `[TIMING] ${dateTitre} / ${cie}${vol} ${from}-${to} / ${immat} / ${rza}`;

  const liftArrivee = `${val("ArriveeLiftArr")} - ${val("DepartLiftArr")}`;
  const liftDepart  = `${val("ArriveeLift")} - ${val("DepartLift")}`;

  // DL block
  const dlLines = [];
  if (val("DLcode1")) dlLines.push(`DL (${val("DLcode1")}) : ${val("DLduree1")} min`);
  if (val("DLcode2")) dlLines.push(`DL (${val("DLcode2")}) : ${val("DLduree2")} min`);
  if (val("DLcode3")) dlLines.push(`DL (${val("DLcode3")}) : ${val("DLduree3")} min`);
  const dlBlock = dlLines.length ? `\n== DL ==\n\n${dlLines.join("\n")}\n` : "";

  // Faits saillants
  const faitsTxt = (val("FaitsSaillants") || "").trim();
  const faitsBlock = faitsTxt ? `\n== FAITS SAILLANTS ==\n\n${faitsTxt}\n` : "";

  // LOAD blocks (POIDS + H1..H4 + SI)
  const loadArrBlock =
`== LOAD ARR ==
PAX : ${val("LoadPAX")}
BAGS : ${val("LoadBAGS")}
POIDS : ${val("LoadPOIDS")}
H1 : ${val("LoadH1")} / H2 : ${val("LoadH2")} / H3 : ${val("LoadH3")} / H4 : ${val("LoadH4")}
SI : ${val("LoadSI")}`;

  const loadExpBlock =
`== LOAD EXP ==
PAX : ${val("ExpPAX")}
BAGS : ${val("ExpBAGS")}
POIDS : ${val("ExpPOIDS")}
H1 : ${val("ExpH1")} / H2 : ${val("ExpH2")} / H3 : ${val("ExpH3")} / H4 : ${val("ExpH4")}
SI : ${val("ExpSI")}`;

  // FINAL : passagers + zones + bagages/poids + H1..H4 + SI
  const loadFinalBlock =
`== LOAD FINAL ==
MALE : ${val("FinalMALE")}
FEMALE : ${val("FinalFEMALE")}
ADULT : ${val("FinalADULT")}
CHILD : ${val("FinalCHILD")}
INFANT : ${val("FinalINFANT")}
TOB : ${val("FinalTOB")}
OA : ${val("FinalOA")} / OB : ${val("FinalOB")} / OC : ${val("FinalOC")} / OD : ${val("FinalOD")}
BAGS : ${val("FinalBAGS")} / POIDS : ${val("FinalPOIDS")} / GB : ${val("FinalGB")}
H1 : ${val("FinalH1")} / H2 : ${val("FinalH2")} / H3 : ${val("FinalH3")} / H4 : ${val("FinalH4")}
SI : ${val("FinalSI")}`;

  const body =
`Vol : ${cie}${vol}
Date : ${dateTitre}
Rotation : ${from} - ${to}
Immat : ${immat}
Type avion : ${typeAvion}
RZA : ${rza}

== HORAIRES ==

SIBT : ${val("SIBT")}
AIBT : ${val("AIBT")}
-
SOBT : ${val("SOBT")}
AOBT : ${val("AOBT")}
CTOT : ${val("CTOT")}

== TIMINGS ==

Arriv√©e PNT : ${val("ArrPNT")}
Arriv√©e PNC : ${val("ArrPNC")}

Premier d√©barqu√© : ${val("PremierDebarque")}
Dernier d√©barqu√© : ${val("DernierDebarque")}

Premier embarqu√© : ${val("AvionPremierEmbarque")}
Dernier embarqu√© : ${val("AvionDernierEmbarque")}

Arriv√©e fuel : ${val("ArriveeFuel")}
D√©part fuel : ${val("DepartFuel")}

Arriv√©e INAD : ${val("ArriveeINAD")}

Lift arriv√©e : ${liftArrivee}
Lift d√©part  : ${liftDepart}

Remise LID/LDS : ${val("RemiseLID")}
Fermeture porte avion : ${val("FermeturePorteAvion")}

${loadArrBlock}

${loadExpBlock}

${loadFinalBlock}

${[dlBlock, faitsBlock].filter(Boolean).join("\n")}`;

  window.location.href =
    `mailto:trafic@aeroportbeauvais.com?subject=${encodeURIComponent(titre)}&body=${encodeURIComponent(body)}`;
}

function manualSave() {
  saveCurrentTabData();
  showPopup("Enregistrement r√©ussi", "#2563eb", 2000);
}

function clearAutoSave() {
  if (confirm("Tout r√©initialiser ?")) {
    localStorage.clear();
    location.reload();
  }
}
</script>

<!-- ===== Airport Keeper Picker ===== -->
<div id="akBackdrop" onclick="closeAKPicker()"></div>

<div id="akPopover">
  <div class="ak-header" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
    <div class="select">
      <select id="akFlow" onchange="loadAKFlights()">
        <option value="DEP" selected>DEP</option>
        <option value="ARR">ARR</option>
      </select>
    </div>

    <button class="button is-small is-link" type="button" onclick="loadAKFlights()">
      Rafra√Æchir
    </button>

    <span class="tag is-light" id="akStatus">‚Äî</span>

    <button class="button is-small is-light" type="button"
            style="margin-left:auto"
            onclick="closeAKPicker()">
      Fermer
    </button>
  </div>

  <div id="akList"></div>
</div>

<!-- ===== SETTINGS MENU (bottom gear) ===== -->
<div id="settingsBackdrop" onclick="closeSettingsMenu()"></div>

<button id="settingsFab" class="button is-link" type="button" onclick="toggleSettingsMenu()" aria-label="Param√®tres">
  ‚öôÔ∏è
</button>

<div id="settingsMenu" role="dialog" aria-modal="true">
  <div class="settings-title">Param√®tres</div>

  <div class="settings-row">
    <label class="toggle" style="justify-content:space-between;">
      <span id="darkLabel">Clair</span>
      <input id="darkToggle" type="checkbox" onchange="setDarkMode(this.checked)">
      <span class="track"><span class="thumb"></span></span>
    </label>

    <label class="toggle" style="justify-content:space-between;">
      <span id="tzLabel">Locale</span>
      <input id="utcToggle" type="checkbox" onchange="setTimeModeUTC(this.checked)">
      <span class="track"><span class="thumb"></span></span>
    </label>

    <button class="button is-small is-light" type="button" onclick="closeSettingsMenu()">Fermer</button>
  </div>
</div>


</body>
</html>
